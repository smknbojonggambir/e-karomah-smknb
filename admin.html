<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard & Certificate - E-KAROMAH</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
/* --- 1. CORE THEME --- */
:root {
  --primary: #10b981; /* Emerald */
  --accent: #f59e0b;  /* Gold */
  --bg-dark: #0f172a;
  --bg-gradient: linear-gradient(135deg, #064e3b 0%, #022c22 100%);
  --glass: rgba(15, 23, 42, 0.6);
  --glass-border: rgba(255, 255, 255, 0.1);
  --text: #ecfdf5;
  --text-muted: #94a3b8;
}

body {
  margin: 0;
  font-family: 'Poppins', sans-serif;
  background: var(--bg-gradient);
  color: var(--text);
  min-height: 100vh;
  padding: 20px;
  background-attachment: fixed;
}

/* --- 2. LAYOUT & CONTAINER --- */
.container {
  max-width: 1200px;
  margin: auto;
  background: var(--glass);
  backdrop-filter: blur(12px);
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 50px rgba(0,0,0,0.3);
}

/* --- 3. HEADER & TABS --- */
header {
  padding: 20px;
  border-bottom: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  background: rgba(0,0,0,0.2);
}

.brand h2 { margin: 0; color: var(--accent); display: flex; align-items: center; gap: 10px; }
.brand small { color: var(--primary); letter-spacing: 1px; font-size: 12px; }

.nav-tabs { display: flex; gap: 10px; margin-top: 10px; }
.nav-btn {
  background: transparent;
  border: 1px solid var(--glass-border);
  color: var(--text-muted);
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  transition: 0.3s;
  font-size: 13px;
}
.nav-btn.active {
  background: var(--primary);
  color: #000;
  font-weight: 600;
  border-color: var(--primary);
  box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
}

.action-btn {
  background: var(--accent);
  color: #000;
  border: none;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 12px;
}
.btn-danger { background: #ef4444; color: white; }

/* --- 4. CONTENT SECTIONS --- */
.tab-content { display: none; padding: 20px; animation: fadeIn 0.4s; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* --- 5. TABLE STYLES (TAB 1) --- */
.search-box {
  width: 100%;
  padding: 12px;
  background: rgba(0,0,0,0.3);
  border: 1px solid var(--glass-border);
  border-radius: 8px;
  color: white;
  margin-bottom: 15px;
  box-sizing: border-box;
}
.table-wrapper { overflow-x: auto; border-radius: 8px; border: 1px solid var(--glass-border); }
table { width: 100%; border-collapse: collapse; min-width: 800px; }
th { background: rgba(16, 185, 129, 0.1); color: var(--accent); padding: 12px; text-align: left; }
td { padding: 12px; border-bottom: 1px solid var(--glass-border); font-size: 13px; }
tr:hover td { background: rgba(255,255,255,0.05); cursor: pointer; }

/* Badge Status */
.badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }
.hadir { background: rgba(16, 185, 129, 0.2); color: #34d399; }
.izin { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
.sakit { background: rgba(239, 68, 68, 0.2); color: #f87171; }

/* --- 6. CERTIFICATE STYLES (TAB 2) --- */
.cert-grid {
  display: grid;
  grid-template-columns: 320px 1fr;
  gap: 20px;
}

.cert-controls {
  background: rgba(0,0,0,0.2);
  padding: 20px;
  border-radius: 12px;
}

.cert-controls label {
  display: block;
  font-size: 12px;
  color: var(--accent);
  margin-top: 10px;
  margin-bottom: 4px;
}

.cert-controls input, 
.cert-controls select, 
.cert-controls textarea {
  width: 100%;
  background: var(--bg-dark);
  border: 1px solid var(--glass-border);
  color: white;
  padding: 8px;
  border-radius: 4px;
  box-sizing: border-box;
  font-family: inherit;
}

.cert-preview {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}

canvas {
  max-width: 100%;
  border: 4px solid var(--accent);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

/* Mobile Responsive */
@media (max-width: 900px) {
  .cert-grid { grid-template-columns: 1fr; }
  .header-actions { width: 100%; display: flex; justify-content: space-between; margin-top: 10px; }
}
</style>
</head>
<body>

<div class="container">
  
  <header>
    <div class="brand">
      <h2>üåô E-KAROMAH <span style="font-size:14px; background:var(--primary); color:#000; padding:2px 8px; border-radius:4px;">ADMIN</span></h2>
      <small>Ramadhan Activity Monitor & Generator</small>
    </div>
    
    <div style="flex-grow:1; display:flex; justify-content:center;">
      <div class="nav-tabs">
        <button class="nav-btn active" onclick="switchTab('tab-data')">üìä Data Laporan</button>
        <button class="nav-btn" onclick="switchTab('tab-cert')">üèÜ Cetak Sertifikat</button>
      </div>
    </div>

    <div class="header-actions">
      <button class="action-btn btn-danger" onclick="logout()">Logout</button>
    </div>
  </header>

  <div id="tab-data" class="tab-content active">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <h3 style="margin:0; color:var(--text-muted);">Rekapitulasi Kehadiran</h3>
        <button class="action-btn" onclick="loadData()">üîÑ Refresh Data</button>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="üîç Cari nama siswa, kelompok, atau kegiatan..." onkeyup="filterTable()">
    
    <div id="loader" style="text-align:center; padding:20px; display:none;">
        <div style="font-size:24px;">‚è≥</div> Memuat data...
    </div>

    <div class="table-wrapper">
      <table id="tabel-laporan">
        <thead>
          <tr>
            <th>Tanggal</th>
            <th>Nama Siswa</th>
            <th>Kelompok</th>
            <th>Status</th>
            <th>Kegiatan</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          </tbody>
      </table>
    </div>
    <p style="font-size:11px; color:var(--text-muted); margin-top:10px;">*Klik tombol "Buat Sertifikat" pada tabel untuk menyalin nama ke generator.</p>
  </div>

  <div id="tab-cert" class="tab-content">
    <div class="cert-grid">
      
      <div class="cert-controls">
        <h3 style="margin-top:0; color:white;">üéõÔ∏è Konfigurasi</h3>
        
        <label>Tipe Sertifikat</label>
        <select id="certType" onchange="changeCertMode()">
            <option value="siswa">üéì Peserta (Siswa)</option>
            <option value="kelompok">üèÜ Kelompok Terbaik</option>
            <option value="pembimbing">üëî Pembimbing</option>
        </select>

        <label id="labelRecipient">Nama Penerima</label>
        <input type="text" id="certName" placeholder="Nama..." oninput="drawCertificate()">

        <label>Judul / Predikat</label>
        <input type="text" id="certTitle" value="SANTRI TELADAN" oninput="drawCertificate()">

        <label>Deskripsi</label>
        <textarea id="certDesc" rows="3" oninput="drawCertificate()">Atas dedikasinya dalam mengikuti kegiatan Ramadhan dengan penuh semangat dan berakhlak mulia.</textarea>
        
        <div style="border-top:1px dashed #334155; margin-top:15px; padding-top:10px;">
            <label>Tanda Tangan Kiri (Ketua)</label>
            <input type="text" id="signer1Name" value="Ahmad Zubair, S.Pd." oninput="drawCertificate()">
            <input type="file" onchange="handleImageUpload(this, 'sign1')" style="font-size:10px; margin-top:5px;">
            
            <label>Tanda Tangan Kanan (Kepala)</label>
            <input type="text" id="signer2Name" value="Drs. H. Mulyadi" oninput="drawCertificate()">
            <input type="file" onchange="handleImageUpload(this, 'sign2')" style="font-size:10px; margin-top:5px;">
        </div>

        <button class="action-btn" style="width:100%; margin-top:20px; padding:12px;" onclick="downloadCertificate()">‚¨áÔ∏è Download JPG</button>
      </div>

      <div class="cert-preview">
        <canvas id="certCanvas" width="800" height="600"></canvas>
      </div>

    </div>
  </div>

</div>

<script>
// ==========================================
// 1. CONFIG & DATA LOAD LOGIC
// ==========================================
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxoY-pOhMN5zRptRwO8GQjOIGPyN6YL6uZywUCs3QL8aWDNyAHugqgLTcee_z4jcRZZEw/exec"; 

// Cek Login (Sederhana)
let user = null;
try { user = JSON.parse(localStorage.getItem("user")); } catch(e){}
// Note: Uncomment baris di bawah untuk proteksi ketat
// if(!user || user.role !== "admin") { alert("Akses Ditolak"); location.href = "index.html"; }

function switchTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
    
    document.getElementById(tabId).classList.add('active');
    
    // Highlight button
    if(tabId === 'tab-data') document.querySelectorAll('.nav-btn')[0].classList.add('active');
    if(tabId === 'tab-cert') document.querySelectorAll('.nav-btn')[1].classList.add('active');
}

async function loadData(){
    const tb = document.querySelector("#tabel-laporan tbody");
    const loader = document.getElementById("loader");
    
    loader.style.display = "block";
    tb.innerHTML = ""; // Clear

    try{
        // Simulasi Fetch (Ganti dengan fetch asli Anda)
        // const response = await fetch(WEB_APP_URL + "?action=rekapAdmin");
        // const data = await response.json();
        
        // --- DUMMY DATA UNTUK DEMO (Hapus ini jika pakai URL asli) ---
        const data = [
            {tanggal: "2025-03-12", nama: "Muhammad Fulan", kelompok: "Abu Bakar", hadir: "Hadir", kegiatan: "Tadarus Juz 30"},
            {tanggal: "2025-03-12", nama: "Aisyah Humaira", kelompok: "Khadijah", hadir: "Sakit", kegiatan: "-"},
            {tanggal: "2025-03-13", nama: "Umar Al-Faruq", kelompok: "Umar", hadir: "Hadir", kegiatan: "Kultum Subuh"},
        ];
        // -------------------------------------------------------------

        if(!data || data.length === 0){
            tb.innerHTML = `<tr><td colspan="6" style="text-align:center;">Belum ada data.</td></tr>`;
        } else {
            data.forEach(x => {
                let statusClass = "hadir";
                let textHadir = x.hadir || "Hadir";
                if(textHadir.toLowerCase().includes("sakit")) statusClass = "sakit";
                if(textHadir.toLowerCase().includes("izin")) statusClass = "izin";

                tb.innerHTML += `
                <tr>
                    <td>${x.tanggal}</td>
                    <td style="font-weight:bold; color:#fff;">${x.nama}</td>
                    <td>${x.kelompok}</td>
                    <td><span class="badge ${statusClass}">${textHadir}</span></td>
                    <td>${x.kegiatan || "-"}</td>
                    <td>
                        <button class="action-btn" style="font-size:10px; padding:4px 8px;" onclick="sendToCert('${x.nama}')">
                           üéì Buat Sertifikat
                        </button>
                    </td>
                </tr>`;
            });
        }
    } catch(e){
        console.error(e);
        alert("Gagal memuat data.");
    } finally {
        loader.style.display = "none";
    }
}

// Fungsi Filter Tabel
function filterTable() {
  const input = document.getElementById("searchInput");
  const filter = input.value.toUpperCase();
  const table = document.getElementById("tabel-laporan");
  const tr = table.getElementsByTagName("tr");

  for (let i = 1; i < tr.length; i++) {
    let textContent = tr[i].textContent || tr[i].innerText;
    if (textContent.toUpperCase().indexOf(filter) > -1) {
      tr[i].style.display = "";
    } else {
      tr[i].style.display = "none";
    }
  }
}

// Fungsi Integrasi: Kirim Nama dari Tabel ke Generator
function sendToCert(nama) {
    document.getElementById('certName').value = nama;
    switchTab('tab-cert'); // Pindah tab
    drawCertificate(); // Gambar ulang
}

function logout(){
    if(confirm("Keluar dari sistem?")){
        localStorage.removeItem("user");
        location.reload(); // atau redirect
    }
}

// ==========================================
// 2. CERTIFICATE GENERATOR LOGIC
// ==========================================
let imgSign1 = null;
let imgSign2 = null;

const certConfigs = {
    siswa: { label: "Nama Siswa", intro: "Diberikan kepada:", title: "SANTRI TELADAN", desc: "Atas dedikasinya dalam mengikuti kegiatan Ramadhan dengan penuh semangat." },
    kelompok: { label: "Nama Kelompok", intro: "Dianugerahkan kepada Tim:", title: "KELOMPOK TERBAIK", desc: "Atas kekompakan dan kerjasama tim dalam menyelesaikan misi Ramadhan." },
    pembimbing: { label: "Nama Pembimbing", intro: "Apresiasi kepada:", title: "PEMBIMBING TELADAN", desc: "Atas kesabaran dan ilmunya dalam membimbing santri." }
};

function changeCertMode() {
    const type = document.getElementById("certType").value;
    const config = certConfigs[type];
    document.getElementById("labelRecipient").textContent = config.label;
    document.getElementById("certTitle").value = config.title;
    document.getElementById("certDesc").value = config.desc;
    drawCertificate();
}

function handleImageUpload(input, type) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                if(type === 'sign1') imgSign1 = img;
                if(type === 'sign2') imgSign2 = img;
                drawCertificate();
            }
            img.src = e.target.result;
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function drawCertificate() {
    const canvas = document.getElementById('certCanvas');
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;

    // Data
    const type = document.getElementById("certType").value;
    const name = document.getElementById('certName').value || "NAMA PENERIMA";
    const title = document.getElementById('certTitle').value;
    const desc = document.getElementById('certDesc').value;
    const signer1 = document.getElementById('signer1Name').value;
    const signer2 = document.getElementById('signer2Name').value;

    // Background
    const grd = ctx.createLinearGradient(0, 0, 0, h);
    grd.addColorStop(0, "#0f172a");
    grd.addColorStop(1, "#1e293b");
    ctx.fillStyle = grd;
    ctx.fillRect(0, 0, w, h);

    // Frame Gold
    ctx.lineWidth = 10;
    ctx.strokeStyle = "#fbbf24";
    ctx.strokeRect(15, 15, w-30, h-30);
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(255,255,255,0.2)";
    ctx.strokeRect(25, 25, w-50, h-50);

    // Header
    ctx.textAlign = "center";
    ctx.fillStyle = "#10b981";
    ctx.font = "bold 18px Poppins";
    ctx.fillText("PANITIA RAMADHAN 1446 H", w/2, 80);

    // Title
    ctx.fillStyle = "#fbbf24";
    ctx.font = "bold 48px 'Playfair Display', serif";
    ctx.fillText(title, w/2, 140);
    
    // Line
    ctx.beginPath();
    ctx.moveTo(w/2 - 100, 155);
    ctx.lineTo(w/2 + 100, 155);
    ctx.lineWidth = 2;
    ctx.stroke();

    // Recipient
    ctx.fillStyle = "#94a3b8";
    ctx.font = "italic 16px Poppins";
    ctx.fillText(certConfigs[type].intro, w/2, 200);

    ctx.fillStyle = "#fff";
    ctx.font = "bold 42px Poppins";
    ctx.shadowColor = "rgba(16,185,129,0.5)";
    ctx.shadowBlur = 15;
    ctx.fillText(name, w/2, 260);
    ctx.shadowBlur = 0;

    // Desc
    ctx.fillStyle = "#cbd5e1";
    ctx.font = "14px Poppins";
    wrapText(ctx, desc, w/2, 310, 600, 20);

    // Footer / Signatures
    const fy = h - 120;
    const lx = 200;
    const rx = w - 200;

    ctx.fillStyle = "#fff";
    ctx.font = "12px Poppins";
    
    // Left Signer
    ctx.fillText("Mengetahui,", lx, fy);
    ctx.fillText("Ketua Pelaksana", lx, fy + 15);
    if(imgSign1) ctx.drawImage(imgSign1, lx-40, fy+20, 80, 50);
    ctx.fillStyle = "#fbbf24";
    ctx.font = "bold 12px Poppins";
    ctx.fillText(`( ${signer1} )`, lx, fy+90);

    // Right Signer
    ctx.fillStyle = "#fff";
    ctx.fillText(`Jakarta, ${new Date().toLocaleDateString('id-ID')}`, rx, fy);
    ctx.fillText("Kepala Sekolah", rx, fy + 15);
    if(imgSign2) ctx.drawImage(imgSign2, rx-40, fy+20, 80, 50);
    ctx.fillStyle = "#fbbf24";
    ctx.font = "bold 12px Poppins";
    ctx.fillText(`( ${signer2} )`, rx, fy+90);
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
    const words = text.split(' ');
    let line = '';
    for(let n = 0; n < words.length; n++) {
        const testLine = line + words[n] + ' ';
        const metrics = ctx.measureText(testLine);
        if (metrics.width > maxWidth && n > 0) {
            ctx.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
        } else {
            line = testLine;
        }
    }
    ctx.fillText(line, x, y);
}

function downloadCertificate() {
    const canvas = document.getElementById('certCanvas');
    const link = document.createElement('a');
    link.download = `Sertifikat-${document.getElementById('certName').value}.jpg`;
    link.href = canvas.toDataURL("image/jpeg", 0.9);
    link.click();
}

// Initial Load
window.onload = function() {
    loadData();
    drawCertificate();
};
</script>

</body>
</html>
