<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ramadan</title>

<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#0f172a;
  color:#fff;
}

.container{
  padding:30px;
  max-width:1300px;
  margin:auto;
}

h1{
  margin-bottom:20px;
  color:#facc15;
}

.btn{
  padding:10px 14px;
  border-radius:8px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

.btn-gold{
  background:#facc15;
  color:#000;
}

.stat-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:25px;
}

.stat-card{
  padding:20px;
  border-radius:14px;
  box-shadow:0 6px 18px rgba(0,0,0,0.4);
}

.stat-green{background:#064e3b;}
.stat-gold{background:#854d0e;}
.stat-blue{background:#1e3a8a;}

.stat-label{
  font-size:14px;
  opacity:0.8;
}

.stat-value{
  font-size:26px;
  font-weight:bold;
  margin-top:8px;
}

.grid-2{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:20px;
}

.card{
  background:#1e293b;
  padding:20px;
  border-radius:14px;
}

ul{
  list-style:none;
  padding:0;
}

li{
  display:flex;
  justify-content:space-between;
  margin-bottom:10px;
}

.badge-green{
  background:#16a34a;
  padding:5px 10px;
  border-radius:8px;
  font-size:12px;
}

input,select{
  background:#1e293b;
  color:#fff;
  border:1px solid #334155;
}

#loading-indicator{
  display:none;
  margin-bottom:15px;
}
</style>
</head>

<body>

<div class="container">

<h1><i class='bx bx-moon'></i> Dashboard Ramadan Ultimate</h1>

<div id="loading-indicator">
  <i class='bx bx-loader bx-spin'></i> Memuat data...
</div>

<!-- FILTER -->
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:18px;">
  <input type="date" id="filter-start" class="btn">
  <input type="date" id="filter-end" class="btn">
  <select id="filter-kelompok" class="btn btn-gold">
    <option value="">Semua Kelompok</option>
  </select>
  <button class="btn" onclick="fetchLaporanData()">
    <i class='bx bx-filter'></i> Terapkan Filter
  </button>
</div>

<!-- STAT -->
<div class="stat-grid" id="dashboard-stats"></div>

<div class="grid-2">

  <div class="card">
    <h3>Top 5 Siswa Ramadan</h3>
    <ul id="ranking-top-siswa"></ul>
  </div>

  <div class="card">
    <h3>Chart Aktivitas</h3>
    <canvas id="chartDoughnut"></canvas>
  </div>

</div>

</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz9YCqyJTYQkOfljm1Pbqxy7QoCw9apkHBhDYRVwjRHcihPDN1hn5vpyxkoJ9HqkFCv5g/exec";

let chartDoughnut;
let autoRefreshInterval;

function getField(obj, ...keys){
  for(const k of keys){
    if(obj[k] !== undefined) return obj[k];
  }
  return "";
}

function animateCounter(el,target){
  if(!el) return;
  let start=0;
  const step=Math.max(1,Math.floor(target/30));
  const interval=setInterval(()=>{
    start+=step;
    if(start>=target){
      el.innerText=target;
      clearInterval(interval);
    }else{
      el.innerText=start;
    }
  },20);
}

function hitungAktivitas(item){
  const aktivitas=[
    "Sahur_Status","Subuh_Status","Olahraga_Status","Keluarga_Status",
    "Dzuhur_Status","Pesantren_Status","Ashar_Status","Aksi_Status",
    "Buka_Status","Magrib_Status","Isya_Status",
    "Tarawih_Status","Tadarus_Status","Tidur_Status"
  ];
  let total=0;
  aktivitas.forEach(k=>{
    if(item[k] && item[k].toString().toLowerCase().includes("valid")){
      total++;
    }
  });
  return total;
}

async function fetchLaporanData(){

  const loading=document.getElementById("loading-indicator");
  if(loading) loading.style.display='block';

  try{

    const res=await fetch(SCRIPT_URL+"?action=getAll");
    const raw=await res.json();

    let dataList=[];

    if(Array.isArray(raw)){
      dataList=raw;
    }else if(raw.data){
      dataList=raw.data;
    }else if(raw.result){
      dataList=raw.result;
    }

    if(!Array.isArray(dataList) || dataList.length===0){
      document.getElementById("dashboard-stats").innerHTML="<p>Tidak ada data ditemukan.</p>";
      return;
    }

    const siswaMap={};
    const kelompokSet=new Set();
    let totalPoinGlobal=0;

    dataList.forEach(item=>{

      const nama=getField(item,"nama","Nama");
      const kelompok=getField(item,"kelompok","Kelompok");

      if(kelompok) kelompokSet.add(kelompok);

      const aktivitas=hitungAktivitas(item);
      const poin=aktivitas*10;

      totalPoinGlobal+=poin;

      if(!siswaMap[nama]){
        siswaMap[nama]={
          nama,
          kelompok,
          total_poin:0,
          total_laporan:0
        };
      }

      siswaMap[nama].total_poin+=poin;
      siswaMap[nama].total_laporan++;
    });

    const siswaList=Object.values(siswaMap);

    // ================= STAT =================
    document.getElementById("dashboard-stats").innerHTML=`
      <div class="stat-card stat-green">
        <div class="stat-label">Total Siswa Aktif</div>
        <div class="stat-value" id="counter-siswa">0</div>
      </div>
      <div class="stat-card stat-gold">
        <div class="stat-label">Total Laporan</div>
        <div class="stat-value" id="counter-laporan">0</div>
      </div>
      <div class="stat-card stat-blue">
        <div class="stat-label">Total Poin Ramadan</div>
        <div class="stat-value" id="counter-poin">0</div>
      </div>
    `;

    animateCounter(document.getElementById("counter-siswa"),siswaList.length);
    animateCounter(document.getElementById("counter-laporan"),dataList.length);
    animateCounter(document.getElementById("counter-poin"),totalPoinGlobal);

    // ================= DROPDOWN KELOMPOK =================
    const dropdown=document.getElementById("filter-kelompok");
    if(dropdown){
      dropdown.innerHTML="<option value=''>Semua Kelompok</option>";
      kelompokSet.forEach(k=>{
        dropdown.innerHTML+=`<option value="${k}">${k}</option>`;
      });
    }

    // ================= LEADERBOARD =================
    const leaderboard=siswaList
      .sort((a,b)=>b.total_poin-a.total_poin)
      .slice(0,5);

    document.getElementById("ranking-top-siswa").innerHTML=
      leaderboard.map((s,i)=>`
        <li>
          ${i+1}. ${s.nama}
          <span class="badge-green">${s.total_poin} poin</span>
        </li>
      `).join("");

    // ================= CHART =================
    if(chartDoughnut) chartDoughnut.destroy();
    chartDoughnut=new Chart(document.getElementById("chartDoughnut"),{
      type:'doughnut',
      data:{
        labels:["Total Poin Ramadan"],
        datasets:[{
          data:[totalPoinGlobal],
          backgroundColor:["#facc15"]
        }]
      }
    });

    // ================= AUTO REFRESH =================
    if(autoRefreshInterval) clearInterval(autoRefreshInterval);
    autoRefreshInterval=setInterval(fetchLaporanData,30000);

  }catch(err){
    console.error("ERROR:",err);
    document.getElementById("dashboard-stats").innerHTML="<p>Gagal mengambil data.</p>";
  }finally{
    if(loading) loading.style.display='none';
  }
}

document.addEventListener("DOMContentLoaded",fetchLaporanData);
</script>

</body>
</html>
