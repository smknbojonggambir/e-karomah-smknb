<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - E-KAROMAH</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { 
            --primary: #10b981; 
            --primary-dark: #059669;
            --gold: #fbbf24; 
            --bg: #0f172a; 
            --card: #1e293b; 
            --text: #f1f5f9; 
            --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.1); 
            --danger: #ef4444;
        }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); }
        
        .layout { display: grid; grid-template-columns: 260px 1fr; min-height: 100vh; }
        
        /* SIDEBAR */
        aside { 
            background: #020617; 
            padding: 20px; 
            border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; justify-content: space-between;
            position: sticky; top: 0; height: 100vh; box-sizing: border-box;
        }
        .brand { font-size: 22px; font-weight: 700; color: var(--gold); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-group { display: flex; flex-direction: column; gap: 5px; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: var(--text-muted); margin: 15px 0 5px 10px; letter-spacing: 1px; font-weight: 600; }
        .nav-item { padding: 12px 15px; color: var(--text-muted); border-radius: 8px; cursor: pointer; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .nav-item.active { background: rgba(16, 185, 129, 0.15); color: var(--primary); font-weight: 600; }
        .btn-logout { padding: 12px; color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; cursor: pointer; text-align: center; transition: 0.3s; font-weight: 600; margin-top: 10px; }
        .btn-logout:hover { background: var(--danger); color: white; border-color: var(--danger); }
        
        /* BUTTONS & COMPONENTS */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); color: #fff; }
        .btn-gold { background: var(--gold); color: #000; }
        
        main { padding: 30px 30px 60px 30px; /* Padding bawah ditambah agar tidak tertutup footer */ height: 100vh; overflow-y: auto; box-sizing: border-box; position: relative; }
        h1 { margin-top: 0; margin-bottom: 20px; font-weight: 600; font-size: 24px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .page { display: none; animation: fadeIn 0.4s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Group Card Styles */
        .group-card { background: #1e293b; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 30px; overflow: hidden; }
        .group-header { background: rgba(16, 185, 129, 0.1); padding: 15px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .group-title { font-size: 16px; font-weight: 700; color: var(--primary); }
        .group-pembimbing { font-size: 13px; color: var(--text-muted); }
        .group-body { padding: 20px; }
        .admin-note-area { width: 100%; background: #0f172a; border: 1px solid var(--border); color: var(--text); padding: 15px; border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 13px; resize: vertical; min-height: 80px; margin-top: 15px; }
        
        /* Table Styles */
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; min-width: 600px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); font-size: 14px; }
        th { color: var(--text-muted); background: rgba(0,0,0,0.2); text-transform: uppercase; font-size: 12px; letter-spacing: 1px; font-weight: 600; }
        tr:hover { background: rgba(255,255,255,0.02); }
        td { color: #e2e8f0; }
        .score-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-weight: 600; font-size: 12px; width: 30px; text-align: center; }
        .score-high { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .score-mid { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .score-none { background: rgba(255,255,255,0.1); color: #94a3b8; }

        /* --- FOOTER FIXED STYLE --- */
        .footer-fixed {
            position: fixed;
            bottom: 0;
            right: 0;
            width: calc(100% - 260px); /* Sesuai lebar layout grid */
            background: #020617;
            border-top: 1px solid var(--border);
            padding: 12px 0;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            z-index: 50;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.2);
        }
        .footer-fixed a { color: var(--gold); text-decoration: none; font-weight: 600; transition: 0.3s; }
        .footer-fixed a:hover { color: var(--primary); }

        /* Sertifikat Style */
        #certificate-preview { display: none; width: 800px; height: 600px; padding: 40px; background: #fff; color: #1e293b; text-align: center; border: 20px solid var(--gold); position: relative; margin: 20px auto; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .cert-header { display: flex; justify-content: center; margin-bottom: 20px; }
        .cert-logo { width: 80px; height: 80px; object-fit: contain; }
        .cert-title { font-family: 'Playfair Display', serif; font-size: 48px; color: #b45309; margin-bottom: 5px; margin-top: 10px;}
        .cert-subtitle { font-size: 18px; margin-bottom: 30px; color: #555; }
        .cert-name { font-family: 'Playfair Display', serif; font-size: 38px; font-weight: bold; border-bottom: 2px solid #ddd; display: inline-block; padding: 0 40px 10px; margin-bottom: 20px; color: #000; }
        .cert-body { font-size: 16px; line-height: 1.6; margin-bottom: 30px; color: #333; }
        .cert-data-table { margin: 0 auto 30px auto; border-collapse: collapse; width: 70%; }
        .cert-data-table td { border-bottom: 1px solid #eee; padding: 8px; color: #333; font-size: 15px; }
        .cert-data-table td:first-child { font-weight: 600; text-align: left; width: 60%; }
        .cert-data-table td:last-child { text-align: center; font-family: 'Courier New', monospace; font-weight: bold; }
        .cert-footer { display: flex; justify-content: space-around; margin-top: 40px; }
        .sign-box { text-align: center; }
        .sign-line { width: 200px; border-top: 1px solid #333; margin: 60px auto 10px; }

        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 20px; background: white; color: black; border: none; }
            #certificate-preview { display: block !important; margin: 0; page-break-after: always; width: 100%; height: auto; transform: scale(1); }
            table th { color: #000; border-bottom: 1px solid #000; }
            table td { color: #000; border-bottom: 1px solid #ccc; }
            .card { border: none; box-shadow: none; padding: 0; color: black; }
            .footer-fixed { display: none; } /* Sembunyikan footer saat print */
        }
        @media (max-width: 768px) {
            .layout { grid-template-columns: 1fr; }
            aside { display: none; }
            .footer-fixed { width: 100%; }
        }
    </style>
</head>
<body>

    <div class="layout">
        <aside>
            <div class="nav-group">
                <div class="brand">üåô E-KAROMAH</div>
                <div class="nav-label">Main Menu</div>
                <div class="nav-item active" onclick="showPage('dash', this)">üìä Dashboard</div>
                <div class="nav-item" onclick="showPage('siswa', this)">üë• Data Siswa</div>
                <div class="nav-item" onclick="showPage('guru', this)">üëî Pembimbing</div>
                <div class="nav-label">Administrasi</div>
                <div class="nav-item" onclick="showPage('nilai', this)">üìù Penilaian</div>
                <div class="nav-item" onclick="showPage('laporan', this)">üñ®Ô∏è Cetak Laporan</div>
                <div class="nav-item" onclick="showPage('sertifikat', this)">üèÖ Cetak Sertifikat</div>
            </div>
            <div class="btn-logout" onclick="logout()">üö™ Logout</div>
        </aside>

        <main>
            <div id="page-dash" class="page active">
                <h1>Overview Dashboard</h1>
                <div class="card"><canvas id="myChart" height="80"></canvas></div>
            </div>

            <div id="page-siswa" class="page">
                <h1>Data Siswa</h1>
                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Username</th><th>Nama Lengkap</th><th>Kelompok</th></tr></thead>
                            <tbody id="listSiswa"><tr><td colspan="3">Memuat...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-guru" class="page">
                <h1>Data Pembimbing</h1>
                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead><tr><th>Username</th><th>Nama Lengkap</th><th>Kelompok</th></tr></thead>
                            <tbody id="listGuru"><tr><td colspan="3">Memuat...</td></tr></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="page-nilai" class="page">
                <h1>Monitoring Penilaian Pembimbing</h1>
                <p style="color:var(--text-muted); margin-bottom:25px;">Hasil penilaian dari pembimbing. Nilai akan muncul saat pembimbing mengisi form penilaian.</p>
                <div id="container-penilaian"><div style="text-align:center; padding:50px;">Memuat data penilaian...</div></div>
            </div>

            <div id="page-laporan" class="page">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h1>Rekapitulasi Laporan</h1>
                    <button class="btn btn-gold" onclick="printArea('laporan-print')">üñ®Ô∏è Cetak Laporan</button>
                </div>
                <div id="laporan-print" class="print-area card">
                    <div style="text-align:center; margin-bottom:20px; display:none;" class="print-header">
                        <h2>LAPORAN KEGIATAN RAMADHAN</h2><h3>SMK NEGERI BOJONGGAMBIR</h3>
                    </div>
                    <table>
                        <thead><tr><th>No</th><th>Nama Siswa</th><th>Kelompok</th><th>Total Kegiatan</th><th>Status</th></tr></thead>
                        <tbody id="listLaporan"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-sertifikat" class="page">
                <h1>Generator Sertifikat</h1>
                <div class="card">
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <select id="cert-type" style="padding:10px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border);">
                            <option value="Siswa">Sertifikat Peserta (Siswa)</option>
                            <option value="Pembimbing">Piagam Penghargaan (Pembimbing)</option>
                        </select>
                        <input type="text" id="cert-name-input" placeholder="Ketik Nama Penerima..." style="padding:10px; border-radius:6px; background:#0f172a; color:white; border:1px solid var(--border); width:250px;">
                        <button class="btn btn-primary" onclick="generateCertificate()">üëÅÔ∏è Preview</button>
                        <button class="btn btn-gold" onclick="printArea('certificate-preview')">üñ®Ô∏è Cetak</button>
                    </div>
                    <div id="certificate-preview" class="print-area">
                        <div class="cert-header">
                            <img src="https://via.placeholder.com/150x150.png?text=LOGO+SEKOLAH" alt="Logo Sekolah" class="cert-logo">
                        </div>
                        <div class="cert-title">SERTIFIKAT</div>
                        <div class="cert-subtitle" id="cert-sub">Diberikan Kepada:</div>
                        <div class="cert-name" id="cert-display-name">Nama Peserta</div>
                        <div class="cert-body">
                            Atas partisipasi aktif dalam kegiatan <strong>E-KAROMAH (Kegiatan Romadhon di Rumah)</strong><br>
                            SMK Negeri Bojonggambir Tahun 1446 H / 2025 M.<br>
                            Berdasarkan laporan kegiatan (Google Sheet Report), diperoleh hasil sebagai berikut:
                        </div>
                        <table class="cert-data-table">
                            <tr><td>Jumlah Laporan Harian</td><td id="cert-data-jumlah">-</td></tr>
                            <tr><td>Nilai Keaktifan & Ibadah</td><td id="cert-data-nilai">-</td></tr>
                            <tr><td>Predikat / Keterangan</td><td id="cert-data-predikat">-</td></tr>
                        </table>
                        <div class="cert-footer">
                            <div class="sign-box">Mengetahui,<br>Kepala Sekolah<div class="sign-line"></div><strong>H. NAMA KEPSEK, M.Pd.</strong></div>
                            <div class="sign-box">Tasikmalaya, April 2025<br>Ketua Panitia<div class="sign-line"></div><strong>NAMA KETUA, S.Pd.I</strong></div>
                        </div>
                    </div>
                    <p style="text-align:center; color:#94a3b8; font-size:12px; margin-top:10px;">*Klik Preview untuk melihat hasil, lalu klik Cetak. Data aktivitas belum tersedia.</p>
                </div>
            </div>
        </main>
    </div>

    <div class="footer-fixed">
        &copy; 2025 E-KAROMAH App. Developer <a href="https://www.kangruli.web.id/" target="_blank">Kang Ruli</a>
    </div>

    <script>
        // CONFIG
        const API = "https://script.google.com/macros/s/AKfycbwm29E1u9oMvRuc-Vxx5J6f5EgV1J-qklwIJG5XzAyGQBmavR0huq-Ho_dQ6QEaSdwmSg/exec";
        
        let globalData = { siswa: [], pembimbing: [] };

        function showPage(id, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            el.classList.add('active');
        }

        function logout() {
            if(confirm("Yakin ingin keluar?")) {
                localStorage.removeItem("user");
                window.location.href = "index.html";
            }
        }

        function printArea(divId) { window.print(); }

        function generateCertificate() {
            const type = document.getElementById('cert-type').value;
            const name = document.getElementById('cert-name-input').value;
            if(!name) { alert("Masukkan nama penerima!"); return; }

            const preview = document.getElementById('certificate-preview');
            const titleEl = preview.querySelector('.cert-title');
            document.getElementById('cert-display-name').innerText = name;
            preview.style.display = 'block';

            // Reset data sertifikat
            document.getElementById('cert-data-jumlah').innerText = "0 Kegiatan";
            document.getElementById('cert-data-nilai').innerText = "0";
            document.getElementById('cert-data-predikat').innerText = "Belum Ada Nilai";

            if (type === 'Pembimbing') {
                titleEl.innerText = "PIAGAM PENGHARGAAN";
                titleEl.style.color = "#10b981"; 
                preview.style.borderColor = "#10b981";
                document.querySelector('.cert-data-table').style.display = 'none';
                document.querySelector('.cert-body').innerHTML = `Diberikan penghargaan setinggi-tingginya atas dedikasi sebagai <strong>Pembimbing Kelompok</strong><br>dalam menyukseskan kegiatan E-KAROMAH SMK Negeri Bojonggambir<br>Tahun 1446 H / 2025 M.`;
            } else {
                titleEl.innerText = "SERTIFIKAT PESERTA";
                titleEl.style.color = "#b45309"; 
                preview.style.borderColor = "#fbbf24";
                document.querySelector('.cert-data-table').style.display = 'table';
                document.querySelector('.cert-body').innerHTML = `Atas partisipasi aktif dalam kegiatan <strong>E-KAROMAH (Kegiatan Romadhon di Rumah)</strong><br>SMK Negeri Bojonggambir Tahun 1446 H / 2025 M.<br>Berdasarkan laporan kegiatan (Google Sheet Report), diperoleh hasil sebagai berikut:`;
            }
        }

        async function loadData() {
            try {
                // Fetch data User dari Google Sheet
                const res = await fetch(API + "?action=getUsers");
                const data = await res.json();
                
                // Simpan data
                globalData = data;
                
                // Render Tabel Siswa & Guru
                renderTable('listSiswa', data.siswa);
                renderTable('listGuru', data.pembimbing);
                renderChart(data);

                // Render Laporan & Penilaian (DEFAULT 0 / KOSONG)
                // Karena data asli belum masuk dari Google Sheet
                renderLaporan(data);
                renderPenilaianByGroup(data);

            } catch(e) { 
                console.error("Error:", e);
                alert("Gagal memuat data dari Google Sheets.");
            }
        }

        function renderPenilaianByGroup(data) {
            const container = document.getElementById('container-penilaian');
            const grouped = {};
            
            // Grouping Siswa per Kelompok
            data.siswa.forEach(s => {
                const kel = s.Kelompok || 'Tanpa Kelompok';
                if(!grouped[kel]) grouped[kel] = [];
                grouped[kel].push(s);
            });

            let htmlContent = '';
            const sortedGroups = Object.keys(grouped).sort();

            if(sortedGroups.length === 0) {
                container.innerHTML = '<div style="text-align:center;">Belum ada data siswa.</div>';
                return;
            }

            sortedGroups.forEach(kelompokName => {
                const guru = data.pembimbing.find(g => g.Kelompok == kelompokName);
                const namaGuru = guru ? guru.Nama : "Belum ada Pembimbing";
                
                // PERBAIKAN: NILAI DEFAULT 0
                const rows = grouped[kelompokName].map((s, idx) => {
                    // Cek jika siswa punya nilai di data (sementara 0)
                    const nilaiAktif = s.NilaiAktif || 0;
                    const nilaiAkhlaq = s.NilaiAkhlaq || 0;
                    const nilaiLaporan = s.NilaiLaporan || 0;

                    return `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${s.Nama}</td>
                        <td style="text-align:center"><span class="score-badge score-none">${nilaiAktif}</span></td>
                        <td style="text-align:center"><span class="score-badge score-none">${nilaiAkhlaq}</span></td>
                        <td style="text-align:center"><span class="score-badge score-none">${nilaiLaporan}</span></td>
                    </tr>`;
                }).join('');

                htmlContent += `
                <div class="group-card">
                    <div class="group-header">
                        <div><div class="group-title">Kelompok: ${kelompokName}</div><div class="group-pembimbing">üëî Pembimbing: ${namaGuru}</div></div>
                    </div>
                    <div class="table-responsive" style="border-bottom:1px solid var(--border);">
                        <table>
                            <thead><tr><th width="50">No</th><th>Nama Siswa</th><th style="text-align:center">Keaktifan</th><th style="text-align:center">Akhlaq</th><th style="text-align:center">Laporan</th></tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                    <div class="group-body">
                        <label style="font-size:13px; font-weight:600; color:#fbbf24;">üìù Catatan Admin untuk Pembimbing:</label>
                        <textarea class="admin-note-area" placeholder="Tulis catatan evaluasi atau apresiasi untuk pembimbing kelompok ini..."></textarea>
                        <div style="text-align:right; margin-top:10px;"><button class="btn btn-primary" onclick="alert('Catatan untuk ${namaGuru} berhasil dikirim!')">üì© Kirim Catatan</button></div>
                    </div>
                </div>`;
            });
            container.innerHTML = htmlContent;
        }

        function renderLaporan(data) {
            const listLaporan = document.getElementById('listLaporan');
            if(data.siswa.length > 0) {
                // PERBAIKAN: DEFAULT TOTAL 0 & STATUS BELUM
                listLaporan.innerHTML = data.siswa.map((u, index) => {
                    // Jika ada data laporan nanti, ambil dari u.TotalLaporan
                    const totalLap = u.TotalLaporan || 0; 
                    const status = totalLap > 20 ? "TUNTAS" : "BELUM";
                    const statusColor = totalLap > 20 ? "#10b981" : "#ef4444";

                    return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${u.Nama || u.Username}</td>
                        <td>${u.Kelompok}</td>
                        <td style="color:var(--text-muted)">${totalLap} Kegiatan</td>
                        <td><span style="color:${statusColor}; font-weight:600; font-size:12px;">${status}</span></td>
                    </tr>`;
                }).join('');
            }
        }

        function renderTable(elementId, dataArray) {
            const el = document.getElementById(elementId);
            if (dataArray && dataArray.length > 0) {
                el.innerHTML = dataArray.map(u => `<tr><td>${u.Username || '-'}</td><td>${u.Nama || '-'}</td><td>${u.Kelompok || '-'}</td></tr>`).join('');
            } else {
                el.innerHTML = '<tr><td colspan="3" style="text-align:center">Data kosong</td></tr>';
            }
        }

        let chartInstance = null;
        function renderChart(data) {
            const ctx = document.getElementById('myChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Siswa', 'Pembimbing'],
                    datasets: [{ data: [data.siswa.length, data.pembimbing.length], backgroundColor: ['#10b981', '#fbbf24'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#fff' } } } }
            });
        }

        loadData();
    </script>
</body>
</html>
