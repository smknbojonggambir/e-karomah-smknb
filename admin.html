<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel Ramadan</title>

<link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* CSS Reset & Variables */
:root {
  --bg-main: #0f172a;
  --bg-sidebar: #1e293b;
  --bg-card: #1e293b;
  --bg-hover: #334155;
  --accent: #facc15;
  --accent-hover: #eab308;
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --border-color: #334155;
}

body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-main); color: var(--text-main); }
.wrapper { display: flex; min-height: 100vh; }

/* --- SIDEBAR STYLING --- */
.sidebar { width: 250px; background: var(--bg-sidebar); padding: 20px; flex-shrink: 0; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; }
.sidebar-header { display: flex; align-items: center; gap: 10px; color: var(--accent); margin-bottom: 30px; }
.sidebar-header i { font-size: 28px; }
.sidebar-header h2 { margin: 0; font-size: 20px; }
.sidebar ul { list-style: none; padding: 0; margin: 0; }
.sidebar li { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; font-size: 15px; color: var(--text-muted); transition: all 0.3s ease; }
.sidebar li i { font-size: 20px; }
.sidebar li:hover { background: var(--bg-hover); color: var(--text-main); }
.sidebar li.active { background: var(--accent); color: #0f172a; font-weight: 600; }

/* --- CONTENT & CARDS --- */
.content { flex: 1; padding: 30px; overflow-x: hidden; }
.page-title { font-size: 24px; margin-bottom: 20px; font-weight: 600; }
.card { background: var(--bg-card); padding: 20px 25px; border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--border-color); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.card h3 { margin: 0; color: var(--text-main); font-size: 16px; font-weight: 600; }
.grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
.grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
.stat-box { display: flex; align-items: center; gap: 15px; background: var(--bg-hover); padding: 20px; border-radius: 10px; }
.stat-icon { width: 50px; height: 50px; background: rgba(250, 204, 21, 0.1); color: var(--accent); border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 24px; }
.stat-info span { font-size: 13px; color: var(--text-muted); }
.stat-info .stat { font-size: 24px; font-weight: bold; color: var(--text-main); margin-top: 5px; }

/* --- BUTTONS --- */
.btn { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; font-size: 13px; transition: 0.2s; }
.btn-primary { background: var(--accent); color: #0f172a; }
.btn-primary:hover { background: var(--accent-hover); }
.btn-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 6px 10px; }
.btn-danger:hover { background: #ef4444; color: white; }
.btn-info { background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 6px 10px; }
.btn-info:hover { background: #3b82f6; color: white; }
.btn-success { background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 6px 10px; }
.btn-success:hover { background: #22c55e; color: white; }
.action-buttons { display: flex; gap: 8px; }

/* --- TABLE & SEARCH --- */
.table-controls { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
.search-bar { display: flex; align-items: center; background: var(--bg-main); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 15px; width: 100%; max-width: 300px; }
.search-bar i { color: var(--text-muted); margin-right: 10px; }
.search-bar input { background: transparent; border: none; color: var(--text-main); outline: none; width: 100%; }
.table-wrapper { overflow-x: auto; max-height: 500px; }
table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 800px; }
th, td { border-bottom: 1px solid var(--border-color); padding: 12px 15px; text-align: left; }
th { background: var(--bg-hover); color: var(--text-muted); font-weight: 600; text-transform: uppercase; font-size: 11px; position: sticky; top: 0; z-index: 10; }
tbody tr { transition: background 0.2s; }
tbody tr:hover { background: #273549; }

/* Status Badges */
.badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.badge-active { background: rgba(34, 197, 94, 0.1); color: #22c55e; }
.badge-warning { background: rgba(250, 204, 21, 0.1); color: #facc15; }
.badge-danger { background: rgba(239, 68, 68, 0.1); color: #ef4444; }

/* --- FORM ELEMENTS --- */
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-size: 13px; color: var(--text-muted); }
.form-control { width: 100%; padding: 10px; border-radius: 5px; background: var(--bg-main); border: 1px solid var(--border-color); color: white; box-sizing: border-box; }

/* --- UTILITIES & LOADING --- */
.hidden { display: none !important; }
.loader-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; gap: 15px; }
.spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.chart-container { position: relative; height: 300px; width: 100%; }

/* Responsive */
@media (max-width: 768px) {
  .wrapper { flex-direction: column; }
  .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); padding: 15px; }
  .sidebar ul { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; }
  .sidebar li { white-space: nowrap; margin-bottom: 0; }
  .content { padding: 15px; }
}
</style>
</head>

<body>

<div class="wrapper">
  <div class="sidebar">
    <div class="sidebar-header">
      <i class='bx bx-moon'></i>
      <h2>Ramadan Panel</h2>
    </div>
    <ul id="menuList">
      <li onclick="showPage('dashboard', this)" class="active"><i class='bx bx-grid-alt'></i> Dashboard</li>
      <li onclick="showPage('laporan', this)"><i class='bx bx-file'></i> Laporan</li>
      <li onclick="showPage('manajemen', this)"><i class='bx bx-cog'></i> Manajemen</li>
      <li onclick="showPage('siswa', this)"><i class='bx bx-user'></i> Data Siswa</li>
      <li onclick="showPage('pembimbing', this)"><i class='bx bx-group'></i> Pembimbing</li>
      <li onclick="showPage('kelompok', this)"><i class='bx bx-sitemap'></i> Kelompok</li>
      <li onclick="showPage('operasional', this)"><i class='bx bx-briefcase'></i> Operasional</li>
      <li onclick="showPage('penilaian', this)"><i class='bx bx-star'></i> Penilaian</li>
      <li onclick="showPage('sertifikat', this)"><i class='bx bx-certification'></i> Sertifikat</li>
    </ul>
  </div>

  <div class="content">
    
    <div id="loading-indicator" class="loader-container">
      <div class="spinner"></div>
      <span id="loading-text" style="color: var(--text-muted);">Memuat data dari server...</span>
    </div>

    <div id="main-content" class="hidden">
      
      <div id="dashboard" class="page">
        <h2 class="page-title">Dashboard Overview</h2>
        <div class="grid-3">
          <div class="stat-box">
            <div class="stat-icon"><i class='bx bx-user'></i></div>
            <div class="stat-info">
              <span>Total Siswa Aktif</span>
              <div class="stat" id="totalSiswa">0</div>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-icon"><i class='bx bx-file'></i></div>
            <div class="stat-info">
              <span>Total Laporan Masuk</span>
              <div class="stat" id="totalLaporan">0</div>
            </div>
          </div>
          <div class="stat-box">
            <div class="stat-icon"><i class='bx bx-line-chart'></i></div>
            <div class="stat-info">
              <span>Rata-rata Nilai Keseluruhan</span>
              <div class="stat" id="rataNilai">0</div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top: 20px;">
          <div class="card-header">
            <h3>Top 5 Siswa (Berdasarkan Total Nilai)</h3>
          </div>
          <div class="chart-container">
            <canvas id="rankingChart"></canvas>
          </div>
        </div>
      </div>

      <div id="laporan" class="page hidden">
        <h2 class="page-title">Data Laporan Harian</h2>
        <div class="card">
          <div class="table-controls">
            <div class="search-bar">
              <i class='bx bx-search'></i>
              <input type="text" id="searchLaporan" onkeyup="searchTable('tableLaporan', 'searchLaporan')" placeholder="Cari laporan (nama/kegiatan)...">
            </div>
            <button class="btn btn-success"><i class='bx bx-export'></i> Export Excel</button>
          </div>
          <div class="table-wrapper">
            <table id="tableLaporan">
              <thead></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="manajemen" class="page hidden">
        <h2 class="page-title">Manajemen Sistem</h2>
        <div class="card">
            <h3>Pengaturan Program Ramadan</h3>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">Atur konfigurasi dasar untuk aplikasi ini.</p>
            <div class="grid-3">
                <div class="form-group">
                    <label>Tahun Hijriah</label>
                    <input type="text" class="form-control" value="1447 H">
                </div>
                <div class="form-group">
                    <label>Status Program</label>
                    <select class="form-control">
                        <option>Aktif</option>
                        <option>Persiapan</option>
                        <option>Selesai</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Target Laporan Minimal</label>
                    <input type="number" class="form-control" value="20">
                </div>
            </div>
            <button class="btn btn-primary" style="margin-top: 10px;"><i class='bx bx-save'></i> Simpan Pengaturan</button>
        </div>
      </div>

      <div id="siswa" class="page hidden">
        <h2 class="page-title">Data Siswa</h2>
        <div class="card">
          <div class="table-controls">
            <div class="search-bar">
              <i class='bx bx-search'></i>
              <input type="text" id="searchSiswa" onkeyup="searchTable('tableSiswa', 'searchSiswa')" placeholder="Cari nama atau NIS...">
            </div>
            <button class="btn btn-primary"><i class='bx bx-plus'></i> Tambah Siswa</button>
          </div>
          <div class="table-wrapper">
            <table id="tableSiswa">
              <thead>
                  <tr><th>NIS / Username</th><th>Nama Siswa</th><th>Kelas</th><th>Kelompok</th><th>Status</th><th>Aksi</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="pembimbing" class="page hidden">
        <h2 class="page-title">Performa Pembimbing & Kelompok</h2>
        
        <div class="card">
            <div class="card-header">
                <h3>Merekap Progres Laporan Kelompok</h3>
            </div>
            <div class="table-controls" style="margin-bottom: 10px;">
              <div class="search-bar">
                <i class='bx bx-search'></i>
                <input type="text" id="searchPembimbing" onkeyup="searchTable('tablePembimbing', 'searchPembimbing')" placeholder="Cari kelompok/pembimbing...">
              </div>
            </div>
            <div class="table-wrapper">
              <table id="tablePembimbing">
                <thead>
                    <tr>
                        <th>Kelompok</th>
                        <th>Nama Pembimbing</th>
                        <th>Jml Siswa</th>
                        <th>Total Laporan Masuk</th>
                        <th>Progres Kelompok</th>
                    </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>Pengerjaan Penilaian Harian</h3>
            </div>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 15px;">Memantau sisa laporan yang belum divalidasi/dinilai oleh pembimbing.</p>
            <div class="table-wrapper">
              <table id="tablePenilaianPembimbing">
                <thead>
                    <tr>
                        <th>Nama Pembimbing</th>
                        <th>Laporan Masuk</th>
                        <th>Belum Dinilai</th>
                        <th>Persentase Kinerja</th>
                    </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
        </div>
      </div>

      <div id="kelompok" class="page hidden">
        <h2 class="page-title">Master Data Kelompok</h2>
        <div class="card">
            <div class="table-controls">
              <div class="search-bar">
                <i class='bx bx-search'></i>
                <input type="text" id="searchKelompok" onkeyup="searchTable('tableKelompok', 'searchKelompok')" placeholder="Cari nama kelompok...">
              </div>
            </div>
            <div class="table-wrapper">
              <table id="tableKelompok">
                <thead></thead>
                <tbody></tbody>
              </table>
            </div>
        </div>
      </div>

      <div id="operasional" class="page hidden">
        <h2 class="page-title">Operasional & Informasi</h2>
        <div class="grid-2">
            <div class="card">
                <h3><i class='bx bx-broadcast'></i> Broadcast Pengumuman</h3>
                <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 15px;">Kirim pesan pengumuman ke dashboard semua siswa.</p>
                <div class="form-group">
                    <label>Judul Pengumuman</label>
                    <input type="text" class="form-control" placeholder="Cth: Jadwal Bukber Angkatan">
                </div>
                <div class="form-group">
                    <label>Isi Pesan</label>
                    <textarea class="form-control" rows="4" placeholder="Ketik isi pengumuman di sini..."></textarea>
                </div>
                <button class="btn btn-primary"><i class='bx bx-send'></i> Kirim Broadcast</button>
            </div>
            
            <div class="card">
                <h3><i class='bx bx-task'></i> Log Aktivitas Admin</h3>
                <ul style="list-style: none; padding: 0; margin-top: 15px; font-size: 13px;">
                    <li style="padding: 10px; border-bottom: 1px solid var(--border-color); color: var(--text-muted);">
                        <strong style="color: var(--text-main);">Hari ini, 08:30</strong> - Admin Budi memperbarui pengaturan tahun Hijriah.
                    </li>
                    <li style="padding: 10px; border-bottom: 1px solid var(--border-color); color: var(--text-muted);">
                        <strong style="color: var(--text-main);">Kemarin, 14:15</strong> - Admin mengunggah data kelompok angkatan 3.
                    </li>
                    <li style="padding: 10px; color: var(--text-muted);">
                        <strong style="color: var(--text-main);">Kemarin, 10:00</strong> - Sistem melakukan backup database mingguan.
                    </li>
                </ul>
            </div>
        </div>
      </div>

      <div id="penilaian" class="page hidden">
        <h2 class="page-title">Rekap Penilaian Akhir</h2>
        <div class="card">
            <div class="table-controls">
              <div class="search-bar">
                <i class='bx bx-search'></i>
                <input type="text" id="searchPenilaian" onkeyup="searchTable('tablePenilaian', 'searchPenilaian')" placeholder="Cari nama siswa...">
              </div>
              <button class="btn btn-success"><i class='bx bx-printer'></i> Cetak Rekap Kelas</button>
            </div>
            <div class="table-wrapper">
              <table id="tablePenilaian">
                <thead>
                    <tr>
                        <th>NIS / Username</th>
                        <th>Nama Siswa</th>
                        <th>Kelompok</th>
                        <th>Total Laporan</th>
                        <th>Rata-rata Nilai</th>
                        <th>Status Mutaba'ah</th>
                    </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
        </div>
      </div>

      <div id="sertifikat" class="page hidden">
        <h2 class="page-title">Penerbitan Sertifikat</h2>
        <div class="card">
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 15px;">Daftar siswa yang telah menyelesaikan program dan berhak mendapatkan sertifikat.</p>
            <div class="table-controls">
              <div class="search-bar">
                <i class='bx bx-search'></i>
                <input type="text" id="searchSertifikat" onkeyup="searchTable('tableSertifikat', 'searchSertifikat')" placeholder="Cari siswa penerima...">
              </div>
            </div>
            <div class="table-wrapper">
              <table id="tableSertifikat">
                <thead>
                    <tr>
                        <th>Nama Siswa</th>
                        <th>Kelompok</th>
                        <th>Nilai Akhir</th>
                        <th>Kelayakan</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
// --- KONFIGURASI SCRIPT URL ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBy_-AmeZquA9pF2WhlDFOW5JBLgdoEkL0rDFpEFXhObTm-aJ0qGbDL_F2xtBRcl2I_A/exec"; 

let dataMaster = { laporan: [], siswa: [], kelompok: [] }; 
let chartInstance = null; 

// --- FUNGSI PARSING NILAI ---
// Mengubah input teks dari pembimbing menjadi angka matematis yang bisa dihitung rata-ratanya
function parseNilai(str) {
    if (!str || str.toString().trim() === "") return { isDinilai: false, value: 0 };
    let s = str.toString().trim();
    
    // Jika format angkanya [N:80]
    let match = s.match(/\[N:\s*(\d+)\]/i);
    if (match) return { isDinilai: true, value: parseInt(match[1]) };
    
    // Jika formatnya deskriptif 
    if (s.toLowerCase().includes("sesuai") || s.toLowerCase().includes("lengkap")) return { isDinilai: true, value: 100 };
    if (s.toLowerCase().includes("sebagian")) return { isDinilai: true, value: 50 };
    
    // Jika angka murni
    let num = parseFloat(s);
    if (!isNaN(num)) return { isDinilai: true, value: num };
    
    // Default jika string ada tapi tidak dikenali di atas, anggap dinilai dgn nilai 75
    return { isDinilai: true, value: 75 }; 
}

// --- FUNGSI NAVIGASI HALAMAN ---
function showPage(pageId, element){ 
  const targetPage = document.getElementById(pageId);
  if (!targetPage) { alert("Halaman belum siap!"); return; }

  document.querySelectorAll(".content .page").forEach(p => p.classList.add("hidden")); 
  targetPage.classList.remove("hidden"); 

  if(element) { 
    document.querySelectorAll(".sidebar li").forEach(li => li.classList.remove("active")); 
    element.classList.add("active"); 
  } 
} 

// --- FUNGSI PENCARIAN TABEL ---
function searchTable(tableId, inputId) { 
  const input = document.getElementById(inputId).value.toLowerCase(); 
  const rows = document.querySelectorAll(`#${tableId} tbody tr`); 
  rows.forEach(row => { 
    row.style.display = row.textContent.toLowerCase().includes(input) ? "" : "none"; 
  }); 
} 

// --- FUNGSI MEMUAT DATA DARI SERVER ---
async function loadData(){ 
  const loadingDiv = document.getElementById("loading-indicator"); 
  const mainContent = document.getElementById("main-content"); 
  try { 
    const res = await fetch(SCRIPT_URL); 
    if (!res.ok) throw new Error("Gagal terhubung"); 
    
    const raw = await res.json(); 
    
    if (raw.status === "success") { 
      dataMaster.laporan = raw.laporan || []; 
      dataMaster.siswa = raw.siswa || []; 
      dataMaster.kelompok = raw.kelompok || []; 
    } 
    
    // Render semua UI
    renderDashboard(); 
    renderTableLaporan(); 
    renderTableSiswa(); 
    renderTableKelompok(); 
    renderTablePembimbing(); 
    renderPenilaianDanSertifikat();
    
    loadingDiv.classList.add("hidden"); 
    mainContent.classList.remove("hidden"); 
  } catch (error) { 
    console.error("Error:", error); 
    document.getElementById("loading-text").innerText = "Gagal memuat data. Pastikan link Google Script benar."; 
    document.querySelector(".spinner").style.display = "none"; 
  } 
} 

// --- RENDER HALAMAN DASHBOARD ---
function renderDashboard(){ 
  const laporan = dataMaster.laporan; 
  let totalNilai = 0, countNilai = 0; 
  const ranking = {}; 
  
  laporan.forEach(item => { 
    const nama = item.nama || item.nama_siswa || item.username; 
    const evalNilai = parseNilai(item.nilai_pembimbing || item.Nilai_Pembimbing);
    
    if (nama && evalNilai.isDinilai) { 
      if(!ranking[nama]) ranking[nama] = 0; 
      ranking[nama] += evalNilai.value; 
    } 
    
    if(evalNilai.isDinilai) { 
      totalNilai += evalNilai.value; 
      countNilai++; 
    } 
  }); 
  
  const siswaAktif = dataMaster.siswa.filter(s => s.role !== 'admin' && s.role !== 'pembimbing'); 
  
  document.getElementById("totalSiswa").innerText = siswaAktif.length; 
  document.getElementById("totalLaporan").innerText = laporan.length; 
  document.getElementById("rataNilai").innerText = countNilai ? (totalNilai / countNilai).toFixed(1) : 0; 
  
  const topData = Object.entries(ranking).sort((a, b) => b[1] - a[1]).slice(0, 5); 
  renderChart(topData.map(d => d[0]), topData.map(d => d[1])); 
} 

// --- RENDER GRAFIK CHART.JS ---
function renderChart(labels, data) { 
  const ctx = document.getElementById('rankingChart').getContext('2d'); 
  if(chartInstance) chartInstance.destroy(); 
  chartInstance = new Chart(ctx, { 
    type: 'bar', 
    data: { 
      labels: labels, 
      datasets: [{ label: 'Total Skor Terkumpul', data: data, backgroundColor: '#facc15', borderRadius: 6 }] 
    }, 
    options: { responsive: true, maintainAspectRatio: false } 
  }); 
} 

// --- RENDER TABEL LAPORAN ---
function renderTableLaporan(){ 
  const thead = document.querySelector("#tableLaporan thead"); 
  const tbody = document.querySelector("#tableLaporan tbody"); 
  const data = dataMaster.laporan; 
  
  if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Belum ada laporan.</td></tr>"; return; } 
  
  const headers = Object.keys(data[0]).filter(h => h !== 'id_baris'); 
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join("") + "</tr>"; 
  
  tbody.innerHTML = data.map(row => 
    "<tr>" + headers.map(h => { 
      let val = row[h]; 
      if(typeof val === 'string' && val.includes("T") && val.includes("Z")) { 
        try { val = new Date(val).toLocaleDateString('id-ID'); } catch(e){} 
      } 
      return `<td>${val || '-'}</td>`; 
    }).join("") + "</tr>" 
  ).join(""); 
} 

// --- RENDER TABEL SISWA ---
function renderTableSiswa() { 
  const tbody = document.querySelector("#tableSiswa tbody"); 
  const siswaSaja = dataMaster.siswa.filter(u => u.role !== 'admin' && u.role !== 'pembimbing'); 
  
  if (siswaSaja.length === 0) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Belum ada data siswa.</td></tr>"; return; } 
  
  tbody.innerHTML = siswaSaja.map(row => `
    <tr>
      <td>${row.username || '-'}</td>
      <td>${row.nama || '-'}</td>
      <td>-</td>
      <td>${row.kelompok || '-'}</td>
      <td><span class="badge badge-active">Aktif</span></td>
      <td class="action-buttons">
          <button class="btn btn-info"><i class='bx bx-edit'></i></button>
          <button class="btn btn-danger"><i class='bx bx-trash'></i></button>
      </td>
    </tr>
  `).join(""); 
} 

// --- RENDER TABEL KELOMPOK ---
function renderTableKelompok() {
  const thead = document.querySelector("#tableKelompok thead");
  const tbody = document.querySelector("#tableKelompok tbody");
  const data = dataMaster.kelompok;
  
  if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Belum ada data kelompok.</td></tr>"; return; }
  
  const headers = Object.keys(data[0]).filter(h => h !== 'id_baris'); 
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join("") + "</tr>"; 
  tbody.innerHTML = data.map(row => "<tr>" + headers.map(h => `<td>${row[h] || '-'}</td>`).join("") + "</tr>").join(""); 
}

// --- RENDER TABEL PEMBIMBING & KINERJA KELOMPOK ---
function renderTablePembimbing() {
  const tbodyProgres = document.querySelector("#tablePembimbing tbody");
  const tbodyPenilaian = document.querySelector("#tablePenilaianPembimbing tbody");
  
  const kelompokMaster = dataMaster.kelompok || [];
  const siswaList = (dataMaster.siswa || []).filter(u => u.role !== 'admin' && u.role !== 'pembimbing');
  const laporanList = dataMaster.laporan || [];

  if (kelompokMaster.length === 0) {
      tbodyProgres.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Belum ada master data kelompok terdaftar.</td></tr>";
      tbodyPenilaian.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Belum ada master data kelompok terdaftar.</td></tr>";
      return;
  }

  let htmlProgres = "";
  let htmlKinerja = "";

  kelompokMaster.forEach(k => {
      // Ambil Nama Kelompok dan Pembimbing (Akurasi Tinggi dari Data Master)
      const namaKelompok = k.kelompok || k.Kelompok || "-";
      const namaPembimbing = k.pembimbing || k.Pembimbing || k.UsernamePembimbing || "Belum Ditentukan";
      
      // Hitung jumlah siswa di kelompok tersebut
      const jumlahSiswa = siswaList.filter(s => 
          (s.kelompok || '').toLowerCase() === namaKelompok.toLowerCase()
      ).length;
      
      // Filter laporan langsung dari identifier 'kelompok' di Tabel Laporan
      const laporanKelompok = laporanList.filter(lap => 
          (lap.kelompok || lap.Kelompok || '').toLowerCase() === namaKelompok.toLowerCase()
      );

      const totalMasuk = laporanKelompok.length;
      
      // Cek yang sudah dinilai menggunakan parseNilai
      const sudahDinilai = laporanKelompok.filter(lap => {
          const nilai = lap.nilai_pembimbing || lap.Nilai_Pembimbing; 
          return parseNilai(nilai).isDinilai;
      }).length;
      
      const belumDinilai = totalMasuk - sudahDinilai;
      const persen = totalMasuk > 0 ? Math.round((sudahDinilai / totalMasuk) * 100) : 0;

      // Render Tabel 1: Progres Kelompok
      let badgeProgres = `<span class="badge badge-danger">Rendah</span>`;
      if (totalMasuk > (jumlahSiswa * 7)) badgeProgres = `<span class="badge badge-warning">Sedang</span>`; 
      if (totalMasuk > (jumlahSiswa * 15)) badgeProgres = `<span class="badge badge-active">Tinggi</span>`;
      if (jumlahSiswa === 0) badgeProgres = `<span class="badge" style="background:#334155;">N/A</span>`;

      htmlProgres += `
        <tr>
            <td><strong>${namaKelompok.toUpperCase()}</strong></td>
            <td>${namaPembimbing}</td>
            <td>${jumlahSiswa} Orang</td>
            <td>${totalMasuk} Laporan</td>
            <td>${badgeProgres}</td>
        </tr>
      `;

      // Render Tabel 2: Kinerja Pembimbing
      let badgeKinerja = "badge-danger";
      if (persen >= 50) badgeKinerja = "badge-warning";
      if (persen >= 90) badgeKinerja = "badge-active"; 

      const colorBelumDinilai = belumDinilai > 0 ? "#ef4444" : "#22c55e";

      htmlKinerja += `
        <tr>
            <td>
                <strong>${namaPembimbing}</strong>
                <br><small style="color:var(--text-muted)">(${namaKelompok.toUpperCase()})</small>
            </td>
            <td>${totalMasuk}</td>
            <td style="color: ${colorBelumDinilai}; font-weight: bold;">${belumDinilai}</td>
            <td><span class="badge ${totalMasuk === 0 ? '' : badgeKinerja}">${totalMasuk === 0 ? '0%' : persen + '%'} Dinilai</span></td>
        </tr>
      `;
  });

  tbodyProgres.innerHTML = htmlProgres;
  tbodyPenilaian.innerHTML = htmlKinerja;
}

// --- RENDER TABEL PENILAIAN & SERTIFIKAT ---
function renderPenilaianDanSertifikat() {
  const tbodyPenilaian = document.querySelector("#tablePenilaian tbody");
  const tbodySertifikat = document.querySelector("#tableSertifikat tbody");
  
  const siswaList = dataMaster.siswa.filter(u => u.role !== 'admin' && u.role !== 'pembimbing');
  const laporanList = dataMaster.laporan;

  if (siswaList.length === 0) {
      tbodyPenilaian.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Tidak ada data siswa.</td></tr>";
      tbodySertifikat.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Tidak ada data siswa.</td></tr>";
      return;
  }

  let htmlPenilaian = "";
  let htmlSertifikat = "";

  siswaList.forEach(siswa => {
      const namaSiswa = siswa.nama || siswa.username;
      
      const laporanSiswa = laporanList.filter(lap => 
          (lap.nama === namaSiswa) || (lap.nama_siswa === namaSiswa) || (lap.username === siswa.username)
      );

      const totalLaporan = laporanSiswa.length;
      
      let akumulasiNilai = 0;
      let countDinilai = 0;
      
      // Kalkulasi rata-rata menggunakan fungsi parseNilai
      laporanSiswa.forEach(lap => {
          const evalNilai = parseNilai(lap.nilai_pembimbing || lap.Nilai_Pembimbing);
          if (evalNilai.isDinilai) {
              akumulasiNilai += evalNilai.value;
              countDinilai++;
          }
      });

      const rataRata = countDinilai > 0 ? (akumulasiNilai / countDinilai).toFixed(1) : 0;
      
      const isLulus = (totalLaporan >= 10 && rataRata >= 70);
      const badgeLulus = isLulus ? `<span class="badge badge-active">Lulus</span>` : `<span class="badge badge-warning">Belum Lulus</span>`;

      htmlPenilaian += `
        <tr>
            <td>${siswa.username || '-'}</td>
            <td>${namaSiswa}</td>
            <td>${siswa.kelompok || '-'}</td>
            <td>${totalLaporan}</td>
            <td>${rataRata}</td>
            <td>${badgeLulus}</td>
        </tr>
      `;

      if (isLulus) {
          htmlSertifikat += `
            <tr>
                <td><strong>${namaSiswa}</strong></td>
                <td>${siswa.kelompok || '-'}</td>
                <td>${rataRata}</td>
                <td><span class="badge badge-active">Memenuhi Syarat</span></td>
                <td>
                    <button class="btn btn-primary"><i class='bx bx-printer'></i> Cetak</button>
                </td>
            </tr>
          `;
      }
  });

  tbodyPenilaian.innerHTML = htmlPenilaian;
  tbodySertifikat.innerHTML = htmlSertifikat || "<tr><td colspan='5' style='text-align:center;'>Belum ada siswa yang memenuhi syarat sertifikat.</td></tr>";
}

// Menjalankan fungsi memuat data ketika halaman HTML pertama kali terbuka
document.addEventListener("DOMContentLoaded", loadData);
</script>

</body>
</html>
