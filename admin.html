<script>
// ==========================================
// 1. KONFIGURASI SCRIPT URL (PINDAH KE PALING ATAS)
// ==========================================
// ⚠️ PASTIKAN URL WEB APP INI SUDAH YANG TERBARU (DEPLOYMENT BARU)
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwBy_-AmeZquA9pF2WhlDFOW5JBLgdoEkL0rDFpEFXhObTm-aJ0qGbDL_F2xtBRcl2I_A/exec"; 

let dataMaster = { laporan: [], siswa: [], kelompok: [] }; 
let chartInstance = null; 

// ==========================================
// 2. PENGECEKAN LOGIN MENGGUNAKAN LOCALSTORAGE
// ==========================================
let userObj = null;
try {
    userObj = JSON.parse(localStorage.getItem("user"));
} catch(e) {
    console.error("Gagal membaca data user dari localStorage");
}

if (!userObj || userObj.role !== 'admin') {
    alert("⛔ Akses Ditolak. Anda tidak memiliki akses atau belum login sebagai Admin.");
    window.location.href = 'index.html'; // Arahkan kembali ke halaman login utama
} else {
    // Tampilkan aplikasi jika sudah login sebagai admin
    document.getElementById("app-wrapper").style.display = "flex";
    
    // Tampilkan nama admin di sidebar
    document.getElementById("adminNameDisplay").innerText = userObj.nama || "Administrator";
    
    // Mulai memuat data dari server (Sekarang SCRIPT_URL sudah dikenali)
    loadData();
}

// Fungsi Logout
function logout() {
    if(confirm("Yakin ingin keluar dari panel Admin?")) {
        localStorage.removeItem("user");
        window.location.href = 'index.html';
    }
}

// --- FUNGSI PARSING NILAI ---
function parseNilai(str) {
    if (!str || str.toString().trim() === "") return { isDinilai: false, value: 0 };
    let s = str.toString().trim();
    
    if (match = s.match(/\[N:\s*(\d+)\]/i)) return { isDinilai: true, value: parseInt(match[1]) };
    if (s.toLowerCase().includes("sesuai") || s.toLowerCase().includes("lengkap")) return { isDinilai: true, value: 100 };
    if (s.toLowerCase().includes("sebagian")) return { isDinilai: true, value: 50 };
    
    let num = parseFloat(s);
    if (!isNaN(num)) return { isDinilai: true, value: num };
    
    return { isDinilai: true, value: 75 }; 
}

// --- FUNGSI NAVIGASI HALAMAN ---
function showPage(pageId, element){ 
  const targetPage = document.getElementById(pageId);
  if (!targetPage) { alert("Halaman belum siap!"); return; }

  document.querySelectorAll(".content .page").forEach(p => p.classList.add("hidden")); 
  targetPage.classList.remove("hidden"); 

  if(element) { 
    document.querySelectorAll(".sidebar li").forEach(li => li.classList.remove("active")); 
    element.classList.add("active"); 
  } 
} 

// --- FUNGSI PENCARIAN TABEL ---
function searchTable(tableId, inputId) { 
  const input = document.getElementById(inputId).value.toLowerCase(); 
  const rows = document.querySelectorAll(`#${tableId} tbody tr`); 
  rows.forEach(row => { 
    row.style.display = row.textContent.toLowerCase().includes(input) ? "" : "none"; 
  }); 
} 

// --- FUNGSI MEMUAT DATA DARI SERVER ---
async function loadData(){ 
  const loadingDiv = document.getElementById("loading-indicator"); 
  const mainContent = document.getElementById("main-content"); 
  try { 
    // Menambahkan action=rekapAdmin dan waktu (mencegah cache browser nyangkut)
    const url = `${SCRIPT_URL}?action=rekapAdmin&t=${new Date().getTime()}`;
    const res = await fetch(url); 
    if (!res.ok) throw new Error("Gagal terhubung"); 
    
    // Membaca sebagai teks dulu untuk mencegah crash parsing JSON
    const textResponse = await res.text();
    let raw;
    try {
        raw = JSON.parse(textResponse);
    } catch (e) {
        console.error("Respons dari server bukan JSON:", textResponse);
        throw new Error("Format respons dari server tidak valid. Pastikan Code.gs menggunakan fungsi rekapAdminLanjutan().");
    }
    
    if (raw.status === "success") { 
      dataMaster.laporan = raw.laporan || []; 
      dataMaster.siswa = raw.siswa || []; 
      dataMaster.kelompok = raw.kelompok || []; 
    } 
    
    renderDashboard(); 
    renderTableLaporan(); 
    renderTableSiswa(); 
    renderTableKelompok(); 
    renderTablePembimbing(); 
    renderPenilaianDanSertifikat();
    
    loadingDiv.classList.add("hidden"); 
    mainContent.classList.remove("hidden"); 
  } catch (error) { 
    console.error("Error:", error); 
    document.getElementById("loading-text").innerText = "Gagal memuat data. Cek Console (F12) untuk melihat pesan error."; 
    document.querySelector(".spinner").style.display = "none"; 
  } 
} 

// --- RENDER HALAMAN DASHBOARD ---
function renderDashboard(){ 
  const laporan = dataMaster.laporan; 
  let totalNilai = 0, countNilai = 0; 
  const ranking = {}; 
  
  laporan.forEach(item => { 
    const nama = item.nama || item.nama_siswa || item.username; 
    const evalNilai = parseNilai(item.nilai_pembimbing || item.Nilai_Pembimbing);
    
    if (nama && evalNilai.isDinilai) { 
      if(!ranking[nama]) ranking[nama] = 0; 
      ranking[nama] += evalNilai.value; 
    } 
    
    if(evalNilai.isDinilai) { 
      totalNilai += evalNilai.value; 
      countNilai++; 
    } 
  }); 
  
  const siswaAktif = dataMaster.siswa.filter(s => s.role !== 'admin' && s.role !== 'pembimbing'); 
  
  document.getElementById("totalSiswa").innerText = siswaAktif.length; 
  document.getElementById("totalLaporan").innerText = laporan.length; 
  document.getElementById("rataNilai").innerText = countNilai ? (totalNilai / countNilai).toFixed(1) : 0; 
  
  const topData = Object.entries(ranking).sort((a, b) => b[1] - a[1]).slice(0, 5); 
  renderChart(topData.map(d => d[0]), topData.map(d => d[1])); 
} 

// --- RENDER GRAFIK CHART.JS ---
function renderChart(labels, data) { 
  const ctx = document.getElementById('rankingChart').getContext('2d'); 
  if(chartInstance) chartInstance.destroy(); 
  chartInstance = new Chart(ctx, { 
    type: 'bar', 
    data: { 
      labels: labels, 
      datasets: [{ label: 'Total Skor Terkumpul', data: data, backgroundColor: '#facc15', borderRadius: 6 }] 
    }, 
    options: { responsive: true, maintainAspectRatio: false } 
  }); 
} 

// --- RENDER TABEL LAPORAN ---
function renderTableLaporan(){ 
  const thead = document.querySelector("#tableLaporan thead"); 
  const tbody = document.querySelector("#tableLaporan tbody"); 
  const data = dataMaster.laporan; 
  
  if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Belum ada laporan.</td></tr>"; return; } 
  
  const headers = Object.keys(data[0]).filter(h => h !== 'id_baris'); 
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join("") + "</tr>"; 
  
  tbody.innerHTML = data.map(row => 
    "<tr>" + headers.map(h => { 
      let val = row[h]; 
      if(typeof val === 'string' && val.includes("T") && val.includes("Z")) { 
        try { val = new Date(val).toLocaleDateString('id-ID'); } catch(e){} 
      } 
      return `<td>${val || '-'}</td>`; 
    }).join("") + "</tr>" 
  ).join(""); 
} 

// --- RENDER TABEL SISWA ---
function renderTableSiswa() { 
  const tbody = document.querySelector("#tableSiswa tbody"); 
  const siswaSaja = dataMaster.siswa.filter(u => u.role !== 'admin' && u.role !== 'pembimbing'); 
  
  if (siswaSaja.length === 0) { tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Belum ada data siswa.</td></tr>"; return; } 
  
  tbody.innerHTML = siswaSaja.map(row => `
    <tr>
      <td>${row.username || '-'}</td>
      <td>${row.nama || '-'}</td>
      <td>-</td>
      <td>${row.kelompok || '-'}</td>
      <td><span class="badge badge-active">Aktif</span></td>
      <td class="action-buttons">
          <button class="btn btn-info"><i class='bx bx-edit'></i></button>
          <button class="btn btn-danger"><i class='bx bx-trash'></i></button>
      </td>
    </tr>
  `).join(""); 
} 

// --- RENDER TABEL KELOMPOK ---
function renderTableKelompok() {
  const thead = document.querySelector("#tableKelompok thead");
  const tbody = document.querySelector("#tableKelompok tbody");
  const data = dataMaster.kelompok;
  
  if (data.length === 0) { tbody.innerHTML = "<tr><td colspan='100%' style='text-align:center;'>Belum ada data kelompok.</td></tr>"; return; }
  
  const headers = Object.keys(data[0]).filter(h => h !== 'id_baris'); 
  thead.innerHTML = "<tr>" + headers.map(h => `<th>${h.replace(/_/g, ' ').toUpperCase()}</th>`).join("") + "</tr>"; 
  tbody.innerHTML = data.map(row => "<tr>" + headers.map(h => `<td>${row[h] || '-'}</td>`).join("") + "</tr>").join(""); 
}

// --- RENDER TABEL PEMBIMBING & KINERJA KELOMPOK ---
function renderTablePembimbing() {
  const tbodyProgres = document.querySelector("#tablePembimbing tbody");
  const tbodyPenilaian = document.querySelector("#tablePenilaianPembimbing tbody");
  
  const filterTanggalEl = document.getElementById("filterTanggalPenilaian");
  const filterTanggal = filterTanggalEl ? filterTanggalEl.value : "";
  
  const kelompokMaster = dataMaster.kelompok || [];
  const siswaList = (dataMaster.siswa || []).filter(u => u.role !== 'admin' && u.role !== 'pembimbing');
  const laporanList = dataMaster.laporan || [];

  if (kelompokMaster.length === 0) {
      tbodyProgres.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Belum ada master data kelompok terdaftar.</td></tr>";
      tbodyPenilaian.innerHTML = "<tr><td colspan='4' style='text-align:center;'>Belum ada master data kelompok terdaftar.</td></tr>";
      return;
  }

  let htmlProgres = "";
  let htmlKinerja = "";

  kelompokMaster.forEach(k => {
      const namaKelompok = k.kelompok || k.Kelompok || "-";
      const namaPembimbing = k.pembimbing || k.Pembimbing || k.UsernamePembimbing || "Belum Ditentukan";
      
      const jumlahSiswa = siswaList.filter(s => 
          (s.kelompok || '').toLowerCase() === namaKelompok.toLowerCase()
      ).length;
      
      // --- TABEL 1: PROGRES KESELURUHAN ---
      const laporanKelompokAll = laporanList.filter(lap => 
          (lap.kelompok || lap.Kelompok || '').toLowerCase() === namaKelompok.toLowerCase()
      );
      const totalMasukAll = laporanKelompokAll.length;

      let badgeProgres = `<span class="badge badge-danger">Rendah</span>`;
      if (totalMasukAll > (jumlahSiswa * 7)) badgeProgres = `<span class="badge badge-warning">Sedang</span>`; 
      if (totalMasukAll > (jumlahSiswa * 15)) badgeProgres = `<span class="badge badge-active">Tinggi</span>`;
      if (jumlahSiswa === 0) badgeProgres = `<span class="badge" style="background:#334155;">N/A</span>`;

      htmlProgres += `
        <tr>
            <td><strong>${namaKelompok.toUpperCase()}</strong></td>
            <td>${namaPembimbing}</td>
            <td>${jumlahSiswa} Orang</td>
            <td>${totalMasukAll} Laporan</td>
            <td>${badgeProgres}</td>
        </tr>
      `;

      // --- TABEL 2: PENILAIAN HARIAN ---
      let laporanHarian = laporanKelompokAll;
      
      if (filterTanggal) {
          laporanHarian = laporanHarian.filter(lap => {
              const tglRecord = lap.tanggal || lap.Tanggal || lap.waktu || lap.timestamp || lap.Timestamp;
              if (!tglRecord) return false;
              
              try {
                  const dateObj = new Date(tglRecord);
                  if (isNaN(dateObj.getTime())) return false;
                  
                  const yyyy = dateObj.getFullYear();
                  const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
                  const dd = String(dateObj.getDate()).padStart(2, '0');
                  const formattedDate = `${yyyy}-${mm}-${dd}`;
                  
                  return formattedDate === filterTanggal;
              } catch(e) {
                  return false;
              }
          });
      }

      const totalMasukHarian = laporanHarian.length;
      
      const sudahDinilaiHarian = laporanHarian.filter(lap => {
          const nilai = lap.nilai_pembimbing || lap.Nilai_Pembimbing; 
          return parseNilai(nilai).isDinilai;
      }).length;
      
      const belumDinilaiHarian = totalMasukHarian - sudahDinilaiHarian;
      const persen = totalMasukHarian > 0 ? Math.round((sudahDinilaiHarian / totalMasukHarian) * 100) : 0;

      let badgeKinerja = "badge-danger";
      if (persen >= 50) badgeKinerja = "badge-warning";
      if (persen >= 90) badgeKinerja = "badge-active"; 

      const colorBelumDinilai = belumDinilaiHarian > 0 ? "#ef4444" : "#22c55e";

      htmlKinerja += `
        <tr>
            <td>
                <strong>${namaPembimbing}</strong>
                <br><small style="color:var(--text-muted)">(${namaKelompok.toUpperCase()})</small>
            </td>
            <td>${totalMasukHarian}</td>
            <td style="color: ${colorBelumDinilai}; font-weight: bold;">${belumDinilaiHarian}</td>
            <td><span class="badge ${totalMasukHarian === 0 ? '' : badgeKinerja}">${totalMasukHarian === 0 ? '0%' : persen + '%'} Dinilai</span></td>
        </tr>
      `;
  });

  tbodyProgres.innerHTML = htmlProgres;
  tbodyPenilaian.innerHTML = htmlKinerja;
}

// --- RENDER TABEL PENILAIAN & SERTIFIKAT ---
function renderPenilaianDanSertifikat() {
  const tbodyPenilaian = document.querySelector("#tablePenilaian tbody");
  const tbodySertifikat = document.querySelector("#tableSertifikat tbody");
  
  const siswaList = dataMaster.siswa.filter(u => u.role !== 'admin' && u.role !== 'pembimbing');
  const laporanList = dataMaster.laporan;

  if (siswaList.length === 0) {
      tbodyPenilaian.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Tidak ada data siswa.</td></tr>";
      tbodySertifikat.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Tidak ada data siswa.</td></tr>";
      return;
  }

  let htmlPenilaian = "";
  let htmlSertifikat = "";

  siswaList.forEach(siswa => {
      const namaSiswa = siswa.nama || siswa.username;
      
      const laporanSiswa = laporanList.filter(lap => 
          (lap.nama === namaSiswa) || (lap.nama_siswa === namaSiswa) || (lap.username === siswa.username)
      );

      const totalLaporan = laporanSiswa.length;
      
      let akumulasiNilai = 0;
      let countDinilai = 0;
      
      laporanSiswa.forEach(lap => {
          const evalNilai = parseNilai(lap.nilai_pembimbing || lap.Nilai_Pembimbing);
          if (evalNilai.isDinilai) {
              akumulasiNilai += evalNilai.value;
              countDinilai++;
          }
      });

      const rataRata = countDinilai > 0 ? (akumulasiNilai / countDinilai).toFixed(1) : 0;
      
      const isLulus = (totalLaporan >= 10 && rataRata >= 70);
      const badgeLulus = isLulus ? `<span class="badge badge-active">Lulus</span>` : `<span class="badge badge-warning">Belum Lulus</span>`;

      htmlPenilaian += `
        <tr>
            <td>${siswa.username || '-'}</td>
            <td>${namaSiswa}</td>
            <td>${siswa.kelompok || '-'}</td>
            <td>${totalLaporan}</td>
            <td>${rataRata}</td>
            <td>${badgeLulus}</td>
        </tr>
      `;

      if (isLulus) {
          htmlSertifikat += `
            <tr>
                <td><strong>${namaSiswa}</strong></td>
                <td>${siswa.kelompok || '-'}</td>
                <td>${rataRata}</td>
                <td><span class="badge badge-active">Memenuhi Syarat</span></td>
                <td>
                    <button class="btn btn-primary"><i class='bx bx-printer'></i> Cetak</button>
                </td>
            </tr>
          `;
      }
  });

  tbodyPenilaian.innerHTML = htmlPenilaian;
  tbodySertifikat.innerHTML = htmlSertifikat || "<tr><td colspan='5' style='text-align:center;'>Belum ada siswa yang memenuhi syarat sertifikat.</td></tr>";
}
</script>
