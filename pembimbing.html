<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Pembimbing Pro - E-KAROMAH (Strict Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --gold: #fbbf24;
            --bg-dark: #0f172a; 
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --danger: #ef4444;
            --blue: #3b82f6;
            --warning-bg: rgba(251, 191, 36, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: #0f172a;
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* --- Header --- */
        header {
            background: #1e293b;
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 40;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .mentor-profile h2 { margin: 0; font-size: 16px; color: var(--gold); }
        .mentor-profile span { font-size: 11px; color: #94a3b8; font-weight: 500; }
        .btn-logout { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); color: var(--danger); padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .btn-logout:hover { background: var(--danger); color: white; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* --- Filter --- */
        .filter-container {
            background: #1e293b; padding: 15px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
        }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row input { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; font-family: inherit; }
        
        .filter-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .chip {
            padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer;
            background: #334155; color: #cbd5e1; border: 1px solid transparent; white-space: nowrap; transition: 0.2s;
        }
        .chip.active { background: rgba(16, 185, 129, 0.2); border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .chip-count { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; }

        /* --- Cards --- */
        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .student-card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 16px; position: relative;
            cursor: pointer; transition: 0.2s; overflow: hidden;
        }
        .student-card:active { transform: scale(0.98); }
        .student-card.priority { border-left: 4px solid var(--danger); } 
        .student-card.done { border-left: 4px solid var(--primary); }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .st-name { font-size: 15px; font-weight: 600; color: white; margin: 0; }
        .st-date { font-size: 11px; color: #94a3b8; display: block; margin-top: 2px; }
        
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background: rgba(251, 191, 36, 0.15); color: var(--gold); }
        .badge-done { background: rgba(16, 185, 129, 0.15); color: var(--primary); }

        /* Progress Bar */
        .progress-area { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #cbd5e1; }
        .progress-track { flex: 1; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .score-preview { font-weight: bold; font-size: 12px; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(8px); overflow-y: auto; }
        .modal-content {
            background: #1e293b; margin: 20px auto; width: 95%; max-width: 700px;
            border-radius: 16px; border: 1px solid #334155; padding-bottom: 20px; 
            margin-bottom: 100px; animation: slideUp 0.3s ease-out; position: relative;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        /* Strict Mode Features CSS */
        .inspection-header {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            color: white; padding: 15px 20px; border-radius: 15px 15px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .inspection-label { font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap:5px; }

        .tabs-container { display: flex; background: #0f172a; padding: 5px; margin: 15px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 12px; color: #94a3b8; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .tab.active { background: #334155; color: white; font-weight: bold; }

        .tab-content { display: none; padding: 0 15px; }
        .tab-content.active { display: block; }

        /* Photo Grid Inspection */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            border: 1px solid #475569;
            background: #0f172a;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.3s;
            cursor: zoom-in;
        }

        .photo-item:hover img {
            transform: scale(1.05);
            opacity: 0.6;
        }

        .photo-label {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 10px;
            padding: 6px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }

        .img-fallback {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: #1e293b; color: #94a3b8;
            text-align: center; padding: 10px;
            font-size: 10px;
        }
        
        .no-photo-alert { grid-column: 1/-1; padding: 20px; text-align: center; background: rgba(239,68,68,0.1); border: 1px dashed var(--danger); color: var(--danger); font-size: 12px; border-radius: 8px; }

        /* Anomaly & Validation List */
        .validation-list { display: flex; flex-direction: column; gap: 8px; }
        .val-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; 
        }
        .val-info { display: flex; flex-direction: column; }
        .val-title { font-size: 13px; font-weight: 600; color: #e2e8f0; }
        .val-time { font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 5px; }
        
        .anomaly-badge { background: var(--danger); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.6;} 100% {opacity: 1;} }

        /* Custom Checkbox for Strict Checking */
        .check-box-wrapper { position: relative; }
        .check-input { display: none; }
        .check-label { 
            display: flex; align-items: center; gap: 6px; padding: 6px 12px; 
            background: #334155; border-radius: 20px; font-size: 11px; cursor: pointer; color: #cbd5e1; border: 1px solid #475569;
        }
        .check-input:checked + .check-label { background: var(--primary); color: white; border-color: var(--primary); }
        .check-input:checked + .check-label::before { content: 'âœ“'; font-weight: bold; }

        /* Grading Rubric */
        .rubric-container { background: #0f172a; border-radius: 12px; padding: 15px; border: 1px solid #334155; margin-top: 15px; }
        .rubric-row { margin-bottom: 12px; }
        .rubric-header { display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        .rubric-range { width: 100%; accent-color: var(--blue); height: 4px; }
        
        .final-score-box { 
            text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); 
            border: 1px dashed var(--primary); border-radius: 12px; margin: 15px 0;
        }
        .fs-val { font-size: 28px; font-weight: 800; color: var(--primary); display: block; }
        .fs-lbl { font-size: 11px; color: #94a3b8; text-transform: uppercase; }

        textarea {
            width: 100%; padding: 12px; background: #0f172a; border: 1px solid #475569;
            color: white; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 13px; margin-bottom: 10px; resize: vertical;
        }
        
        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-save:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background: #64748b; }

        .close-modal-btn { position: absolute; right: 15px; top: 15px; background: rgba(0,0,0,0.3); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 10; }
        
        #loading { text-align: center; padding: 40px; color: #94a3b8; font-size: 13px; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to {transform: rotate(360deg);} }

        .footer-fixed {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #020617; border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0; text-align: center; color: #94a3b8;
            font-size: 12px; z-index: 50;
        }

/* --- Summary Table --- */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 20px;
            background: #1e293b;
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            text-align: left;
        }
        .summary-table th {
            background: #0f172a;
            color: #94a3b8;
            padding: 12px 15px;
            font-weight: 600;
            border-bottom: 1px solid #334155;
            white-space: nowrap;
        }
        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #334155;
            color: #e2e8f0;
            white-space: nowrap;
        }
        .summary-table tbody tr {
            transition: background 0.2s;
        }
        .summary-table tbody tr:hover {
            background: rgba(255,255,255,0.05);
            cursor: pointer;
        }
        .summary-table tbody tr:last-child td {
            border-bottom: none;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }
        .status-belum { background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .status-sudah { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }

        
    </style>
</head>
<body>

<header>
    <div class="mentor-profile">
        <h2 id="mName">Pembimbing</h2>
        <span id="mGroup">Memuat...</span>
    </div>
    <button class="btn-logout" onclick="logout()">Keluar</button>
</header>

<div class="container">
    <div class="filter-container">
        <div class="filter-row">
            <input type="date" id="dateFilter" onchange="loadData()">
            <button onclick="loadData()" style="background:#334155; border:1px solid #475569; color:white; border-radius:8px; padding:0 15px; cursor:pointer; font-size:18px;">ğŸ”„</button>
        
        <div id="summaryTableWrapper" class="table-responsive" style="display: none;">
        <table class="summary-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Siswa</th>
                    <th>Isian Kegiatan</th>
                    <th>Status Penilaian</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
        </table>
    </div>
        
        </div>
        <div class="filter-chips">
            <div class="chip active" onclick="setFilter('all', this)">Semua <span class="chip-count" id="countAll">0</span></div>
            <div class="chip" onclick="setFilter('pending', this)">Perlu Pemeriksaan <span class="chip-count" id="countPending" style="background:var(--danger); color:white">0</span></div>
            <div class="chip" onclick="setFilter('done', this)">Selesai <span class="chip-count" id="countDone" style="background:var(--primary); color:white">0</span></div>
        </div>
    </div>

    <div id="loading"><div class="spinner"></div>Mengambil data laporan siswa...</div>
    <div id="studentList" class="card-list"></div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="closeModal()">&times;</div>
        
        <div class="inspection-header">
            <div>
                <div class="inspection-label">ğŸ›¡ï¸ MODE INSPEKSI PEMBIMBING</div>
                <h3 id="modalName" style="margin:5px 0 0; font-size:18px;">Nama Siswa</h3>
            </div>
            <div style="text-align:right">
                <small id="modalDate" style="opacity:0.8">Tanggal</small>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('check')">1. Validasi Kegiatan</div>
            <div class="tab" onclick="switchTab('gallery')">2. Cek Foto Bukti</div>
            <div class="tab" onclick="switchTab('grading')">3. Penilaian Akhir</div>
        </div>

        <div id="tab-check" class="tab-content active">
            <div style="margin-bottom:15px; background:rgba(59, 130, 246, 0.1); border:1px solid #3b82f6; padding:10px; border-radius:8px; font-size:12px; color:#93c5fd;">
                â„¹ï¸ <b>Instruksi:</b> Periksa jam pelaksanaan. Centang "Valid" jika waktu masuk akal. Sistem mendeteksi otomatis keterlambatan.
            </div>
            
            <div style="background:#0f172a; padding:10px; border-radius:8px; margin-bottom:15px; font-style:italic; border-left:3px solid #cbd5e1;">
                <span style="color:#64748b; font-size:10px;">Catatan Siswa:</span><br>
                <span id="modalCatatanSiswa" style="color:#f1f5f9; font-size:13px;">"-"</span>
            </div>

            <div class="validation-list" id="validationContainer"></div>
        </div>

        <div id="tab-gallery" class="tab-content">
            <div style="margin-bottom:10px; font-size:12px; color:#94a3b8; text-align:center;">
                Pastikan foto tidak gelap gulita, bukan foto karpet saja, dan bukan foto berulang.
            </div>
            <div id="photoGalleryContainer" class="photo-grid"></div>
        </div>

        <div id="tab-grading" class="tab-content">
            <div class="rubric-container">
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kedisiplinan Waktu (40%)</span>
                        <span id="valR1">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R1', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kelengkapan Bukti (30%)</span>
                        <span id="valR2">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R2', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kualitas Ibadah/Kejujuran (30%)</span>
                        <span id="valR3">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R3', this.value)">
                </div>
            </div>

            <div class="final-score-box">
                <span class="fs-lbl">Nilai Akhir Terhitung</span>
                <span class="fs-val" id="finalScoreDisplay">80</span>
            </div>

            <label style="font-size:12px; color:#94a3b8; display:block; margin-bottom:5px;">Evaluasi / Komentar Pembimbing:</label>
            <textarea id="inputCatatanPembimbing" rows="3" placeholder="Contoh: Sholat subuh terlalu siang, mohon diperbaiki besok..."></textarea>
            
            <button id="btnSave" class="btn-save" onclick="saveGrade()" disabled>ğŸ”’ SELESAIKAN VALIDASI DULU</button>
            <div style="text-align:center; font-size:10px; color:#64748b; margin-top:5px;">
                *Tombol aktif setelah melakukan validasi di Tab 1
            </div>
        </div>
    </div>
</div>

<div class="footer-fixed">
    &copy; 2026 E-KAROMAH App. Developer <a href="https://www.kangruli.web.id/" target="_blank">Kang Ruli</a>
</div>

<script>
// ================= CONFIG & SETUP =================
// âœ… PASTIKAN URL INI SUDAH YANG TERBARU (HASIL DEPLOY BARU)
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyq-CZX7ploDor-n5DmG0j987kYglYjmQnk0D4yy039pK00K2RVtL1N4wuYWhfi_ctNzg/exec"; 

const activityConfig = [
    { key: "Sahur", label: "Makan Sahur", hasPhoto: true, max: "04:30" },
    { key: "Subuh", label: "Sholat Subuh", hasPhoto: true, max: "05:15" },
    { key: "Dzuhur", label: "Sholat Dzuhur", hasPhoto: true, max: "13:00" },
    { key: "Ashar", label: "Sholat Ashar", hasPhoto: true, max: "16:00" },
    { key: "Buka", label: "Buka Puasa", hasPhoto: true, max: "18:30" },
    { key: "Magrib", label: "Sholat Magrib", hasPhoto: true, max: "18:45" },
    { key: "Isya", label: "Sholat Isya", hasPhoto: true, max: "20:00" },
    { key: "Tarawih", label: "Sholat Tarawih", hasPhoto: true, max: "21:00" },
    { key: "Tadarus", label: "Tadarus Quran", hasPhoto: true, max: null },
    { key: "Olahraga", label: "Olahraga", hasPhoto: true, max: null },
    { key: "Pesantren", label: "Kegiatan Pesantren", hasPhoto: true, max: null },
    { key: "Keluarga", label: "Bantu Orang Tua", hasPhoto: false, max: null }
];

// Global Variables
let rawData = [];
let selectedItem = null;
let currentFilterType = 'all';
let validationState = {}; 

// 1. CEK LOGIN
const user = JSON.parse(localStorage.getItem("user"));
if(!user || user.role !== 'pembimbing'){
    alert("â›” Akses Ditolak. Silakan login sebagai Pembimbing."); 
    window.location.href='index.html';
}

document.getElementById('mName').textContent = user.nama || "Pembimbing";
document.getElementById('mGroup').textContent = "Kelompok: " + (user.kelompok || "-");
document.getElementById('dateFilter').valueAsDate = new Date();

// ==========================================
// 2. HELPER FUNCTIONS
// ==========================================
function logout() {
    if(confirm("Yakin ingin keluar?")) {
        localStorage.removeItem("user");
        window.location.href = "index.html";
    }
}

function formatTglIndo(isoDate) {
    if(!isoDate) return "-";
    const d = new Date(isoDate);
    if(isNaN(d.getTime())) return isoDate; 
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return d.toLocaleDateString('id-ID', options);
}

// ==========================================
// 3. LOAD DATA (DENGAN FITUR MERGE & FIX TANGGAL)
// ==========================================
async function loadData() {
    const list = document.getElementById("studentList");
    const loader = document.getElementById("loading");
    const dateInput = document.getElementById("dateFilter").value;
    
    list.innerHTML = "";
    loader.style.display = "block";

    try {
        const url = `${WEB_APP_URL}?action=rekapPembimbing&kelompok=${encodeURIComponent(user.kelompok)}`;
        const res = await fetch(url);
        const data = await res.json();
        
        // --- 1. PROSES PENGGABUNGAN (MERGE) CICILAN ---
        let groupedData = {};
        
        data.forEach(item => {
            let namaSiswa = (item.Nama || item.nama || "").trim();
            let itemDate = "";

            // Perbaiki bug tanggal: Ambil tanggal di zona waktu WIB (Asia/Jakarta)
            if (item.Tanggal) {
                // Buat Date dari timestamp UTC, lalu ambil ke tanggal lokal WIB
                // Untuk tipe "YYYY-MM-DD" cukup pake split
                if (/^\d{4}-\d{2}-\d{2}/.test(item.Tanggal)) {
                    // Google Sheets kadang menyimpan tgl UTC (misal 2024-04-18T17:00:00.000Z, yg berarti WIB = 19)
                    // Jadi, parsing ISO string dan konversi ke waktu Asia/Jakarta
                    let tglObj;
                    // Cek apakah ada huruf "T", artinya ada time
                    if (item.Tanggal.includes("T")) {
                        try {
                            // Buat Date lalu ambil YMD di zona WIB
                            tglObj = new Date(item.Tanggal);
                            // Konversi ke string tanggal lokal di Asia/Jakarta
                            // NB: Date API JS hanya UTC/local browser, jadi pakai offset UTC+7
                            // Hitung: waktu timestamp + 7 jam (25200000 ms)
                            let tglWIBDate = new Date(tglObj.getTime() + (7 * 60 * 60 * 1000));
                            // Ambil tanggal YMD-nya
                            const year = tglWIBDate.getFullYear();
                            const month = String(tglWIBDate.getMonth() + 1).padStart(2, '0');
                            const day = String(tglWIBDate.getDate()).padStart(2, '0');
                            itemDate = `${year}-${month}-${day}`; 
                        } catch (e) {
                            // Jika parsing gagal, fallback
                            const d = new Date(item.Tanggal);
                            const year = d.getFullYear();
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            itemDate = `${year}-${month}-${day}`; 
                        }
                    } else {
                        // Sudah format YYYY-MM-DD, tidak perlu konversi jam
                        itemDate = item.Tanggal.substring(0,10);
                    }
                } else {
                    // Jika bukan format standar, fallback seperti sebelumnya
                    const d = new Date(item.Tanggal);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    itemDate = `${year}-${month}-${day}`; 
                }
            }
            
            let key = `${namaSiswa}_${itemDate}`;

            if (!groupedData[key]) {
                // Buat wadah baru jika belum ada kartu untuk siswa di tanggal tersebut
                groupedData[key] = { ...item };
                groupedData[key]._filterDate = itemDate; // Simpan tanggal bersih untuk filter
            } else {
                // Jika sudah ada, gabungkan isian aktivitasnya (cicilan)
                activityConfig.forEach(act => {
                    const statusSiswa = item[act.key] || item[act.key+'_Status'] || "";
                    if (String(statusSiswa).toLowerCase().includes('ya')) {
                        groupedData[key][act.key] = statusSiswa;
                        
                        const w1 = act.key + '_Waktu'; const w2 = 'Waktu_' + act.key;
                        if (item[w1] && item[w1] !== "-") groupedData[key][w1] = item[w1];
                        if (item[w2] && item[w2] !== "-") groupedData[key][w2] = item[w2];
                        
                        const f1 = act.key + '_Foto'; const f2 = 'Foto_' + act.key;
                        if (item[f1] && item[f1] !== "-") groupedData[key][f1] = item[f1];
                        if (item[f2] && item[f2] !== "-") groupedData[key][f2] = item[f2];
                    }
                });

                // Update ID baris ke yang terbaru agar saat dinilai masuk ke baris akhir
                if (item.id || item.row) {
                    groupedData[key].id = item.id || item.row;
                    groupedData[key].row = item.id || item.row;
                }

                // Gabungkan catatan siswa
                if(item.Catatan && item.Catatan !== "-" && String(item.Catatan).trim() !== "") {
                    if (!groupedData[key].Catatan || groupedData[key].Catatan === "-") {
                        groupedData[key].Catatan = item.Catatan;
                    } else if (!groupedData[key].Catatan.includes(item.Catatan)) {
                        groupedData[key].Catatan += " | " + item.Catatan;
                    }
                }

                // Cek jika di salah satu cicilan sudah dinilai pembimbing
                if (item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2) {
                    groupedData[key].Nilai_Pembimbing = item.Nilai_Pembimbing;
                }
            }
        });

        // Ubah kembali dari Objek menjadi Array
        let mergedArray = Object.values(groupedData);

        // --- 2. FILTER BERDASARKAN TANGGAL ---
        let myStudents = [];
        if(dateInput && mergedArray.length > 0) {
            myStudents = mergedArray.filter(item => item._filterDate === dateInput);
        } else {
            myStudents = mergedArray;
        }

        rawData = myStudents;
        updateCountChips(rawData);

        if(myStudents.length === 0) {
            loader.innerHTML = `<div style="padding:40px; text-align:center; color:#94a3b8">ğŸƒ Tidak ada laporan pada tanggal <b>${dateInput}</b>.</div>`;
            return;
        }

        renderList(rawData);
        loader.style.display = "none";

    } catch(e) {
        console.error(e);
        loader.innerHTML = `<div style="color:var(--danger); padding:20px; text-align:center;">Gagal memuat data.<br>Cek koneksi internet atau coba refresh.</div>`;
    }
}

function updateCountChips(data) {
    const pending = data.filter(item => !hasGrade(item)).length;
    const done = data.filter(item => hasGrade(item)).length;
    document.getElementById("countAll").textContent = data.length;
    document.getElementById("countPending").textContent = pending;
    document.getElementById("countDone").textContent = done;
}

function hasGrade(item){ 
    return item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2; 
}

function setFilter(type, el) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    currentFilterType = type;
    renderList(rawData);
}

function renderList(data) {
    const list = document.getElementById("studentList");
    const tableWrapper = document.getElementById("summaryTableWrapper");
    const tableBody = document.getElementById("summaryTableBody");
    
    list.innerHTML = "";
    
    // Cek apakah ada tabel (jika HTML tabel sudah dipasang)
    if (tableBody) tableBody.innerHTML = "";

    // Ambil input pencarian
    const searchInput = document.getElementById("searchName");
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

    let displayData = data;
    
    // 1. Filter by Tab
    if(currentFilterType === 'pending') displayData = data.filter(item => !hasGrade(item));
    else if(currentFilterType === 'done') displayData = data.filter(item => hasGrade(item));

    // 2. Filter by Search (Nama)
    if(searchTerm) {
        displayData = displayData.filter(item => {
            const namaSiswa = item.Nama || item.nama || "";
            return namaSiswa.toLowerCase().includes(searchTerm);
        });
    }

    // 3. Urutkan berdasarkan Nama Siswa (Sesuai Abjad A-Z)
    displayData.sort((a,b) => {
        const nameA = (a.Nama || a.nama || "").toLowerCase();
        const nameB = (b.Nama || b.nama || "").toLowerCase();
        return nameA.localeCompare(nameB);
    });

    if(displayData.length === 0) {
        if(tableWrapper) tableWrapper.style.display = "none";
        list.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8; font-size:13px;">Belum ada data laporan siswa / tidak ditemukan.</div>`;
        return;
    }

    if(tableWrapper) tableWrapper.style.display = "block";

    displayData.forEach((item, index) => {
        // --- Render isi Tabel ---
        if (tableBody) {
            let doneCount = 0;
            activityConfig.forEach(act => {
                const val = item[act.key] || item[act.key+'_Status'] || "";
                if(String(val).toLowerCase().includes('ya')) doneCount++;
            });
            
            const isDone = hasGrade(item);
            const statusHtml = isDone 
                ? `<span class="status-badge status-sudah">Sudah Dinilai (â­ ${item.Nilai_Pembimbing})</span>` 
                : `<span class="status-badge status-belum">Belum Dinilai</span>`;
                
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td style="font-weight: 600; color: white;">${item.Nama || item.nama}</td>
                <td>${doneCount} / ${activityConfig.length} Terisi</td>
                <td>${statusHtml}</td>
            `;
            tr.onclick = () => openInspectionMode(item);
            tableBody.appendChild(tr);
        }

        // --- Render Kartu ---
        list.appendChild(createCard(item));
    });
}

function createCard(item) {
    let doneCount = 0;
    activityConfig.forEach(act => {
        const val = item[act.key] || item[act.key+'_Status'] || "";
        if(String(val).toLowerCase().includes('ya')) doneCount++;
    });
    
    const totalActs = activityConfig.length;
    const progressPct = Math.round((doneCount / totalActs) * 100);
    const isDone = hasGrade(item);
    
    // Tampilan badge dengan Nilai Pembimbing
    const badgeHtml = isDone 
        ? `<span class="badge badge-done" style="background:var(--primary); color:white;">â­ NILAI: ${item.Nilai_Pembimbing}</span>` 
        : `<span class="badge badge-pending">PERLU INSPEKSI</span>`;

    const progressColor = progressPct >= 80 ? '#34d399' : (progressPct >= 50 ? '#fbbf24' : '#ef4444');

    const card = document.createElement("div");
    card.className = `student-card ${isDone ? 'done' : 'priority'}`;
    
    // Tampilan Catatan jika ada
    const catatanHtml = (isDone && item.Catatan_Pembimbing && item.Catatan_Pembimbing !== "-") 
        ? `<div style="margin-top:10px; background:rgba(0,0,0,0.2); padding:8px; border-radius:6px; font-size:11px; color:#cbd5e1; border-left:2px solid var(--primary);">ğŸ’¬ <i>${item.Catatan_Pembimbing}</i></div>`
        : ``;

    card.innerHTML = `
        <div class="card-top">
            <div>
                <h3 class="st-name">${item.Nama || item.nama}</h3>
                <span class="st-date">ğŸ“… ${formatTglIndo(item._filterDate || item.Tanggal)}</span>
            </div>
            ${badgeHtml}
        </div>
        <div class="progress-area">
            <span>Isian: ${doneCount}/${totalActs}</span>
            <div class="progress-track">
                <div class="progress-fill" style="width: ${progressPct}%; background:${progressColor}"></div>
            </div>
            <span class="score-preview" style="color:${progressColor}">${progressPct}%</span>
        </div>
        ${catatanHtml}
    `;
    card.onclick = () => openInspectionMode(item);
    return card;
}

// ==========================================
// 4. INSPECTION MODE & MODAL
// ==========================================
function openInspectionMode(item) {
    selectedItem = item;
    validationState = {}; 

    document.getElementById("modalName").textContent = item.Nama || item.nama;
    document.getElementById("modalDate").textContent = formatTglIndo(item._filterDate || item.Tanggal);
    document.getElementById("modalCatatanSiswa").textContent = item.Catatan ? `"${item.Catatan}"` : "-";

    renderValidationList(item);
    renderPhotoGallery(item);
    setupGrading(item);

    switchTab('check'); 
    checkValidationCompletion();
    document.getElementById("detailModal").style.display = "block";
}

function closeModal() {
    document.getElementById("detailModal").style.display = "none";
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    const tabs = document.querySelectorAll('.tab');
    if(tabName === 'check') tabs[0].classList.add('active');
    if(tabName === 'gallery') tabs[1].classList.add('active');
    if(tabName === 'grading') tabs[2].classList.add('active');

    document.getElementById(`tab-${tabName}`).classList.add('active');
}

// ==========================================
// 5. VALIDATION LIST LOGIC
// ==========================================
function renderValidationList(item) {
    const container = document.getElementById("validationContainer");
    container.innerHTML = "";

    activityConfig.forEach(act => {
        const status = item[act.key] || item[act.key+'_Status'] || "-";
        let rawWaktu = item[act.key+'_Waktu'] || item['Waktu_'+act.key] || "-";
        
        // --- PERBAIKAN: Parsing Format Date Google Sheets (1899-12-30T05:13...) ---
        let waktu = rawWaktu;
        if (String(waktu).includes('T')) {
            try {
                // Ambil string jam yang terletak setelah huruf 'T'
                waktu = String(waktu).split('T')[1].substring(0, 5); 
            } catch(e) {
                console.warn("Gagal mengekstrak waktu:", rawWaktu);
            }
        }
        
        const isYa = String(status).toLowerCase().includes("ya");

        let anomalyHtml = "";
        let timeColor = "#94a3b8";

        if(isYa && act.max && waktu !== "-") {
            const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if(timePattern.test(waktu)) {
                if(waktu > act.max) {
                    anomalyHtml = `<span class="anomaly-badge">âš ï¸ Terlambat (Batas: ${act.max})</span>`;
                    timeColor = "#ef4444";
                }
            }
        }

        const needsCheck = isYa; 
        const checkId = `chk_${act.key}`;
        
        // Jika belum "ya" (belum dikerjakan/dicicil)
Â  Â  Â  Â  const isYaHtml = isYa ? `<span style="color:#10b981; font-weight:bold; font-size:11px;">âœ… Selesai</span>` : `<span style="color:#64748b; font-size:11px;">âŒ Belum/Tidak</span>`;
Â  Â  Â  Â  let checkBoxHtml = "";

Â  Â  Â  Â  // Jika siswa menyatakan "ya", tampilkan checkbox validasi untuk pembimbing
Â  Â  Â  Â  if (needsCheck) {
Â  Â  Â  Â  Â  Â  checkBoxHtml = `
Â  Â  Â  Â  Â  Â  <div class="check-box-wrapper">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="${checkId}" class="check-input" onchange="handleValidationChange('${act.key}', this.checked)">
Â  Â  Â  Â  Â  Â  Â  Â  <label for="${checkId}" class="check-label">Valid</label>
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  checkBoxHtml = `<span style="font-size:11px; color:#64748b; padding: 6px 12px; background: #1e293b; border-radius: 20px;">Lewati</span>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  div.className = "val-item";
Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="val-info">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="val-title">${act.label} ${isYaHtml}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <span class="val-time" style="color:${timeColor}">â° Pukul: ${waktu} ${anomalyHtml}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  ${checkBoxHtml}
Â  Â  Â  Â  `;
Â  Â  Â  Â  container.appendChild(div);
Â  Â  });
}

// ==========================================
// 6. VALIDATION LOGIC & ENABLE SAVE BUTTON
// ==========================================
function handleValidationChange(key, isChecked) {
Â  Â  validationState[key] = isChecked;
Â  Â  checkValidationCompletion();
}

function checkValidationCompletion() {
Â  Â  let requiredCount = 0;
Â  Â  let checkedCount = 0;

Â  Â  activityConfig.forEach(act => {
Â  Â  Â  Â  const status = selectedItem[act.key] || selectedItem[act.key+'_Status'] || "";
Â  Â  Â  Â  if (String(status).toLowerCase().includes("ya")) {
Â  Â  Â  Â  Â  Â  requiredCount++;
Â  Â  Â  Â  Â  Â  if (validationState[act.key]) checkedCount++;
Â  Â  Â  Â  }
Â  Â  });

Â  Â  const btnSave = document.getElementById("btnSave");
Â  Â  // Jika semua yang perlu divalidasi sudah di-check
Â  Â  if (requiredCount === 0 || checkedCount === requiredCount) {
Â  Â  Â  Â  btnSave.disabled = false;
Â  Â  Â  Â  btnSave.innerHTML = "ğŸ’¾ SIMPAN & SELESAIKAN PENILAIAN";
Â  Â  Â  Â  btnSave.style.background = "var(--primary)";
Â  Â  } else {
Â  Â  Â  Â  btnSave.disabled = true;
Â  Â  Â  Â  btnSave.innerHTML = `ğŸ”’ SELESAIKAN VALIDASI DI TAB 1 (${checkedCount}/${requiredCount})`;
Â  Â  Â  Â  btnSave.style.background = "#64748b";
Â  Â  }
}

// ==========================================
// 7. RENDER PHOTO GALLERY
// ==========================================
function renderPhotoGallery(item) {
Â  Â  const container = document.getElementById("photoGalleryContainer");
Â  Â  container.innerHTML = "";
Â  Â  let hasPhoto = false;

Â  Â  activityConfig.forEach(act => {
Â  Â  Â  Â  if (act.hasPhoto) {
Â  Â  Â  Â  Â  Â  const f1 = act.key + '_Foto'; 
            const f2 = 'Foto_' + act.key;
Â  Â  Â  Â  Â  Â  let photoUrl = item[f1] || item[f2] || "";
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (photoUrl && photoUrl !== "-" && photoUrl.includes("http")) {
Â  Â  Â  Â  Â  Â  Â  Â  hasPhoto = true;
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement("div");
Â  Â  Â  Â  Â  Â  Â  Â  div.className = "photo-item";
Â  Â  Â  Â  Â  Â  Â  Â  div.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${photoUrl}" alt="${act.label}" onclick="window.open('${photoUrl}', '_blank')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="photo-label">${act.label}</div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  });

Â  Â  if (!hasPhoto) {
Â  Â  Â  Â  container.innerHTML = `<div class="no-photo-alert">Siswa tidak melampirkan foto bukti atau link tidak valid.</div>`;
Â  Â  }
}

// ==========================================
// 8. GRADING & RUBRIC LOGIC
// ==========================================
function setupGrading(item) {
Â  Â  // Set default value slider
Â  Â  document.querySelectorAll('.rubric-range').forEach(el => el.value = 80);
Â  Â  updateRubric('R1', 80);
Â  Â  updateRubric('R2', 80);
Â  Â  updateRubric('R3', 80);
Â  Â  
    // Load catatan jika sudah pernah ada
    document.getElementById("inputCatatanPembimbing").value = item.Catatan_Pembimbing || "";
}

function updateRubric(id, val) {
Â  Â  document.getElementById(`val${id}`).textContent = val;
Â  Â  calculateFinalScore();
}

function calculateFinalScore() {
Â  Â  const r1 = parseInt(document.getElementById("valR1").textContent) || 0; // Kedisiplinan 40%
Â  Â  const r2 = parseInt(document.getElementById("valR2").textContent) || 0; // Bukti 30%
Â  Â  const r3 = parseInt(document.getElementById("valR3").textContent) || 0; // Kejujuran 30%
Â  Â  
Â  Â  const totalScore = Math.round((r1 * 0.4) + (r2 * 0.3) + (r3 * 0.3));
Â  Â  document.getElementById("finalScoreDisplay").textContent = totalScore;
Â  Â  return totalScore;
}

// ==========================================
// 9. SAVE DATA TO GOOGLE SHEETS
// ==========================================
async function saveGrade() {
Â  Â  const btnSave = document.getElementById("btnSave");
Â  Â  const finalScore = calculateFinalScore();
Â  Â  const catatan = document.getElementById("inputCatatanPembimbing").value;

Â  Â  if (!selectedItem.row && !selectedItem.id) {
Â  Â  Â  Â  alert("Error: ID Baris (Row) tidak ditemukan.");
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  btnSave.disabled = true;
Â  Â  btnSave.innerHTML = `<div class="spinner" style="width:16px; height:16px; display:inline-block; margin:0 5px -3px 0;"></div> MENYIMPAN...`;

Â  Â  try {
Â  Â  Â  Â  // Kirim form data sesuai standar Google Apps Script doPost
Â  Â  Â  Â  const formData = new URLSearchParams();
Â  Â  Â  Â  formData.append("action", "nilaiPembimbing");
Â  Â  Â  Â  formData.append("row", selectedItem.row || selectedItem.id);
Â  Â  Â  Â  formData.append("nilai", finalScore);
Â  Â  Â  Â  formData.append("catatan", catatan);

Â  Â  Â  Â  const response = await fetch(WEB_APP_URL, {
Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  body: formData
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  
Â  Â  Â  Â  if (result.status === 'success' || result.sukses) {
Â  Â  Â  Â  Â  Â  alert("âœ… Penilaian berhasil disimpan!");
Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  Â  loadData(); // Auto-refresh data agar pindah ke tab "Selesai"
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  alert("Gagal menyimpan data: " + (result.message || "Unknown error"));
Â  Â  Â  Â  Â  Â  btnSave.disabled = false;
Â  Â  Â  Â  Â  Â  btnSave.innerHTML = "ğŸ’¾ COBA LAGI";
Â  Â  Â  Â  }
Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error saving grade:", e);
Â  Â  Â  Â  alert("âš ï¸ Terjadi kesalahan jaringan. Cek koneksi internetmu.");
Â  Â  Â  Â  btnSave.disabled = false;
Â  Â  Â  Â  btnSave.innerHTML = "ğŸ’¾ COBA LAGI";
Â  Â  }
}

// ==========================================
// 10. INISIALISASI AWAL
// ==========================================
window.onload = function() {
Â  Â  loadData();
};
</script>
</body>
</html>
