<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Pembimbing - E-KAROMAH</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #059669;
            --primary-hover: #047857;
            --secondary: #3b82f6;
            --bg-base: #0f172a; 
            --bg-surface: #1e293b;
            --bg-surface-hover: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #dc2626;
            --warning: #d97706;
            --success: #10b981;
            --border: #334155;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: var(--bg-base);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* --- Header --- */
        header {
            background: var(--bg-surface);
            padding: 16px 24px;
            position: sticky; top: 0; z-index: 40;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .mentor-profile h2 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text-main); }
        .mentor-profile span { font-size: 12px; color: var(--text-muted); font-weight: 500; }
        .btn-logout { 
            background: transparent; border: 1px solid var(--danger); color: var(--danger); 
            padding: 6px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: 0.2s;
        }
        .btn-logout:hover { background: var(--danger); color: white; }

        .container { max-width: 860px; margin: 24px auto; padding: 0 16px; }

        /* --- Notice Board --- */
        .notice-board {
            margin-bottom: 24px; padding: 16px; border-radius: 8px; font-size: 14px; line-height: 1.5;
            border-left: 4px solid transparent; display: none;
        }
        .notice-title { font-weight: 600; margin-bottom: 4px; font-size: 15px; }
        .notice-quote { font-style: italic; color: var(--text-muted); font-size: 13px; margin-bottom: 8px; display: block; }

        /* --- Filter Area --- */
        .filter-container {
            background: var(--bg-surface); padding: 16px; border-radius: 8px;
            margin-bottom: 24px; border: 1px solid var(--border);
        }
        .filter-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; display: flex; gap: 8px; }
        .filter-row input { 
            width: 100%; background: var(--bg-base); border: 1px solid var(--border); 
            color: var(--text-main); padding: 10px 12px; border-radius: 6px; font-family: inherit; font-size: 14px;
        }
        .filter-row input:focus { outline: none; border-color: var(--secondary); }
        .btn-refresh {
            background: var(--bg-surface-hover); border: 1px solid var(--border); color: var(--text-main); 
            border-radius: 6px; padding: 0 16px; cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s;
        }
        .btn-refresh:hover { background: var(--border); }
        
        .filter-chips { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; }
        .chip {
            padding: 6px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; font-weight: 500;
            background: var(--bg-base); color: var(--text-muted); border: 1px solid var(--border); white-space: nowrap; transition: 0.2s;
        }
        .chip.active { background: rgba(5, 150, 105, 0.1); border-color: var(--primary); color: var(--success); }
        .chip-count { background: var(--border); padding: 2px 8px; border-radius: 12px; font-size: 11px; margin-left: 6px; color: var(--text-main); }
        .chip.active .chip-count { background: var(--primary); }

        /* --- Table & Cards --- */
        .table-responsive {
            overflow-x: auto; margin-bottom: 24px; background: var(--bg-surface);
            border-radius: 8px; border: 1px solid var(--border);
        }
        .summary-table { width: 100%; border-collapse: collapse; font-size: 14px; text-align: left; }
        .summary-table th { background: var(--bg-base); color: var(--text-muted); padding: 14px 16px; font-weight: 600; border-bottom: 1px solid var(--border); }
        .summary-table td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: var(--text-main); }
        .summary-table tbody tr:hover { background: var(--bg-surface-hover); cursor: pointer; }
        
        .status-badge { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status-belum { background: rgba(220, 38, 38, 0.1); color: #f87171; }
        .status-sudah { background: rgba(16, 185, 129, 0.1); color: #34d399; }

        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .student-card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: 8px; padding: 16px; cursor: pointer; transition: 0.2s;
        }
        .student-card:hover { border-color: var(--text-muted); }
        .student-card.priority { border-left: 4px solid var(--warning); } 
        .student-card.done { border-left: 4px solid var(--primary); }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .st-name { font-size: 16px; font-weight: 600; margin: 0; }
        .st-date { font-size: 12px; color: var(--text-muted); display: block; margin-top: 4px; }
        
        /* Progress Bar */
        .progress-area { display: flex; align-items: center; gap: 12px; font-size: 12px; color: var(--text-muted); }
        .progress-track { flex: 1; height: 6px; background: var(--bg-base); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; }

        /* --- Modal (Panel Verifikasi) --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px); overflow-y: auto; }
        .modal-content {
            background: var(--bg-base); margin: 32px auto; width: 95%; max-width: 760px;
            border-radius: 12px; border: 1px solid var(--border); padding-bottom: 24px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); animation: slideIn 0.2s ease-out;
        }
        @keyframes slideIn { from {transform: translateY(10px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .inspection-header {
            background: var(--bg-surface); padding: 20px 24px; border-radius: 12px 12px 0 0;
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
        }
        .inspection-label { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }

        .tabs-container { display: flex; background: var(--bg-surface); padding: 4px; margin: 20px 24px; border-radius: 6px; border: 1px solid var(--border); }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 13px; color: var(--text-muted); cursor: pointer; border-radius: 4px; transition: 0.2s; font-weight: 500; }
        .tab.active { background: var(--bg-surface-hover); color: var(--text-main); }

        .tab-content { display: none; padding: 0 24px; }
        .tab-content.active { display: block; }

        /* Validation List */
        .validation-list { display: flex; flex-direction: column; gap: 10px; }
        .val-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 14px 16px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; 
        }
        .val-title { font-size: 14px; font-weight: 500; }
        .val-time { font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 8px; }
        .anomaly-badge { background: rgba(220, 38, 38, 0.1); color: #f87171; border: 1px solid #f87171; font-size: 11px; padding: 2px 8px; border-radius: 4px; font-weight: 500; }

        .check-box-wrapper { position: relative; }
        .check-input { display: none; }
        .check-label { 
            display: flex; align-items: center; gap: 6px; padding: 8px 16px; 
            background: var(--bg-base); border-radius: 6px; font-size: 12px; cursor: pointer; color: var(--text-muted); border: 1px solid var(--border); font-weight: 500; transition: 0.2s;
        }
        .check-input:checked + .check-label { background: rgba(16, 185, 129, 0.1); color: var(--success); border-color: var(--success); }

        /* Photo Grid */
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 16px; margin-top: 16px; }
        .photo-item { position: relative; border-radius: 6px; overflow: hidden; aspect-ratio: 1; border: 1px solid var(--border); background: var(--bg-surface); }
        .photo-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; cursor: zoom-in; }
        .photo-item:hover img { opacity: 0.7; }
        .photo-label { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(15, 23, 42, 0.9); padding: 8px; text-align: center; font-size: 11px; }

        /* Grading Rubric */
        .rubric-container { background: var(--bg-surface); border-radius: 8px; padding: 20px; border: 1px solid var(--border); }
        .rubric-row { margin-bottom: 20px; }
        .rubric-row:last-child { margin-bottom: 0; }
        .rubric-header { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-muted); margin-bottom: 8px; font-weight: 500; }
        .score-display { background: var(--bg-base); padding: 2px 10px; border-radius: 4px; color: var(--text-main); border: 1px solid var(--border); }
        
        .rubric-range { width: 100%; accent-color: var(--secondary); height: 6px; cursor: pointer; }
        
        .final-score-box { text-align: center; padding: 20px; background: var(--bg-surface); border: 1px solid var(--border); border-radius: 8px; margin: 20px 0; }
        .fs-val { font-size: 32px; font-weight: 700; color: var(--success); display: block; margin-top: 4px; }

        textarea { width: 100%; padding: 14px; background: var(--bg-base); border: 1px solid var(--border); color: white; border-radius: 6px; box-sizing: border-box; font-family: inherit; font-size: 14px; margin-bottom: 16px; resize: vertical; outline: none; }
        textarea:focus { border-color: var(--secondary); }
        
        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; transition: 0.2s; }
        .btn-save:hover { background: var(--primary-hover); }
        .btn-save:disabled { background: var(--bg-surface-hover); color: var(--text-muted); cursor: not-allowed; }

        .close-modal-btn { position: absolute; right: 24px; top: 24px; font-size: 24px; color: var(--text-muted); cursor: pointer; line-height: 1; transition: 0.2s; }
        .close-modal-btn:hover { color: white; }
        
        #loading { text-align: center; padding: 60px 20px; color: var(--text-muted); font-size: 14px; }
    </style>
</head>
<body>

<header>
    <div class="mentor-profile">
        <h2 id="mName">Memuat Nama...</h2>
        <span id="mGroup">Kelompok: -</span>
    </div>
    <button class="btn-logout" onclick="logout()">Keluar</button>
</header>

<div class="container">
    <div id="mentorNotification" class="notice-board"></div>
    
    <div class="filter-container">
        <div class="filter-row">
            <div class="input-group">
                <input type="text" id="searchName" placeholder="Cari nama siswa..." oninput="renderList(rawData)">
                <input type="date" id="dateFilter" onchange="loadData()">
            </div>
            <button class="btn-refresh" onclick="loadData()">Muat Ulang</button>
        </div>
        <div class="filter-chips">
            <div class="chip active" onclick="setFilter('all', this)">Semua <span class="chip-count" id="countAll">0</span></div>
            <div class="chip" onclick="setFilter('pending', this)">Perlu Verifikasi <span class="chip-count" id="countPending">0</span></div>
            <div class="chip" onclick="setFilter('done', this)">Selesai <span class="chip-count" id="countDone">0</span></div>
        </div>
    </div>

    <div id="summaryTableWrapper" class="table-responsive" style="display: none;">
        <table class="summary-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Siswa</th>
                    <th>Aktivitas Terisi</th>
                    <th>Status Verifikasi</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
        </table>
    </div>

    <div id="loading">Memuat data laporan harian siswa...</div>
    <div id="studentList" class="card-list"></div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="closeModal()">&times;</div>
        
        <div class="inspection-header">
            <div>
                <div class="inspection-label">Panel Verifikasi Laporan</div>
                <h3 id="modalName" style="margin:0; font-size:20px; font-weight:600;">Nama Siswa</h3>
            </div>
            <div style="text-align:right">
                <span id="modalDate" style="color:var(--text-muted); font-size:13px;">Tanggal</span>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('check')">1. Validasi Waktu</div>
            <div class="tab" onclick="switchTab('gallery')">2. Bukti Visual</div>
            <div class="tab" onclick="switchTab('grading')">3. Evaluasi & Nilai</div>
        </div>

        <div id="tab-check" class="tab-content active">
            <div style="margin-bottom:20px; background:var(--bg-surface); padding:16px; border-radius:8px; border-left:3px solid var(--secondary);">
                <span style="color:var(--text-muted); font-size:11px; text-transform:uppercase; letter-spacing:0.5px;">Catatan Pribadi Siswa:</span><br>
                <span id="modalCatatanSiswa" style="color:var(--text-main); font-size:14px; margin-top:4px; display:block;">"-"</span>
            </div>
            <div class="validation-list" id="validationContainer"></div>
        </div>

        <div id="tab-gallery" class="tab-content">
            <p style="font-size:13px; color:var(--text-muted); margin-top:0;">Klik pada gambar untuk memperbesar resolusi.</p>
            <div id="photoGalleryContainer" class="photo-grid"></div>
        </div>

        <div id="tab-grading" class="tab-content">
            <div class="rubric-container">
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kedisiplinan Waktu (40%)</span>
                        <span class="score-display" id="valR1">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" step="5" value="80" oninput="updateRubric('R1', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kelengkapan Bukti (30%)</span>
                        <span class="score-display" id="valR2">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" step="5" value="80" oninput="updateRubric('R2', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kualitas Ibadah (30%)</span>
                        <span class="score-display" id="valR3">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" step="5" value="80" oninput="updateRubric('R3', this.value)">
                </div>
            </div>

            <div class="final-score-box">
                <span style="font-size:12px; color:var(--text-muted); text-transform:uppercase;">Skor Akhir Sistem</span>
                <span class="fs-val" id="finalScoreDisplay">80</span>
            </div>

            <label style="font-size:13px; color:var(--text-main); font-weight:500; display:block; margin-bottom:8px;">Catatan & Evaluasi Pembimbing (Opsional):</label>
            <textarea id="inputCatatanPembimbing" rows="3" placeholder="Berikan umpan balik atau motivasi untuk ananda..."></textarea>
            
            <button id="btnSave" class="btn-save" onclick="saveGrade()" disabled>Validasi Tab 1 Terlebih Dahulu</button>
        </div>
    </div>
</div>

<script>
// ================= SCRIPT LOGIC (Refined) =================
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyq-CZX7ploDor-n5DmG0j987kYglYjmQnk0D4yy039pK00K2RVtL1N4wuYWhfi_ctNzg/exec"; 

const activityConfig = [
    { key: "Sahur", label: "Makan Sahur", hasPhoto: true, max: "04:30" },
    { key: "Subuh", label: "Sholat Subuh", hasPhoto: true, max: "05:15" },
    { key: "Dzuhur", label: "Sholat Dzuhur", hasPhoto: true, max: "13:00" },
    { key: "Ashar", label: "Sholat Ashar", hasPhoto: true, max: "16:00" },
    { key: "Buka", label: "Buka Puasa", hasPhoto: true, max: "18:30" },
    { key: "Magrib", label: "Sholat Magrib", hasPhoto: true, max: "18:45" },
    { key: "Isya", label: "Sholat Isya", hasPhoto: true, max: "20:00" },
    { key: "Tarawih", label: "Sholat Tarawih", hasPhoto: true, max: "21:00" },
    { key: "Tadarus", label: "Tadarus Quran", hasPhoto: true, max: null },
    { key: "Olahraga", label: "Olahraga", hasPhoto: true, max: null },
    { key: "Pesantren", label: "Kegiatan Pesantren", hasPhoto: true, max: null },
    { key: "Keluarga", label: "Bantu Orang Tua", hasPhoto: false, max: null }
];

let rawData = [];
let selectedItem = null;
let currentFilterType = 'all';
let validationState = {}; 

const user = JSON.parse(localStorage.getItem("user"));
if(!user || user.role !== 'pembimbing'){
    alert("Akses Ditolak. Silakan login sebagai Pembimbing."); 
    window.location.href='index.html';
}

document.getElementById('mName').textContent = user.nama || "Pembimbing Akademik";
document.getElementById('mGroup').textContent = "Kelompok: " + (user.kelompok || "-");
document.getElementById('dateFilter').valueAsDate = new Date();

function logout() {
    if(confirm("Apakah Anda yakin ingin keluar dari sesi ini?")) {
        localStorage.removeItem("user");
        window.location.href = "index.html";
    }
}

function formatTglIndo(isoDate) {
    if(!isoDate) return "-";
    const d = new Date(isoDate);
    if(isNaN(d.getTime())) return isoDate; 
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return d.toLocaleDateString('id-ID', options);
}

async function loadData() {
    const loader = document.getElementById("loading");
    const dateInput = document.getElementById("dateFilter").value;
    
    document.getElementById("studentList").innerHTML = "";
    document.getElementById("summaryTableWrapper").style.display = "none";
    loader.style.display = "block";

    try {
        const url = `${WEB_APP_URL}?action=rekapPembimbing&kelompok=${encodeURIComponent(user.kelompok)}`;
        const res = await fetch(url);
        const data = await res.json();
        
        let groupedData = {};
        
        data.forEach(item => {
            let namaSiswa = (item.Nama || item.nama || "").trim();
            let itemDate = item.Tanggal ? (item.Tanggal.includes("T") ? item.Tanggal.substring(0,10) : item.Tanggal) : "";
            let key = `${namaSiswa}_${itemDate}`;

            if (!groupedData[key]) {
                groupedData[key] = { ...item };
                groupedData[key]._filterDate = itemDate;
            } else {
                activityConfig.forEach(act => {
                    const statusSiswa = item[act.key] || item[act.key+'_Status'] || "";
                    if (String(statusSiswa).toLowerCase().includes('ya')) {
                        groupedData[key][act.key] = statusSiswa;
                        if (item[act.key+'_Waktu'] && item[act.key+'_Waktu'] !== "-") groupedData[key][act.key+'_Waktu'] = item[act.key+'_Waktu'];
                        if (item[act.key+'_Foto'] && item[act.key+'_Foto'] !== "-") groupedData[key][act.key+'_Foto'] = item[act.key+'_Foto'];
                    }
                });
                if(item.Catatan && item.Catatan !== "-") groupedData[key].Catatan = item.Catatan;
                if(item.id || item.row) groupedData[key].row = item.id || item.row;
            }
        });

        rawData = Object.values(groupedData).filter(item => item._filterDate === dateInput);
        updateCountChips(rawData);

        if(rawData.length === 0) {
            loader.innerHTML = `Data tidak ditemukan untuk tanggal <b>${dateInput}</b>.`;
            return;
        }

        renderList(rawData);
        loader.style.display = "none";

    } catch(e) {
        loader.innerHTML = `<span style="color:var(--danger)">Gagal memuat data. Periksa koneksi internet Anda.</span>`;
    }
}

function updateCountChips(data) {
    const pending = data.filter(item => !hasGrade(item)).length;
    const done = data.filter(item => hasGrade(item)).length;
    
    document.getElementById("countAll").textContent = data.length;
    document.getElementById("countPending").textContent = pending;
    document.getElementById("countDone").textContent = done;

    const notifBox = document.getElementById("mentorNotification");
    if (data.length === 0) return notifBox.style.display = "none";

    notifBox.style.display = "block";
    
    if (pending > 0) {
        notifBox.style.borderColor = "var(--warning)";
        notifBox.style.background = "rgba(217, 119, 6, 0.1)";
        notifBox.innerHTML = `
            <div class="notice-title" style="color: var(--warning)">Terdapat ${pending} Laporan Tertunda</div>
            <span class="notice-quote">"Sesungguhnya Allah menyuruh kamu menyampaikan amanah kepada yang berhak menerimanya..." (QS. An-Nisa: 58)</span>
            Mohon luangkan waktu untuk memverifikasi dan mengevaluasi laporan ibadah ananda hari ini.
        `;
    } else {
        notifBox.style.borderColor = "var(--success)";
        notifBox.style.background = "rgba(16, 185, 129, 0.1)";
        notifBox.innerHTML = `
            <div class="notice-title" style="color: var(--success)">Semua Tugas Telah Diverifikasi</div>
            <span class="notice-quote">"Barangsiapa yang menunjuki kepada kebaikan maka dia akan mendapatkan pahala..." (HR. Muslim)</span>
            Terima kasih atas dedikasi Anda. Seluruh laporan hari ini telah berhasil dievaluasi.
        `;
    }
}

function hasGrade(item) { return item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2; }

function setFilter(type, el) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    currentFilterType = type;
    renderList(rawData);
}

function renderList(data) {
    const list = document.getElementById("studentList");
    const tableBody = document.getElementById("summaryTableBody");
    const searchTerm = (document.getElementById("searchName").value || "").toLowerCase();

    list.innerHTML = "";
    tableBody.innerHTML = "";

    let displayData = data.filter(item => {
        const matchName = (item.Nama || item.nama || "").toLowerCase().includes(searchTerm);
        if(currentFilterType === 'pending') return matchName && !hasGrade(item);
        if(currentFilterType === 'done') return matchName && hasGrade(item);
        return matchName;
    }).sort((a,b) => (a.Nama || "").localeCompare(b.Nama || ""));

    if(displayData.length === 0) {
        document.getElementById("summaryTableWrapper").style.display = "none";
        list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted);">Tidak ada data yang sesuai kriteria.</div>`;
        return;
    }

    document.getElementById("summaryTableWrapper").style.display = "block";

    displayData.forEach((item, index) => {
        let doneCount = activityConfig.filter(act => String(item[act.key] || "").toLowerCase().includes('ya')).length;
        const statusHtml = hasGrade(item) 
            ? `<span class="status-badge status-sudah">Dinilai (${item.Nilai_Pembimbing})</span>` 
            : `<span class="status-badge status-belum">Menunggu</span>`;
            
        // Render Table Row
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${index + 1}</td><td style="font-weight:500;">${item.Nama || item.nama}</td><td>${doneCount}/${activityConfig.length}</td><td>${statusHtml}</td>`;
        tr.onclick = () => openInspectionMode(item);
        tableBody.appendChild(tr);

        // Render Card (Mobile Friendly)
        const pct = Math.round((doneCount / activityConfig.length) * 100);
        const color = pct >= 80 ? 'var(--success)' : (pct >= 50 ? 'var(--warning)' : 'var(--danger)');
        const card = document.createElement("div");
        card.className = `student-card ${hasGrade(item) ? 'done' : 'priority'}`;
        card.innerHTML = `
            <div class="card-top">
                <div><h3 class="st-name">${item.Nama || item.nama}</h3><span class="st-date">${formatTglIndo(item._filterDate)}</span></div>
                ${statusHtml}
            </div>
            <div class="progress-area">
                <span>Progress: ${doneCount}/${activityConfig.length}</span>
                <div class="progress-track"><div class="progress-fill" style="width: ${pct}%; background:${color}"></div></div>
                <span style="color:${color}; font-weight:600;">${pct}%</span>
            </div>
        `;
        card.onclick = () => openInspectionMode(item);
        list.appendChild(card);
    });
}

function openInspectionMode(item) {
    selectedItem = item;
    validationState = {}; 
    document.getElementById("modalName").textContent = item.Nama || item.nama;
    document.getElementById("modalDate").textContent = formatTglIndo(item._filterDate);
    document.getElementById("modalCatatanSiswa").textContent = item.Catatan ? `"${item.Catatan}"` : "Tidak ada catatan.";

    renderValidationList(item);
    renderPhotoGallery(item);
    setupGrading(item);

    switchTab('check'); 
    checkValidationCompletion();
    document.getElementById("detailModal").style.display = "block";
}

function closeModal() { document.getElementById("detailModal").style.display = "none"; }

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    document.getElementById(`tab-${tabName}`).classList.add('active');
}

function renderValidationList(item) {
    const container = document.getElementById("validationContainer");
    container.innerHTML = "";

    activityConfig.forEach(act => {
        const status = item[act.key] || item[act.key+'_Status'] || "";
        const isYa = String(status).toLowerCase().includes("ya");
        let waktu = item[act.key+'_Waktu'] || item['Waktu_'+act.key] || "-";
        if (waktu.includes('T')) waktu = waktu.split('T')[1].substring(0, 5); 

        let anomalyHtml = "", timeColor = "var(--text-muted)";
        if(isYa && act.max && waktu !== "-" && waktu > act.max) {
            anomalyHtml = `<span class="anomaly-badge">Terlambat (Batas: ${act.max})</span>`;
            timeColor = "var(--danger)";
        }

        const chkId = `chk_${act.key}`;
        const actionHtml = isYa 
            ? `<div class="check-box-wrapper"><input type="checkbox" id="${chkId}" class="check-input" onchange="handleValidationChange('${act.key}', this.checked)"><label for="${chkId}" class="check-label">Validasi</label></div>`
            : `<span style="font-size:12px; color:var(--text-muted); background:var(--bg-base); padding:6px 12px; border-radius:6px; border:1px solid var(--border);">Abaikan</span>`;

        container.insertAdjacentHTML('beforeend', `
            <div class="val-item">
                <div>
                    <div class="val-title" style="color:${isYa ? 'var(--text-main)' : 'var(--text-muted)'}">${act.label} ${isYa ? 'âœ“' : ''}</div>
                    <div class="val-time" style="color:${timeColor}">Pukul: ${waktu} ${anomalyHtml}</div>
                </div>
                ${actionHtml}
            </div>
        `);
    });
}

function handleValidationChange(key, isChecked) {
    validationState[key] = isChecked;
    checkValidationCompletion();
}

function checkValidationCompletion() {
    let req = 0, chk = 0;
    activityConfig.forEach(act => {
        if (String(selectedItem[act.key] || "").toLowerCase().includes("ya")) {
            req++; if (validationState[act.key]) chk++;
        }
    });

    const btn = document.getElementById("btnSave");
    if (req === 0 || chk === req) {
        btn.disabled = false; btn.innerHTML = "Simpan Evaluasi & Nilai Akhir";
    } else {
        btn.disabled = true; btn.innerHTML = `Selesaikan Validasi di Tab 1 (${chk}/${req})`;
    }
}

function renderPhotoGallery(item) {
    const container = document.getElementById("photoGalleryContainer");
    container.innerHTML = ""; let hasPhoto = false;

    activityConfig.forEach(act => {
        if (act.hasPhoto) {
            let url = item[act.key + '_Foto'] || item['Foto_' + act.key];
            if (url && url.includes("http")) {
                hasPhoto = true;
                container.insertAdjacentHTML('beforeend', `<div class="photo-item"><img src="${url}" onclick="window.open('${url}', '_blank')"><div class="photo-label">${act.label}</div></div>`);
            }
        }
    });
    if (!hasPhoto) container.innerHTML = `<div style="grid-column:1/-1; padding:20px; text-align:center; background:var(--bg-surface-hover); color:var(--text-muted); border-radius:8px;">Belum ada lampiran visual.</div>`;
}

function setupGrading(item) {
    ['R1','R2','R3'].forEach(id => { document.querySelector(`input[oninput*="${id}"]`).value = 80; updateRubric(id, 80); });
    document.getElementById("inputCatatanPembimbing").value = item.Catatan_Pembimbing || "";
}

function updateRubric(id, val) {
    document.getElementById(`val${id}`).textContent = val;
    const r1 = parseInt(document.getElementById("valR1").textContent) || 0; 
    const r2 = parseInt(document.getElementById("valR2").textContent) || 0; 
    const r3 = parseInt(document.getElementById("valR3").textContent) || 0; 
    document.getElementById("finalScoreDisplay").textContent = Math.round((r1*0.4) + (r2*0.3) + (r3*0.3));
}

async function saveGrade() {
    const btn = document.getElementById("btnSave");
    if (!selectedItem.row) return alert("Sistem tidak mendeteksi baris database.");
    
    btn.disabled = true; btn.textContent = "Memproses...";
    try {
        const fd = new URLSearchParams({ action: "nilaiPembimbing", row: selectedItem.row, nilai: document.getElementById("finalScoreDisplay").textContent, catatan: document.getElementById("inputCatatanPembimbing").value });
        const res = await fetch(WEB_APP_URL, { method: 'POST', body: fd });
        const result = await res.json();
        
        if (result.status === 'success' || result.sukses) { alert("Penilaian berhasil disimpan."); closeModal(); loadData(); } 
        else { alert("Gagal menyimpan data."); btn.disabled = false; btn.textContent = "Coba Lagi"; }
    } catch (e) { alert("Terjadi kesalahan koneksi."); btn.disabled = false; btn.textContent = "Coba Lagi"; }
}

window.onload = loadData;
</script>
</body>
</html>
