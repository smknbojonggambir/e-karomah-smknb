<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Pembimbing Pro - E-KAROMAH</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --gold: #fbbf24;
            --bg-dark: #0f172a; 
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --blue: #3b82f6;
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: #0f172a;
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 80px; /* Space for footer */
        }

        /* --- Header Modern --- */
        header {
            background: #1e293b;
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 40;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .mentor-profile h2 { margin: 0; font-size: 16px; color: var(--gold); letter-spacing: 0.5px; }
        .mentor-profile span { font-size: 11px; color: #94a3b8; font-weight: 500; }
        .btn-logout { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); color: var(--danger); padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; }
        .btn-logout:hover { background: var(--danger); color: white; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* --- Smart Filter --- */
        .filter-container {
            background: #1e293b; padding: 15px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
        }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row input { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; font-family: inherit; }
        
        .filter-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .chip {
            padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer;
            background: #334155; color: #cbd5e1; border: 1px solid transparent; white-space: nowrap; transition: 0.2s;
        }
        .chip.active { background: rgba(16, 185, 129, 0.2); border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .chip-count { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; }

        /* --- Student Card Pro --- */
        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .student-card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 16px; position: relative;
            cursor: pointer; transition: 0.2s; overflow: hidden;
        }
        .student-card:active { transform: scale(0.98); }
        .student-card.priority { border-left: 4px solid var(--gold); } /* Belum dinilai */
        .student-card.done { border-left: 4px solid var(--primary); }  /* Sudah dinilai */

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .st-name { font-size: 15px; font-weight: 600; color: white; margin: 0; }
        .st-date { font-size: 11px; color: #94a3b8; display: block; margin-top: 2px; }
        
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; }
        .badge-pending { background: rgba(251, 191, 36, 0.15); color: var(--gold); }
        .badge-done { background: rgba(16, 185, 129, 0.15); color: var(--primary); }

        /* Progress Bar di Kartu */
        .progress-area { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #cbd5e1; }
        .progress-track { flex: 1; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .score-preview { font-weight: bold; font-size: 12px; }

        /* --- MODAL DASHBOARD --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); overflow-y: auto; }
        .modal-content {
            background: #1e293b; margin: 20px auto; width: 95%; max-width: 600px;
            border-radius: 16px; border: 1px solid #334155; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            /* Padding bottom agar scroll di HP enak */
            padding-bottom: 20px; 
            margin-bottom: 100px; 
        }
        
        /* Summary Box di Modal */
        .summary-box {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            padding: 20px; margin: 15px; border-radius: 12px; border: 1px solid #334155;
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center;
        }
        .stat-item h4 { margin: 0; font-size: 20px; color: white; }
        .stat-item span { font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Accordion Style */
        .modal-body { padding: 0 15px 15px; }
        .acc-item { margin-bottom: 8px; background: #0f172a; border-radius: 8px; overflow: hidden; border: 1px solid #334155; }
        .acc-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .acc-header h4 { margin: 0; font-size: 13px; color: #e2e8f0; }
        .acc-content { display: none; padding: 15px; background: rgba(0,0,0,0.2); border-top: 1px solid #334155; }
        .acc-content.show { display: block; }

        .status-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .bg-ok { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; }
        .bg-no { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }

        /* Grading Section Pro */
        .grading-section {
            background: #0f172a; padding: 20px; margin-top: 20px;
            border-top: 1px solid #334155; border-radius: 0 0 16px 16px;
        }
        .grade-control { margin-bottom: 15px; }
        .range-slider { width: 100%; cursor: pointer; accent-color: var(--gold); margin: 10px 0; }
        .grade-display { display: flex; justify-content: space-between; font-size: 13px; color: var(--gold); font-weight: bold; }
        
        textarea {
            width: 100%; padding: 12px; background: #1e293b; border: 1px solid #475569;
            color: white; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 13px; margin-bottom: 10px;
        }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-auto { flex: 1; background: #3b82f6; color: white; border: none; padding: 10px; border-radius: 8px; font-size: 12px; cursor: pointer; font-weight: 500; }
        .btn-save { flex: 2; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 8px; font-size: 13px; cursor: pointer; font-weight: bold; }
        .btn-save:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Utilities */
        .close-modal-btn { position: absolute; right: 15px; top: 15px; background: #334155; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; color: white; border: 1px solid #475569; z-index: 10; }
        
        #loading { text-align: center; padding: 40px; color: #94a3b8; font-size: 13px; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* FOOTER OTOMATIS */
        .footer-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #020617;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
            z-index: 50;
        }
        .footer-fixed a {
            color: var(--gold);
            text-decoration: none;
            font-weight: 600;
            transition: 0.3s;
        }
        .footer-fixed a:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        @media print { .footer-fixed { display: none; } }
    </style>
</head>
<body>

<header>
    <div class="mentor-profile">
        <h2 id="mName">Pembimbing</h2>
        <span id="mGroup">Memuat...</span>
    </div>
    <button class="btn-logout" onclick="logout()">Keluar</button>
</header>

<div class="container">
    
    <div class="filter-container">
        <div class="filter-row">
            <input type="date" id="dateFilter" onchange="loadData()">
            <button onclick="loadData()" style="background:#334155; border:1px solid #475569; color:white; border-radius:8px; padding:0 15px; cursor:pointer;">üîÑ</button>
        </div>
        <div class="filter-chips">
            <div class="chip active" onclick="setFilter('all', this)">Semua <span class="chip-count" id="countAll">0</span></div>
            <div class="chip" onclick="setFilter('pending', this)">Belum Dinilai <span class="chip-count" id="countPending" style="background:var(--gold); color:#0f172a">0</span></div>
            <div class="chip" onclick="setFilter('done', this)">Sudah Dinilai <span class="chip-count" id="countDone" style="background:var(--primary); color:white">0</span></div>
        </div>
    </div>

    <div id="loading"><div class="spinner"></div>Mengambil data laporan siswa...</div>
    <div id="studentList" class="card-list"></div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="closeModal()">&times;</div>
        
        <div style="padding: 20px 20px 0;">
            <h3 id="modalName" style="margin:0; font-size:18px; color:var(--gold)">Nama Siswa</h3>
            <small id="modalDate" style="color:#94a3b8">Tanggal</small>
        </div>

        <div class="summary-box">
            <div class="stat-item">
                <h4 id="statTotal" style="color:var(--primary)">0</h4>
                <span>Terlaksana</span>
            </div>
            <div class="stat-item">
                <h4 id="statMissed" style="color:var(--danger)">0</h4>
                <span>Bolong</span>
            </div>
            <div class="stat-item">
                <h4 id="statScore" style="color:var(--gold)">0%</h4>
                <span>Performa</span>
            </div>
        </div>

        <div style="padding:0 20px; margin-bottom:15px;">
            <div style="background:#0f172a; padding:12px; border-radius:8px; border:1px dashed #334155; font-size:13px;">
                <span style="color:#64748b; font-size:11px; display:block; margin-bottom:4px;">üìù Catatan Harian Siswa:</span>
                <span id="modalCatatanSiswa" style="color:#e2e8f0; font-style:italic">"-"</span>
            </div>
        </div>

        <div class="modal-body" id="accordionContainer"></div>

        <div class="grading-section">
            <div class="grade-control">
                <div class="grade-display">
                    <span>Berikan Nilai (Skala 0-100)</span>
                    <span id="scoreValueDisplay">80</span>
                </div>
                <input type="range" min="0" max="100" value="80" class="range-slider" id="scoreInput" oninput="updateScoreDisplay(this.value)">
            </div>
            
            <textarea id="inputCatatanPembimbing" rows="3" placeholder="Tulis evaluasi manual atau gunakan tombol otomatis..."></textarea>
            
            <div class="btn-group">
                <button class="btn-auto" onclick="generateAutoReview()">‚ú® Auto Review</button>
                <button class="btn-save" onclick="saveGrade()">üíæ SIMPAN & KIRIM</button>
            </div>
        </div>
    </div>
</div>

<div class="footer-fixed">
    &copy; 2025 E-KAROMAH App. Developer <a href="https://www.kangruli.web.id/" target="_blank">Kang Ruli</a>
</div>

<script>
// ================= CONFIG & SETUP =================
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx9ziBKETSpxXTARK6uyFbZaLIVoHO5xodyF_r8rxrFOXwIonB1U7L1KpHNXnOAmF49Kg/exec"; 

const activities = [
    "Sahur", "Subuh", "Olahraga", "Keluarga", 
    "Dzuhur", "Pesantren", "Ashar", "Aksi", 
    "Buka", "Magrib", "Isya", "Tarawih", "Tadarus", "Tidur"
];
const noPhotoActs = ["Subuh", "Dzuhur", "Ashar", "Magrib", "Isya", "Tarawih"];

// Global Variables
let rawData = [];
let filteredData = []; // Untuk filter
let selectedRowId = null;
let currentFilterType = 'all';

// 1. CEK LOGIN & KELOMPOK
const user = JSON.parse(localStorage.getItem("user"));

// Validasi Keamanan Client-Side
if(!user || user.role !== 'pembimbing'){
    alert("‚õî Akses Ditolak. Harap login sebagai Pembimbing."); 
    location.href='index.html';
}

// Set UI Profil
document.getElementById('mName').textContent = user.nama;
document.getElementById('mGroup').textContent = "Kelompok: " + user.kelompok;
// Set Default Date ke Hari Ini
document.getElementById('dateFilter').valueAsDate = new Date();

// ==========================================
// 2. FUNGSI LOAD DATA (OPTIMALISASI UTAMA)
// ==========================================
async function loadData() {
    const list = document.getElementById("studentList");
    const loader = document.getElementById("loading");
    const dateInput = document.getElementById("dateFilter").value;
    
    list.innerHTML = "";
    loader.style.display = "block";
    loader.innerHTML = `<div class="spinner"></div>Mencari laporan kelompok ${user.kelompok}...`;

    try {
        // Fetch data (Mengirim parameter kelompok ke server)
        const url = `${WEB_APP_URL}?action=rekapPembimbing&kelompok=${encodeURIComponent(user.kelompok)}`;
        const res = await fetch(url);
        const data = await res.json();
        
        // --- FILTERING ---
        // 1. Filter Kelompok & Validitas (Double Check)
        let myStudents = data.filter(item => {
            const groupItem = String(item.Kelompok || "").trim().toLowerCase();
            const groupUser = String(user.kelompok || "").trim().toLowerCase();
            return groupItem === groupUser && (item.Nama || item.nama);
        });

        // 2. Filter Tanggal (Jika ada input tanggal)
        if(dateInput) {
            myStudents = myStudents.filter(item => {
                // Ambil bagian tanggal saja dari string ISO/Time stamp
                const itemDate = item.Tanggal ? item.Tanggal.substring(0, 10) : ""; 
                return itemDate === dateInput;
            });
        }

        rawData = myStudents; // Simpan ke global
        updateCountChips(rawData);

        if(myStudents.length === 0) {
            loader.style.display = "block";
            loader.innerHTML = `
                <div style="padding:40px; text-align:center;">
                    <h3 style="color:#94a3b8">üçÉ Tidak ada laporan</h3>
                    <p style="font-size:12px; color:#64748b">
                        Belum ada siswa mengisi pada tanggal tersebut.<br>
                        Coba ganti tanggal filter.
                    </p>
                </div>`;
            return;
        }

        renderList(rawData);
        loader.style.display = "none";

    } catch(e) {
        console.error(e);
        loader.innerHTML = `<div style="color:var(--danger); padding:20px;">Gagal memuat data: ${e.message}</div>`;
    }
}

// Update Angka di Chip Filter
function updateCountChips(data) {
    const pending = data.filter(item => !(item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2)).length;
    const done = data.filter(item => (item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2)).length;
    
    document.getElementById("countAll").textContent = data.length;
    document.getElementById("countPending").textContent = pending;
    document.getElementById("countDone").textContent = done;
}

// Fungsi Filter Manual (Tab)
function setFilter(type, el) {
    // UI Active State
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    
    currentFilterType = type;
    renderList(rawData);
}

// 3. FUNGSI RENDER
function renderList(data) {
    const list = document.getElementById("studentList");
    list.innerHTML = "";

    // Filter berdasarkan Tab yang aktif
    let displayData = data;
    if(currentFilterType === 'pending') {
        displayData = data.filter(item => !(item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2));
    } else if(currentFilterType === 'done') {
        displayData = data.filter(item => (item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2));
    }

    // Sort: Belum dinilai di atas, lalu berdasarkan tanggal
    displayData.sort((a,b) => {
        const aDone = (a.Nilai_Pembimbing && String(a.Nilai_Pembimbing).length > 2);
        const bDone = (b.Nilai_Pembimbing && String(b.Nilai_Pembimbing).length > 2);
        if (aDone === bDone) return new Date(b.Tanggal) - new Date(a.Tanggal); // Sama status, urut tanggal
        return aDone ? 1 : -1; // Belum dinilai (false) lebih dulu
    });

    displayData.forEach(item => {
        // Cek status nilai
        const isDone = (item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2);
        list.appendChild(createCard(item, isDone));
    });
}

// Helper: Membuat Kartu Siswa
function createCard(item, isDone) {
    // Hitung Progress Kegiatan
    let doneCount = 0;
    activities.forEach(act => {
        if(String(item[`${act}_Status`]).toLowerCase().includes('ya')) doneCount++;
    });
    const progressPct = Math.round((doneCount / activities.length) * 100);

    const card = document.createElement("div");
    // Tambahkan class 'priority' jika belum dinilai agar border berwarna Emas
    card.className = `student-card ${isDone ? 'done' : 'priority'}`;
    
    const badgeHtml = isDone 
        ? `<span class="badge badge-done">SUDAH DINILAI</span>` 
        : `<span class="badge badge-pending">BUTUH NILAI</span>`;

    // Warna progress bar
    const progressColor = progressPct >= 80 ? '#34d399' : (progressPct >= 50 ? '#fbbf24' : '#ef4444');

    card.innerHTML = `
        <div class="card-top">
            <div>
                <h3 class="st-name">${item.Nama || item.nama}</h3>
                <span class="st-date">üìÖ ${formatTglIndo(item.Tanggal || item.tanggal)}</span>
            </div>
            ${badgeHtml}
        </div>
        
        <div class="progress-area">
            <span>Isian: ${doneCount}/${activities.length}</span>
            <div class="progress-track">
                <div class="progress-fill" style="width: ${progressPct}%; background:${progressColor}"></div>
            </div>
            <span class="score-preview" style="color:${progressColor}">${progressPct}%</span>
        </div>
    `;
    
    card.onclick = () => showDetail(item);
    return card;
}

// ==========================================
// 4. DETAIL, MODAL & GRADING
// ==========================================
function showDetail(item) {
    selectedRowId = item.row || item.id;
    
    document.getElementById("modalName").textContent = item.Nama || item.nama;
    document.getElementById("modalDate").textContent = formatTglIndo(item.Tanggal || item.tanggal);
    document.getElementById("modalCatatanSiswa").textContent = item.Catatan ? `"${item.Catatan}"` : "-";

    // Reset Accordion
    const container = document.getElementById("accordionContainer");
    container.innerHTML = "";
    
    let totalDone = 0;

    activities.forEach(act => {
        const status = item[`${act}_Status`] || "-";
        const isYa = String(status).toLowerCase().includes("ya");
        if(isYa) totalDone++;
        
        const waktu = item[`${act}_Waktu`] || "-";
        const ket = item[`${act}_Ket`] || "-";
        const foto = item[`${act}_Foto`];
        
        const badgeClass = isYa ? "bg-ok" : "bg-no";
        const icon = isYa ? "‚úÖ" : "‚ùå";

        // Logic Foto (Teks Link)
        let photoDisplay = "";
        if (!noPhotoActs.includes(act)) {
             if (foto && foto.length > 10) {
                photoDisplay = `<div class="data-row" style="margin-top:5px; border-top:1px dashed #334155; padding-top:5px;">
                    <a href="${foto}" target="_blank" style="color:#34d399; font-size:12px; text-decoration:none;">üì∏ Buka Foto Bukti</a>
                </div>`;
            } else {
                photoDisplay = `<div class="data-row" style="margin-top:5px;"><span style="color:#ef4444; font-size:11px;">Tidak ada foto</span></div>`;
            }
        }

        const html = `
        <div class="acc-item">
            <div class="acc-header" onclick="toggleAcc(this)">
                <span>${icon} ${act}</span>
                <span class="status-badge ${badgeClass}">${status}</span>
            </div>
            <div class="acc-content">
                <div style="font-size:12px; color:#cbd5e1; margin-bottom:4px;">Jam: ${waktu}</div>
                <div style="font-size:12px; color:#94a3b8; font-style:italic; margin-bottom:4px;">"${ket}"</div>
                ${photoDisplay}
            </div>
        </div>`;
        container.innerHTML += html;
    });

    // Update Stats di Modal
    document.getElementById("statTotal").textContent = totalDone;
    document.getElementById("statMissed").textContent = activities.length - totalDone;
    const pct = Math.round((totalDone/activities.length)*100);
    document.getElementById("statScore").textContent = pct + "%";

    // Setup Form Penilaian
    const existingVal = item.Nilai_Pembimbing || "";
    let score = pct; 
    let comment = "";

    // Regex ambil nilai lama [Nilai: 80] ...
    const match = existingVal.match(/\[Nilai:\s*(\d+)\]\s*(.*)/s);
    if(match) {
        score = match[1];
        comment = match[2];
    } else if(existingVal.length > 2) {
        comment = existingVal;
    }

    document.getElementById("scoreInput").value = score;
    updateScoreDisplay(score);
    document.getElementById("inputCatatanPembimbing").value = comment;

    document.getElementById("detailModal").style.display = "block";
}

// 5. FITUR AUTO REVIEW & SAVE
function generateAutoReview() {
    const total = parseInt(document.getElementById("statTotal").textContent);
    const missed = parseInt(document.getElementById("statMissed").textContent);
    const sum = total + missed;
    const pct = Math.round((total/sum)*100);
    const nama = document.getElementById("modalName").textContent.split(" ")[0];

    let text = "";
    if(pct === 100) {
        text = `Sempurna! Ananda ${nama} mengerjakan semua kegiatan (${total}/${sum}). Pertahankan!`;
        setScoreUI(100);
    } else if(pct >= 80) {
        text = `Sangat Baik. Ananda ${nama} mengerjakan ${total} kegiatan. Tingkatkan terus.`;
        setScoreUI(90);
    } else if(pct >= 60) {
        text = `Cukup Baik. Ananda ${nama} mengerjakan ${total} kegiatan. Mohon lebih disiplin lagi.`;
        setScoreUI(75);
    } else {
        text = `Perlu Bimbingan. Laporan Ananda ${nama} sangat sedikit (${total}/${sum}). Segera perbaiki.`;
        setScoreUI(50);
    }
    document.getElementById("inputCatatanPembimbing").value = text;
}

function setScoreUI(val) {
    document.getElementById("scoreInput").value = val;
    updateScoreDisplay(val);
}

function updateScoreDisplay(val) {
    const el = document.getElementById("scoreValueDisplay");
    el.textContent = val;
    if(val < 60) el.style.color = "#ef4444";
    else if(val < 85) el.style.color = "#fbbf24";
    else el.style.color = "#34d399";
}

async function saveGrade() {
    const btn = document.querySelector(".btn-save");
    const score = document.getElementById("scoreInput").value;
    const comment = document.getElementById("inputCatatanPembimbing").value.trim();

    if(!selectedRowId) return;
    if(!comment) { alert("‚ö†Ô∏è Mohon isi catatan/komentar penilaian."); return; }

    btn.textContent = "Mengirim...";
    btn.disabled = true;

    // Format Data: [Nilai: 90] Pesan...
    const payload = `[Nilai: ${score}] ${comment}`;
    const fd = new FormData();
    fd.append("action", "simpanCatatan");
    fd.append("id", selectedRowId);
    fd.append("catatan", payload);

    try {
        await fetch(WEB_APP_URL, {method: "POST", body: fd});
        
        // Update Lokal & Refresh Tampilan
        const idx = rawData.findIndex(x => (x.row || x.id) == selectedRowId);
        if(idx !== -1) rawData[idx].Nilai_Pembimbing = payload;

        alert("‚úÖ Nilai Berhasil Disimpan!");
        closeModal();
        
        // Refresh List (Agar status berubah jadi 'Sudah Dinilai')
        updateCountChips(rawData);
        renderList(rawData); 
        
    } catch(e) {
        alert("Gagal: " + e.message);
    } finally {
        btn.textContent = "üíæ SIMPAN & KIRIM";
        btn.disabled = false;
    }
}

// Utils
function toggleAcc(header) {
    const content = header.nextElementSibling;
    const isVisible = content.classList.contains('show');
    
    // Tutup semua yang lain (optional, biar rapi)
    document.querySelectorAll('.acc-content').forEach(el => el.classList.remove('show'));
    
    if(!isVisible) content.classList.add('show');
}
function formatTglIndo(str) {
    if(!str) return "";
    try { return new Date(str).toLocaleDateString('id-ID', {weekday: 'short', day:'numeric', month:'short'}); } catch(e){return str;}
}
function closeModal() { document.getElementById("detailModal").style.display = "none"; }
function logout() { localStorage.removeItem("user"); location.href="index.html"; }

// Start
loadData();
</script>
</body>
</html>
