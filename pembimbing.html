<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Pembimbing Pro - E-KAROMAH (Strict Mode)</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --gold: #fbbf24;
            --bg-dark: #0f172a; 
            --card-bg: #1e293b;
            --text: #f1f5f9;
            --danger: #ef4444;
            --blue: #3b82f6;
            --warning-bg: rgba(251, 191, 36, 0.1);
        }

        body {
            margin: 0;
            font-family: 'Poppins', sans-serif;
            background: #0f172a;
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 100px;
        }

        /* --- Header --- */
        header {
            background: #1e293b;
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 40;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .mentor-profile h2 { margin: 0; font-size: 16px; color: var(--gold); }
        .mentor-profile span { font-size: 11px; color: #94a3b8; font-weight: 500; }
        .btn-logout { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); color: var(--danger); padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 600; }
        .btn-logout:hover { background: var(--danger); color: white; }

        .container { max-width: 800px; margin: 20px auto; padding: 0 15px; }

        /* --- Filter --- */
        .filter-container {
            background: #1e293b; padding: 15px; border-radius: 12px;
            margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.05);
        }
        .filter-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .filter-row input { flex: 1; background: #0f172a; border: 1px solid #334155; color: white; padding: 10px; border-radius: 8px; font-family: inherit; }
        
        .filter-chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .chip {
            padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer;
            background: #334155; color: #cbd5e1; border: 1px solid transparent; white-space: nowrap; transition: 0.2s;
        }
        .chip.active { background: rgba(16, 185, 129, 0.2); border-color: var(--primary); color: var(--primary); font-weight: 600; }
        .chip-count { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; }

        /* --- Cards --- */
        .card-list { display: flex; flex-direction: column; gap: 12px; }
        .student-card {
            background: #1e293b; border: 1px solid #334155;
            border-radius: 12px; padding: 16px; position: relative;
            cursor: pointer; transition: 0.2s; overflow: hidden;
        }
        .student-card:active { transform: scale(0.98); }
        .student-card.priority { border-left: 4px solid var(--danger); } 
        .student-card.done { border-left: 4px solid var(--primary); }

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .st-name { font-size: 15px; font-weight: 600; color: white; margin: 0; }
        .st-date { font-size: 11px; color: #94a3b8; display: block; margin-top: 2px; }
        
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background: rgba(251, 191, 36, 0.15); color: var(--gold); }
        .badge-done { background: rgba(16, 185, 129, 0.15); color: var(--primary); }

        /* Progress Bar */
        .progress-area { display: flex; align-items: center; gap: 10px; font-size: 11px; color: #cbd5e1; }
        .progress-track { flex: 1; height: 6px; background: #334155; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        .score-preview { font-weight: bold; font-size: 12px; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(8px); overflow-y: auto; }
        .modal-content {
            background: #1e293b; margin: 20px auto; width: 95%; max-width: 700px;
            border-radius: 16px; border: 1px solid #334155; padding-bottom: 20px; 
            margin-bottom: 100px; animation: slideUp 0.3s ease-out; position: relative;
        }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        /* Strict Mode Features CSS */
        .inspection-header {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            color: white; padding: 15px 20px; border-radius: 15px 15px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .inspection-label { font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap:5px; }

        .tabs-container { display: flex; background: #0f172a; padding: 5px; margin: 15px; border-radius: 8px; }
        .tab { flex: 1; text-align: center; padding: 10px; font-size: 12px; color: #94a3b8; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .tab.active { background: #334155; color: white; font-weight: bold; }

        .tab-content { display: none; padding: 0 15px; }
        .tab-content.active { display: block; }

        /* Photo Grid Inspection */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            border: 1px solid #475569;
            background: #0f172a;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.3s;
            cursor: zoom-in;
        }

        .photo-item:hover img {
            transform: scale(1.05);
            opacity: 0.6;
        }

        .photo-label {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8);
            color: white;
            font-size: 10px;
            padding: 6px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            z-index: 2;
        }

        .img-fallback {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: #1e293b; color: #94a3b8;
            text-align: center; padding: 10px;
            font-size: 10px;
        }
        
        .no-photo-alert { grid-column: 1/-1; padding: 20px; text-align: center; background: rgba(239,68,68,0.1); border: 1px dashed var(--danger); color: var(--danger); font-size: 12px; border-radius: 8px; }

        /* Anomaly & Validation List */
        .validation-list { display: flex; flex-direction: column; gap: 8px; }
        .val-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; 
        }
        .val-info { display: flex; flex-direction: column; }
        .val-title { font-size: 13px; font-weight: 600; color: #e2e8f0; }
        .val-time { font-size: 11px; color: #94a3b8; display: flex; align-items: center; gap: 5px; }
        
        .anomaly-badge { background: var(--danger); color: white; font-size: 9px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% {opacity: 1;} 50% {opacity: 0.6;} 100% {opacity: 1;} }

        /* Custom Checkbox for Strict Checking */
        .check-box-wrapper { position: relative; }
        .check-input { display: none; }
        .check-label { 
            display: flex; align-items: center; gap: 6px; padding: 6px 12px; 
            background: #334155; border-radius: 20px; font-size: 11px; cursor: pointer; color: #cbd5e1; border: 1px solid #475569;
        }
        .check-input:checked + .check-label { background: var(--primary); color: white; border-color: var(--primary); }
        .check-input:checked + .check-label::before { content: '‚úì'; font-weight: bold; }

        /* Grading Rubric */
        .rubric-container { background: #0f172a; border-radius: 12px; padding: 15px; border: 1px solid #334155; margin-top: 15px; }
        .rubric-row { margin-bottom: 12px; }
        .rubric-header { display: flex; justify-content: space-between; font-size: 12px; color: #94a3b8; margin-bottom: 5px; }
        .rubric-range { width: 100%; accent-color: var(--blue); height: 4px; }
        
        .final-score-box { 
            text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); 
            border: 1px dashed var(--primary); border-radius: 12px; margin: 15px 0;
        }
        .fs-val { font-size: 28px; font-weight: 800; color: var(--primary); display: block; }
        .fs-lbl { font-size: 11px; color: #94a3b8; text-transform: uppercase; }

        textarea {
            width: 100%; padding: 12px; background: #0f172a; border: 1px solid #475569;
            color: white; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 13px; margin-bottom: 10px; resize: vertical;
        }
        
        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-save:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-save:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; background: #64748b; }

        .close-modal-btn { position: absolute; right: 15px; top: 15px; background: rgba(0,0,0,0.3); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 10; }
        
        #loading { text-align: center; padding: 40px; color: #94a3b8; font-size: 13px; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to {transform: rotate(360deg);} }

        .footer-fixed {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #020617; border-top: 1px solid rgba(255,255,255,0.1);
            padding: 10px 0; text-align: center; color: #94a3b8;
            font-size: 12px; z-index: 50;
        }
    </style>
</head>
<body>

<header>
    <div class="mentor-profile">
        <h2 id="mName">Pembimbing</h2>
        <span id="mGroup">Memuat...</span>
    </div>
    <button class="btn-logout" onclick="logout()">Keluar</button>
</header>

<div class="container">
    <div class="filter-container">
        <div class="filter-row">
            <input type="date" id="dateFilter" onchange="loadData()">
            <button onclick="loadData()" style="background:#334155; border:1px solid #475569; color:white; border-radius:8px; padding:0 15px; cursor:pointer; font-size:18px;">üîÑ</button>
        </div>
        <div class="filter-chips">
            <div class="chip active" onclick="setFilter('all', this)">Semua <span class="chip-count" id="countAll">0</span></div>
            <div class="chip" onclick="setFilter('pending', this)">Perlu Pemeriksaan <span class="chip-count" id="countPending" style="background:var(--danger); color:white">0</span></div>
            <div class="chip" onclick="setFilter('done', this)">Selesai <span class="chip-count" id="countDone" style="background:var(--primary); color:white">0</span></div>
        </div>
    </div>

    <div id="loading"><div class="spinner"></div>Mengambil data laporan siswa...</div>
    <div id="studentList" class="card-list"></div>
</div>

<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="closeModal()">&times;</div>
        
        <div class="inspection-header">
            <div>
                <div class="inspection-label">üõ°Ô∏è MODE INSPEKSI PEMBIMBING</div>
                <h3 id="modalName" style="margin:5px 0 0; font-size:18px;">Nama Siswa</h3>
            </div>
            <div style="text-align:right">
                <small id="modalDate" style="opacity:0.8">Tanggal</small>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('check')">1. Validasi Kegiatan</div>
            <div class="tab" onclick="switchTab('gallery')">2. Cek Foto Bukti</div>
            <div class="tab" onclick="switchTab('grading')">3. Penilaian Akhir</div>
        </div>

        <div id="tab-check" class="tab-content active">
            <div style="margin-bottom:15px; background:rgba(59, 130, 246, 0.1); border:1px solid #3b82f6; padding:10px; border-radius:8px; font-size:12px; color:#93c5fd;">
                ‚ÑπÔ∏è <b>Instruksi:</b> Periksa jam pelaksanaan. Centang "Valid" jika waktu masuk akal. Sistem mendeteksi otomatis keterlambatan.
            </div>
            
            <div style="background:#0f172a; padding:10px; border-radius:8px; margin-bottom:15px; font-style:italic; border-left:3px solid #cbd5e1;">
                <span style="color:#64748b; font-size:10px;">Catatan Siswa:</span><br>
                <span id="modalCatatanSiswa" style="color:#f1f5f9; font-size:13px;">"-"</span>
            </div>

            <div class="validation-list" id="validationContainer"></div>
        </div>

        <div id="tab-gallery" class="tab-content">
            <div style="margin-bottom:10px; font-size:12px; color:#94a3b8; text-align:center;">
                Pastikan foto tidak gelap gulita, bukan foto karpet saja, dan bukan foto berulang.
            </div>
            <div id="photoGalleryContainer" class="photo-grid"></div>
        </div>

        <div id="tab-grading" class="tab-content">
            <div class="rubric-container">
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kedisiplinan Waktu (40%)</span>
                        <span id="valR1">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R1', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kelengkapan Bukti (30%)</span>
                        <span id="valR2">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R2', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kualitas Ibadah/Kejujuran (30%)</span>
                        <span id="valR3">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R3', this.value)">
                </div>
            </div>

            <div class="final-score-box">
                <span class="fs-lbl">Nilai Akhir Terhitung</span>
                <span class="fs-val" id="finalScoreDisplay">80</span>
            </div>

            <label style="font-size:12px; color:#94a3b8; display:block; margin-bottom:5px;">Evaluasi / Komentar Pembimbing:</label>
            <textarea id="inputCatatanPembimbing" rows="3" placeholder="Contoh: Sholat subuh terlalu siang, mohon diperbaiki besok..."></textarea>
            
            <button id="btnSave" class="btn-save" onclick="saveGrade()" disabled>üîí SELESAIKAN VALIDASI DULU</button>
            <div style="text-align:center; font-size:10px; color:#64748b; margin-top:5px;">
                *Tombol aktif setelah melakukan validasi di Tab 1
            </div>
        </div>
    </div>
</div>

<div class="footer-fixed">
    &copy; 2026 E-KAROMAH App. Developer <a href="https://www.kangruli.web.id/" target="_blank">Kang Ruli</a>
</div>

<script>
// ================= CONFIG & SETUP =================
// ‚úÖ PASTIKAN URL INI SUDAH YANG TERBARU (HASIL DEPLOY BARU)
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz9YCqyJTYQkOfljm1Pbqxy7QoCw9apkHBhDYRVwjRHcihPDN1hn5vpyxkoJ9HqkFCv5g/exec"; 

const activityConfig = [
    { key: "Sahur", label: "Makan Sahur", hasPhoto: true, max: "04:30" },
    { key: "Subuh", label: "Sholat Subuh", hasPhoto: true, max: "05:15" },
    { key: "Dzuhur", label: "Sholat Dzuhur", hasPhoto: true, max: "13:00" },
    { key: "Ashar", label: "Sholat Ashar", hasPhoto: true, max: "16:00" },
    { key: "Buka", label: "Buka Puasa", hasPhoto: true, max: "18:30" },
    { key: "Magrib", label: "Sholat Magrib", hasPhoto: true, max: "18:45" },
    { key: "Isya", label: "Sholat Isya", hasPhoto: true, max: "20:00" },
    { key: "Tarawih", label: "Sholat Tarawih", hasPhoto: true, max: "21:00" },
    { key: "Tadarus", label: "Tadarus Quran", hasPhoto: true, max: null },
    { key: "Olahraga", label: "Olahraga", hasPhoto: true, max: null },
    { key: "Pesantren", label: "Kegiatan Pesantren", hasPhoto: true, max: null },
    { key: "Keluarga", label: "Bantu Orang Tua", hasPhoto: false, max: null }
];

// Global Variables
let rawData = [];
let selectedItem = null;
let currentFilterType = 'all';
let validationState = {}; 

// 1. CEK LOGIN
const user = JSON.parse(localStorage.getItem("user"));
if(!user || user.role !== 'pembimbing'){
    alert("‚õî Akses Ditolak. Silakan login sebagai Pembimbing."); 
    window.location.href='index.html';
}

document.getElementById('mName').textContent = user.nama || "Pembimbing";
document.getElementById('mGroup').textContent = "Kelompok: " + (user.kelompok || "-");
document.getElementById('dateFilter').valueAsDate = new Date();

// ==========================================
// 2. HELPER FUNCTIONS
// ==========================================
function logout() {
    if(confirm("Yakin ingin keluar?")) {
        localStorage.removeItem("user");
        window.location.href = "index.html";
    }
}

function formatTglIndo(isoDate) {
    if(!isoDate) return "-";
    const d = new Date(isoDate);
    if(isNaN(d.getTime())) return isoDate; 
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return d.toLocaleDateString('id-ID', options);
}

// ==========================================
// 3. LOAD DATA (DENGAN FITUR MERGE CICILAN)
// ==========================================
async function loadData() {
    const list = document.getElementById("studentList");
    const loader = document.getElementById("loading");
    const dateInput = document.getElementById("dateFilter").value;
    
    list.innerHTML = "";
    loader.style.display = "block";

    try {
        const url = `${WEB_APP_URL}?action=rekapPembimbing&kelompok=${encodeURIComponent(user.kelompok)}`;
        const res = await fetch(url);
        const data = await res.json();
        
        let filteredData = data;
        if(dateInput && data.length > 0) {
            filteredData = data.filter(item => {
                let itemDate = "";
                if(item.Tanggal){
                    const d = new Date(item.Tanggal);
                    itemDate = d.toISOString().split('T')[0];
                }
                return itemDate === dateInput;
            });
        }

        // --- SISTEM PENGGABUNGAN DATA (MERGING CICILAN) ---
        let groupedData = {};
        
        filteredData.forEach(item => {
            let namaSiswa = item.Nama || item.nama;
            let itemDate = "";
            if(item.Tanggal){
                const d = new Date(item.Tanggal);
                itemDate = d.toISOString().split('T')[0];
            }
            
            // Kunci identifikasi: Nama + Tanggal (contoh: Via Siti Saadah_2026-02-19)
            let key = `${namaSiswa}_${itemDate}`;

            if (!groupedData[key]) {
                // Jika belum ada kartu untuk siswa ini di tanggal ini, buat baru
                groupedData[key] = { ...item };
            } else {
                // Jika sudah ada, gabungkan isian cicilan aktivitasnya
                activityConfig.forEach(act => {
                    const statusSiswa = item[act.key] || item[act.key+'_Status'] || "";
                    
                    // Jika di baris cicilan ini aktivitas diisi "Ya", timpa data sebelumnya
                    if (String(statusSiswa).toLowerCase().includes('ya')) {
                        groupedData[key][act.key] = statusSiswa;
                        
                        // Timpa Jam
                        const w1 = act.key + '_Waktu'; const w2 = 'Waktu_' + act.key;
                        if (item[w1] && item[w1] !== "-") groupedData[key][w1] = item[w1];
                        if (item[w2] && item[w2] !== "-") groupedData[key][w2] = item[w2];
                        
                        // Timpa Foto
                        const f1 = act.key + '_Foto'; const f2 = 'Foto_' + act.key;
                        if (item[f1] && item[f1] !== "-") groupedData[key][f1] = item[f1];
                        if (item[f2] && item[f2] !== "-") groupedData[key][f2] = item[f2];
                    }
                });

                // Update ID baris ke laporan terbaru, agar saat disave nilainya masuk ke baris akhir
                if (item.id || item.row) {
                    groupedData[key].id = item.id || item.row;
                    groupedData[key].row = item.id || item.row;
                }

                // Gabungkan Catatan Siswa jika ada tambahan teks dari cicilan
                if(item.Catatan && item.Catatan !== "-" && String(item.Catatan).trim() !== "") {
                    if (!groupedData[key].Catatan || groupedData[key].Catatan === "-") {
                        groupedData[key].Catatan = item.Catatan;
                    } else if (!groupedData[key].Catatan.includes(item.Catatan)) {
                        groupedData[key].Catatan += " | " + item.Catatan;
                    }
                }

                // Jika di salah satu baris cicilan ternyata sudah pernah dinilai, munculkan status "SUDAH DINILAI"
                if (item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2) {
                    groupedData[key].Nilai_Pembimbing = item.Nilai_Pembimbing;
                }
            }
        });

        // Ubah format Object kembali menjadi Array biasa
        let myStudents = Object.values(groupedData);
        // ------------------------------------------------

        rawData = myStudents;
        updateCountChips(rawData);

        if(myStudents.length === 0) {
            loader.innerHTML = `<div style="padding:40px; text-align:center; color:#94a3b8">üçÉ Tidak ada laporan pada tanggal <b>${dateInput}</b>.</div>`;
            return;
        }

        renderList(rawData);
        loader.style.display = "none";

    } catch(e) {
        console.error(e);
        loader.innerHTML = `<div style="color:var(--danger); padding:20px; text-align:center;">Gagal memuat data.<br>Cek koneksi internet atau coba refresh.</div>`;
    }
}

function updateCountChips(data) {
    const pending = data.filter(item => !hasGrade(item)).length;
    const done = data.filter(item => hasGrade(item)).length;
    document.getElementById("countAll").textContent = data.length;
    document.getElementById("countPending").textContent = pending;
    document.getElementById("countDone").textContent = done;
}

function hasGrade(item){ 
    return item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2; 
}

function setFilter(type, el) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    currentFilterType = type;
    renderList(rawData);
}

function renderList(data) {
    const list = document.getElementById("studentList");
    list.innerHTML = "";

    let displayData = data;
    if(currentFilterType === 'pending') displayData = data.filter(item => !hasGrade(item));
    else if(currentFilterType === 'done') displayData = data.filter(item => hasGrade(item));

    displayData.sort((a,b) => {
        const aDone = hasGrade(a);
        const bDone = hasGrade(b);
        return aDone === bDone ? 0 : (aDone ? 1 : -1);
    });

    displayData.forEach(item => {
        list.appendChild(createCard(item));
    });
}

function createCard(item) {
    let doneCount = 0;
    activityConfig.forEach(act => {
        const val = item[act.key] || item[act.key+'_Status'] || "";
        if(String(val).toLowerCase().includes('ya')) doneCount++;
    });
    
    const totalActs = activityConfig.length;
    const progressPct = Math.round((doneCount / totalActs) * 100);
    const isDone = hasGrade(item);
    
    const card = document.createElement("div");
    card.className = `student-card ${isDone ? 'done' : 'priority'}`;
    
    const badgeHtml = isDone 
        ? `<span class="badge badge-done">SUDAH DINILAI</span>` 
        : `<span class="badge badge-pending">PERLU INSPEKSI</span>`;

    const progressColor = progressPct >= 80 ? '#34d399' : (progressPct >= 50 ? '#fbbf24' : '#ef4444');

    card.innerHTML = `
        <div class="card-top">
            <div>
                <h3 class="st-name">${item.Nama || item.nama}</h3>
                <span class="st-date">üìÖ ${formatTglIndo(item.Tanggal)}</span>
            </div>
            ${badgeHtml}
        </div>
        <div class="progress-area">
            <span>Isian: ${doneCount}/${totalActs}</span>
            <div class="progress-track">
                <div class="progress-fill" style="width: ${progressPct}%; background:${progressColor}"></div>
            </div>
            <span class="score-preview" style="color:${progressColor}">${progressPct}%</span>
        </div>
    `;
    card.onclick = () => openInspectionMode(item);
    return card;
}

// ==========================================
// 4. INSPECTION MODE & MODAL
// ==========================================
function openInspectionMode(item) {
    selectedItem = item;
    validationState = {}; 

    document.getElementById("modalName").textContent = item.Nama || item.nama;
    document.getElementById("modalDate").textContent = formatTglIndo(item.Tanggal);
    document.getElementById("modalCatatanSiswa").textContent = item.Catatan ? `"${item.Catatan}"` : "-";

    renderValidationList(item);
    renderPhotoGallery(item);
    setupGrading(item);

    switchTab('check'); 
    checkValidationCompletion();
    document.getElementById("detailModal").style.display = "block";
}

function closeModal() {
    document.getElementById("detailModal").style.display = "none";
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    const tabs = document.querySelectorAll('.tab');
    if(tabName === 'check') tabs[0].classList.add('active');
    if(tabName === 'gallery') tabs[1].classList.add('active');
    if(tabName === 'grading') tabs[2].classList.add('active');

    document.getElementById(`tab-${tabName}`).classList.add('active');
}

// ==========================================
// 5. VALIDATION LIST LOGIC
// ==========================================
function renderValidationList(item) {
    const container = document.getElementById("validationContainer");
    container.innerHTML = "";

    activityConfig.forEach(act => {
        const status = item[act.key] || item[act.key+'_Status'] || "-";
        let rawWaktu = item[act.key+'_Waktu'] || item['Waktu_'+act.key] || "-";
        
        // --- PERBAIKAN: Parsing Format Date Google Sheets (1899-12-30T05:13...) ---
        let waktu = rawWaktu;
        if (String(waktu).includes('T')) {
            try {
                // Ambil string jam yang terletak setelah huruf 'T'
                waktu = String(waktu).split('T')[1].substring(0, 5); 
            } catch(e) {
                console.warn("Gagal mengekstrak waktu:", rawWaktu);
            }
        }
        
        const isYa = String(status).toLowerCase().includes("ya");

        let anomalyHtml = "";
        let timeColor = "#94a3b8";

        if(isYa && act.max && waktu !== "-") {
            const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if(timePattern.test(waktu)) {
                if(waktu > act.max) {
                    anomalyHtml = `<span class="anomaly-badge">‚ö†Ô∏è Terlambat (Batas: ${act.max})</span>`;
                    timeColor = "#ef4444";
                }
            }
        }

        const needsCheck = isYa; 
        const checkId = `chk_${act.key}`;
        
        // Jika belum "ya" (belum dikerjakan/dicicil), otomatis lolos validasi untuk poin ini
        validationState[act.key] = !needsCheck; 

        // Teks disesuaikan agar cocok dengan sistem "cicil"
        const checkHtml = needsCheck 
            ? `<div class="check-box-wrapper">
                <input type="checkbox" id="${checkId}" class="check-input" onchange="toggleValidation('${act.key}')">
                <label for="${checkId}" class="check-label">Valid</label>
               </div>`
            : `<span style="font-size:10px; color:#64748b; padding:5px;">(Belum/Tidak)</span>`;

        const html = `
        <div class="val-item">
            <div class="val-info">
                <span class="val-title" style="color:${isYa ? '#fff' : '#64748b'}">${act.label}</span>
                <span class="val-time" style="color:${timeColor}">
                    ${isYa ? 'üïí ' + waktu : '‚ùå Belum / Tidak melaksanakan'}
                    ${anomalyHtml}
                </span>
            </div>
            ${checkHtml}
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
    });
}

function toggleValidation(key) {
    const cb = document.getElementById(`chk_${key}`);
    validationState[key] = cb.checked;
    checkValidationCompletion();
}

function checkValidationCompletion() {
    const btn = document.getElementById("btnSave");
    let allValid = true;
    
    activityConfig.forEach(act => {
        const status = selectedItem[act.key] || selectedItem[act.key+'_Status'] || "";
        const isYa = String(status).toLowerCase().includes("ya");
        if(isYa && !validationState[act.key]) {
            allValid = false;
        }
    });

    if(allValid) {
        btn.disabled = false;
        btn.textContent = "üíæ SIMPAN NILAI & KOMENTAR";
        btn.style.background = "var(--primary)";
    } else {
        btn.disabled = true;
        btn.textContent = "üîí SELESAIKAN VALIDASI DI TAB 1";
        btn.style.background = "#64748b";
    }
}

// ==========================================
// 6. GALLERY LOGIC
// ==========================================
function renderPhotoGallery(item) {
    const container = document.getElementById("photoGalleryContainer");
    container.innerHTML = "";
    let count = 0;

    activityConfig.forEach(act => {
        if(act.hasPhoto) {
            let rawUrl = item[act.key+'_Foto'] || item['Foto_'+act.key] || "";
            
            if(rawUrl && rawUrl.length > 5) {
                count++;
                const displayUrl = convertDriveLink(rawUrl);

                const el = document.createElement('div');
                el.className = 'photo-item';
                
                el.innerHTML = `
                    <img src="${displayUrl}" 
                         onclick="window.open('${rawUrl}', '_blank')" 
                         loading="lazy" 
                         alt="${act.label}"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    
                    <div class="img-fallback" style="display:none;">
                        <span>üö´ Gambar tidak tampil</span>
                        <a href="${rawUrl}" target="_blank" style="color:#3b82f6; margin-top:5px; text-decoration:underline;">Buka Link Manual</a>
                    </div>

                    <div class="photo-label">${act.label}</div>
                `;
                container.appendChild(el);
            }
        }
    });

    if(count === 0) {
        container.innerHTML = `<div class="no-photo-alert">üö´ Tidak ada bukti foto satupun yang diunggah siswa ini.</div>`;
    }
}

function convertDriveLink(url) {
    if (!url) return "";
    if (url.includes("drive.google.com")) {
        const idMatch = url.match(/\/d\/(.+?)(\/|$)/);
        if (idMatch && idMatch[1]) {
            return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
        }
    }
    return url;
}

// ==========================================
// 7. GRADING & SAVING
// ==========================================
function setupGrading(item) {
    updateRubric('R1', 80); updateRubric('R2', 80); updateRubric('R3', 80);
    document.getElementById("inputCatatanPembimbing").value = "";

    const val = item.Nilai_Pembimbing || "";
    if(val.includes("[N:")) {
        const matchTotal = val.match(/\[N:(\d+)\]/);
        if(matchTotal) {
            document.getElementById("finalScoreDisplay").textContent = matchTotal[1];
        }
        const parts = val.split("]");
        if(parts.length > 0) {
            document.getElementById("inputCatatanPembimbing").value = parts[parts.length-1].trim();
        }
    }
}

function updateRubric(id, val) {
    document.getElementById(`val${id}`).textContent = val;
    calculateFinalScore();
}

function calculateFinalScore() {
    const r1 = parseInt(document.getElementById("valR1").textContent) || 0;
    const r2 = parseInt(document.getElementById("valR2").textContent) || 0;
    const r3 = parseInt(document.getElementById("valR3").textContent) || 0;
    
    // Bobot: 40% + 30% + 30%
    const final = (r1 * 0.4) + (r2 * 0.3) + (r3 * 0.3);
    document.getElementById("finalScoreDisplay").textContent = Math.round(final);
}

async function saveGrade() {
    const btn = document.getElementById("btnSave");
    const originalText = btn.textContent;
    
    const score = document.getElementById("finalScoreDisplay").textContent;
    const rawComment = document.getElementById("inputCatatanPembimbing").value;
    const finalVal = `[N:${score}] ${rawComment}`;
    
    const idSiswa = selectedItem.id || selectedItem.row; 

    if(!idSiswa) {
        alert("‚ö†Ô∏è Error: ID Laporan (Baris) tidak ditemukan. Coba refresh halaman.");
        return;
    }

    btn.textContent = "‚è≥ Menyimpan...";
    btn.disabled = true;

    try {
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'simpanNilai',
                id: idSiswa,           
                nilai: finalVal
            })
        });

        const result = await response.json();

        if(result.status === 'success' || result.status === 'ok'){
            alert("‚úÖ Penilaian Berhasil Disimpan!");
            closeModal();
            loadData(); 
        } else {
            throw new Error(result.message || "Gagal menyimpan");
        }
    } catch (error) {
        console.error(error);
        alert("‚ùå Gagal: " + error.message);
        btn.textContent = originalText;
        btn.disabled = false;
    }
}
</script>
<script src="chat.js" defer></script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('SW Otomatis Siap!', reg.scope))
        .catch(err => console.log('SW Gagal:', err));
    });
  }
</script>
</body>
</html>
