<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Pembimbing Profesional | E-KAROMAH</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #059669;
            --primary-dark: #047857;
            --gold: #eab308;
            --bg-dark: #0f172a; 
            --card-bg: #181f32;
            --text: #f7fafc;
            --danger: #ef4444;
            --blue: #2563eb;
            --warning-bg: rgba(251, 191, 36, 0.07);
            --accent: #38bdf8;
            --focus: #3b82f6;
        }

        body {
            margin: 0;
            font-family: 'Poppins', Arial, Helvetica, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 100px;
            letter-spacing: 0.02em;
        }

        header {
            background: var(--card-bg);
            padding: 22px 28px;
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid rgba(16,185,129,0.10);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 3px 24px rgba(0,0,0,0.18);
        }
        .mentor-profile h2 { margin: 0; font-size: 20px; font-weight: 700; color: var(--primary); }
        .mentor-profile span { font-size: 13px; color: #94a3b8; font-weight: 500; }
        .btn-logout { background: none; border: 1px solid var(--danger); color: var(--danger); padding: 7px 18px; border-radius: 22px; cursor: pointer; font-size: 13px; font-weight: 600; transition: .17s; }
        .btn-logout:hover { background: var(--danger); color: white; }

        .container { max-width: 950px; margin: 30px auto 0; padding: 0 18px; }

        /* --- Filter --- */
        .filter-container {
            background: var(--card-bg); padding: 25px 18px; border-radius: 14px;
            margin-bottom: 28px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 1px 10px #0f172a08;
        }
        .filter-row { display: flex; gap: 16px; margin-bottom: 18px; align-items: center;}
        .filter-row input { flex: 1; background: var(--bg-dark); border: 1px solid #334155; color: white; padding: 13px 13px; border-radius: 8px; font-family: inherit; font-size: 14px; }
        .filter-row input:focus { outline: 2px solid var(--primary); border-color: var(--primary);}
        .filter-row button {
            background: var(--focus); border: none; color: white; border-radius:8px;
            padding:8px 18px; cursor:pointer; font-size:18px; font-weight:600; transition:.2s;
        }
        .filter-row button:hover { background: var(--blue); }

        .filter-chips { display: flex; gap: 11px; flex-wrap: wrap;
            overflow-x: auto; padding-bottom: 7px; }
        .chip {
            padding: 7px 20px; border-radius: 21px; font-size: 13px; cursor: pointer;
            background: #25314d; color: #d4d9e1; border: 1px solid transparent;
            white-space: nowrap; transition: 0.17s; font-weight: 500;
        }
        .chip.active { background: var(--primary); color: #fff4be; border-color: #24e694; font-weight: 700;}
        .chip-count { background: rgba(255,255,255,0.10); padding: 3px 8px; border-radius: 10px; font-size: 10px; margin-left: 7px; font-weight:600;}

        /* --- Table --- */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 26px;
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #334155;
            box-shadow: 0 4px 14px -4px rgba(16,185,129,0.13);
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            text-align: left;
        }
        .summary-table th {
            background: #151f33;
            color: #a0aec0;
            padding: 15px 17px;
            font-weight: 700;
            border-bottom: 2px solid #304661;
            white-space: nowrap;
        }
        .summary-table td {
            padding: 15px 17px;
            border-bottom: 1px solid #334155;
            color: #e2e8f0;
            white-space: nowrap;
        }
        .summary-table tbody tr {
            transition: background 0.14s;
        }
        .summary-table tbody tr:hover {
            background: rgba(59,130,246,0.11);
            cursor: pointer;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            display: inline-block;
            letter-spacing: .03em;
        }
        .status-belum { background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.28); }
        .status-sudah { background: rgba(16, 185, 129, 0.10); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.25); }

        /* --- Student Card --- */
        .card-list { display: flex; flex-direction: column; gap: 17px; }
        .student-card {
            background: var(--card-bg); border: 1.5px solid #293859;
            border-radius: 15px; padding: 19px 21px; position: relative;
            cursor: pointer; transition: 0.17s; overflow: hidden; box-shadow: 0 2px 10px #0f172a10;
            min-height: 74px;
        }
        .student-card:active { transform: scale(0.98); }
        .student-card.priority { border-left: 5px solid var(--danger); } 
        .student-card.done { border-left: 5px solid var(--primary); background: #193225;}

        .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
        .st-name { font-size: 16.5px; font-weight: 700; color: white; margin: 0 0 2px 0; }
        .st-date { font-size: 12px; color: #b6c6e2; display: block;}

        .badge { font-size: 10.5px; padding: 5px 12px; border-radius: 7px; font-weight: 600; text-transform: uppercase; letter-spacing:0.03em;}
        .badge-pending { background: rgba(251, 191, 36, 0.13); color: var(--gold); }
        .badge-done { background: rgba(16, 185, 129, 0.13); color: var(--primary); }

        .progress-area { display: flex; align-items: center; gap: 12px; font-size: 12px; color: #cbd5e1; margin-top: 4px;}
        .progress-track { flex: 1; height: 7px; background: #334155; border-radius: 3.5px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3.5px; transition: width 0.5s ease; }
        .score-preview { font-weight: bold; font-size: 13px; }

        /* --- Modal --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.96); backdrop-filter: blur(10px); overflow-y: auto;}
        .modal-content {
            background: #1e293b; margin: 24px auto; width: 97%; max-width: 700px;
            border-radius: 19px; border: 1px solid #334155; padding-bottom: 20px;
            animation: slideUp 0.33s ease-out; position: relative; box-shadow:0 10px 55px #0009;
        }
        @keyframes slideUp { from {transform: translateY(35px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .inspection-header {
            background: linear-gradient(120deg, #42d392 38%, #6473da 90%);
            color: white; padding: 18px 25px 20px 24px; border-radius: 18px 18px 0 0;
            display: flex; justify-content: space-between; align-items: center; min-height:64px;
        }
        .inspection-label { 
            font-size: 13.3px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 1.2px; 
            display: flex; align-items: center; gap:6px; 
            background: #123c26; padding:2px 12px; border-radius:7px;
        }

        .tabs-container { display: flex; background: #0f172a; padding: 7px; margin: 20px 17px 10px 17px; border-radius: 8px;}
        .tab { flex: 1; text-align: center; padding: 13px; font-size: 13.5px; color: #a8b5cc; cursor: pointer; border-radius: 8px; transition: 0.18s; }
        .tab.active { background: #334155; color: white; font-weight: bold; box-shadow:0 0 0.5em #274bab24;}

        .tab-content { display: none; padding: 0 22px; }
        .tab-content.active { display: block; padding-top: 5px;}

        /* Photo Grid Inspection */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(135px, 1fr));
            gap: 14px;
            margin-top: 16px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            aspect-ratio: 1;
            border: 1px solid #4371af;
            background: var(--bg-dark);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: 0.23s;
            cursor: zoom-in;
        }

        .photo-item:hover img {
            transform: scale(1.08) rotate(0.5deg);
            opacity: 0.75;
        }

        .photo-label {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            background: rgba(1,9,13,0.82);
            color: #fff9c9;
            font-size: 11px;
            padding: 7px 0 5px 0;
            text-align: center;
            font-weight: 600;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .no-photo-alert { grid-column: 1/-1; padding: 24px 10px; text-align: center; background: rgba(239,68,68,0.14); border: 1.6px dashed var(--danger); color: var(--danger); font-size: 13px; border-radius: 10px; }

        /* Anomaly & Validation List */
        .validation-list { display: flex; flex-direction: column; gap: 10px; }
        .val-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 18px 15px; background: #101928; border: 1.5px solid #334155; border-radius: 8px; 
            box-shadow:0 1px 8px #13223311;
        }
        .val-info { display: flex; flex-direction: column; }
        .val-title { font-size: 14px; font-weight: 700; color: #f1f5f9; letter-spacing: 0.08em;}
        .val-time { font-size: 12px; color: #93b9de; display: flex; align-items: center; gap: 5px; }
        
        .anomaly-badge { background: var(--danger); color: white; font-size: 11px; padding: 2.2px 9px; border-radius: 5px; margin-left: 8px; animation: pulse 2.5s infinite;}
        @keyframes pulse {0%{opacity:1;}50%{opacity:0.64;}100%{opacity:1;}}

        /* Custom Checkbox for Strict Checking */
        .check-box-wrapper { position: relative; }
        .check-input { display: none; }
        .check-label { 
            display: flex; align-items: center; gap: 8px; padding: 7px 16px; 
            background: #2d355d; border-radius: 20px; font-size: 12px; cursor: pointer; color: #e0ebfa; border: 1px solid #475569;font-weight: 600;
        }
        .check-input:checked + .check-label { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold;}
        .check-input:checked + .check-label::before { content: '‚úì'; font-weight: bold; margin-right:7px; }

        /* Grading Rubric */
        .rubric-container { background: #0e1727; border-radius: 13px; padding: 18px; border: 1.3px solid #304661; margin-top: 15px; }
        .rubric-row { margin-bottom: 14px; }
        .rubric-header { display: flex; justify-content: space-between; font-size: 13px; color: #a6adc6; margin-bottom: 6px; font-weight: 600;}
        .rubric-range { width: 100%; accent-color: var(--accent); height: 6px; }

        .final-score-box {
            text-align: center; padding: 17px 0; background: rgba(16, 185, 129, 0.1);
            border: 1.4px dashed var(--primary); border-radius: 15px; margin: 17px 0 0 0;
        }
        .fs-val { font-size: 32px; font-weight: 800; color: var(--primary); display: block; line-height:1.1;}
        .fs-lbl { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 2px;}

        textarea {
            width: 100%; padding: 15px; background: #132034; border: 1px solid #3d5457;
            color: white; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px; margin-bottom: 14px; resize: vertical;
        }

        .btn-save { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; box-shadow: 0 4px 17px rgba(16, 185, 129, 0.10); letter-spacing:0.03em; }
        .btn-save:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-save:disabled { opacity: 0.44; cursor: not-allowed; transform: none; background: #64748b; color:#ececec; }

        .close-modal-btn { position: absolute; right: 20px; top: 20px; background: rgba(3,13,47,0.12); width: 33px; height: 33px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; z-index: 10; font-size:25px; font-weight:900; transition:.18s;}
        .close-modal-btn:hover {background: #3b506e; color:#fbbf24;}

        #loading { text-align: center; padding: 47px; color: #94a3b8; font-size: 15px; }
        .spinner { width: 26px; height: 26px; border: 3px solid rgba(255,255,255,0.08); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { to {transform: rotate(360deg);} }

        .footer-fixed {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #0f181a; border-top: 1px solid rgba(16,185,129,0.17);
            padding: 13px 0; text-align: center; color: #a9b9cf;
            font-size: 12.5px; z-index: 55;
        }
        .footer-fixed a {color: #67e8f9; text-decoration: none;}
    </style>
</head>
<body>

<header>
    <div class="mentor-profile">
        <h2 id="mName">Pembimbing</h2>
        <span id="mGroup">Memuat grup...</span>
    </div>
    <button class="btn-logout" onclick="logout()">Keluar</button>
</header>

<div class="container">
    <div id="mentorNotification" style="display:none; margin-bottom: 24px; padding: 18px; border-radius: 13px; font-size: 14px; line-height: 1.6; box-shadow:0 2px 10px #0f172a0e;"></div>
    
    <div class="filter-container">
        <div class="filter-row">
            <input type="text" id="searchName" placeholder="üîç Cari nama siswa..." oninput="renderList(rawData)" style="flex: 2;">
            <input type="date" id="dateFilter" onchange="loadData()" style="flex: 1.2;">
            <button onclick="loadData()" title="Refresh Data">üîÑ</button>
        </div>
        <div class="filter-chips">
            <div class="chip active" onclick="setFilter('all', this)">Semua <span class="chip-count" id="countAll">0</span></div>
            <div class="chip" onclick="setFilter('pending', this)">Belum Dinilai <span class="chip-count" id="countPending" style="background:var(--danger); color:white">0</span></div>
            <div class="chip" onclick="setFilter('done', this)">Selesai <span class="chip-count" id="countDone" style="background:var(--primary); color:white">0</span></div>
        </div>
    </div>

    <div id="summaryTableWrapper" class="table-responsive" style="display: none;">
        <table class="summary-table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Nama Siswa</th>
                    <th>Isian Kegiatan</th>
                    <th>Status Penilaian</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
        </table>
    </div>

    <div id="loading"><div class="spinner"></div>Mengambil data laporan siswa...</div>
    <div id="studentList" class="card-list"></div>
</div>

<div id="detailModal" class="modal" tabindex="-1">
    <div class="modal-content">
        <div class="close-modal-btn" onclick="closeModal()" aria-label="Tutup">&times;</div>
        
        <div class="inspection-header">
            <div>
                <div class="inspection-label">üß© Dashboard Pemeriksaan Pembimbing</div>
                <h3 id="modalName" style="margin:7px 0 0; font-size:20px;font-weight:800;letter-spacing:0.02em">Nama Siswa</h3>
            </div>
            <div style="text-align:right">
                <small id="modalDate" style="opacity:0.82">Tanggal</small>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tab active" onclick="switchTab('check')"><span style="font-weight:700;">1.</span> Validasi Kegiatan</div>
            <div class="tab" onclick="switchTab('gallery')"><span style="font-weight:700;">2.</span> Bukti Foto</div>
            <div class="tab" onclick="switchTab('grading')"><span style="font-weight:700;">3.</span> Penilaian Akhir</div>
        </div>

        <!-- Tab 1: Validasi -->
        <div id="tab-check" class="tab-content active">
            <div style="margin-bottom:17px; background:rgba(59, 130, 246, 0.14); border:1.2px solid #60a5fa; padding:13px; border-radius:9px; font-size:13px; color:#93c5fd;">
                üìã <b>Langkah 1:</b> Periksa waktu pelaksanaan setiap kegiatan. Centang "Valid" jika sudah sesuai dan masuk akal. Sistem secara otomatis mendeteksi kegiatan terlambat.
            </div>
            
            <div style="background:#181f32; padding:12px; border-radius:8px; margin-bottom:17px; font-style:italic; border-left:3px solid #a9b6d4;">
                <span style="color:#5a6789; font-size:11px;">Catatan/keterangan siswa:</span><br>
                <span id="modalCatatanSiswa" style="color:#f6f2ec; font-size:14px;">"-"</span>
            </div>
            <div class="validation-list" id="validationContainer"></div>
        </div>

        <!-- Tab 2: Foto Bukti -->
        <div id="tab-gallery" class="tab-content">
            <div style="margin-bottom:13px; font-size:13px; color:#97bbcf; text-align:center;">
                Pastikan foto <b>jelas, asli</b> (bukan foto karpet/ulang), dan sesuai kegiatan terkait.
            </div>
            <div id="photoGalleryContainer" class="photo-grid"></div>
        </div>

        <!-- Tab 3: Penilaian Akhir -->
        <div id="tab-grading" class="tab-content">
            <div class="rubric-container">
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kedisiplinan Waktu <small>(40%)</small></span>
                        <span id="valR1">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R1', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kelengkapan Bukti <small>(30%)</small></span>
                        <span id="valR2">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R2', this.value)">
                </div>
                <div class="rubric-row">
                    <div class="rubric-header">
                        <span>Kualitas Ibadah/Kejujuran <small>(30%)</small></span>
                        <span id="valR3">80</span>
                    </div>
                    <input type="range" class="rubric-range" min="0" max="100" value="80" oninput="updateRubric('R3', this.value)">
                </div>
            </div>

            <div class="final-score-box">
                <span class="fs-lbl">Nilai Akhir Terhitung</span>
                <span class="fs-val" id="finalScoreDisplay">80</span>
            </div>

            <label style="font-size:13px; color:#a7b7d5; display:block; margin-bottom:6px;font-weight:600;">Evaluasi/Komentar untuk Siswa:</label>
            <textarea id="inputCatatanPembimbing" rows="3" placeholder="Tulis umpan balik untuk penguatan atau perbaikan..."></textarea>
            
            <button id="btnSave" class="btn-save" onclick="saveGrade()" disabled>üîí Validasi Kegiatan Belum Lengkap</button>
            <div style="text-align:center; font-size:11px; color:#64748b; margin-top:7px;">
                <span style="background:rgba(59,130,246,0.07);padding:3px 9px;border-radius:7px;">Tombol aktif jika validasi sudah lengkap di Tab 1</span>
            </div>
        </div>
    </div>
</div>

<div class="footer-fixed">
    &copy; 2026 E-KAROMAH. <span style="opacity:.9;">Aplikasi pembimbing profesional.</span> Developer <a href="https://www.kangruli.web.id/" target="_blank">Kang Ruli</a>
</div>

<script>
// ================= KONFIGURASI & INISIALISASI =================
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyq-CZX7ploDor-n5DmG0j987kYglYjmQnk0D4yy039pK00K2RVtL1N4wuYWhfi_ctNzg/exec"; 

const activityConfig = [
    { key: "Sahur", label: "Makan Sahur", hasPhoto: true, max: "04:30" },
    { key: "Subuh", label: "Sholat Subuh", hasPhoto: true, max: "05:15" },
    { key: "Dzuhur", label: "Sholat Dzuhur", hasPhoto: true, max: "13:00" },
    { key: "Ashar", label: "Sholat Ashar", hasPhoto: true, max: "16:00" },
    { key: "Buka", label: "Buka Puasa", hasPhoto: true, max: "18:30" },
    { key: "Magrib", label: "Sholat Magrib", hasPhoto: true, max: "18:45" },
    { key: "Isya", label: "Sholat Isya", hasPhoto: true, max: "20:00" },
    { key: "Tarawih", label: "Sholat Tarawih", hasPhoto: true, max: "21:00" },
    { key: "Tadarus", label: "Tadarus Quran", hasPhoto: true, max: null },
    { key: "Olahraga", label: "Olahraga", hasPhoto: true, max: null },
    { key: "Pesantren", label: "Kegiatan Pesantren", hasPhoto: true, max: null },
    { key: "Keluarga", label: "Bantu Orang Tua", hasPhoto: false, max: null }
];

let rawData = [];
let selectedItem = null;
let currentFilterType = 'all';
let validationState = {}; 

// Cek login
const user = JSON.parse(localStorage.getItem("user"));
if(!user || user.role !== 'pembimbing'){
    alert("‚õî Akses ditolak. Silakan login sebagai Pembimbing."); 
    window.location.href='index.html';
}

// Profil Pembimbing
document.getElementById('mName').textContent = user.nama || "Pembimbing";
document.getElementById('mGroup').textContent = "Kelompok: " + (user.kelompok || "-");
document.getElementById('dateFilter').valueAsDate = new Date();

function logout() {
    if(confirm("Apakah Anda yakin ingin keluar?")) {
        localStorage.removeItem("user");
        window.location.href = "index.html";
    }
}

function formatTglIndo(isoDate) {
    if(!isoDate) return "-";
    const d = new Date(isoDate);
    if(isNaN(d.getTime())) return isoDate; 
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    return d.toLocaleDateString('id-ID', options);
}

// Load rekap data
async function loadData() {
    const list = document.getElementById("studentList");
    const loader = document.getElementById("loading");
    const dateInput = document.getElementById("dateFilter").value;
    const tableWrapper = document.getElementById("summaryTableWrapper");

    list.innerHTML = "";
    if (tableWrapper) tableWrapper.style.display = "none";
    loader.style.display = "block";

    try {
        const url = `${WEB_APP_URL}?action=rekapPembimbing&kelompok=${encodeURIComponent(user.kelompok)}`;
        const res = await fetch(url);
        const data = await res.json();

        let groupedData = {};

        data.forEach(item => {
            let namaSiswa = (item.Nama || item.nama || "").trim();
            let itemDate = "";

            if (item.Tanggal) {
                if (/^\d{4}-\d{2}-\d{2}/.test(item.Tanggal)) {
                    let tglObj;
                    if (item.Tanggal.includes("T")) {
                        try {
                            tglObj = new Date(item.Tanggal);
                            let tglWIBDate = new Date(tglObj.getTime() + (7 * 60 * 60 * 1000));
                            const year = tglWIBDate.getFullYear();
                            const month = String(tglWIBDate.getMonth() + 1).padStart(2, '0');
                            const day = String(tglWIBDate.getDate()).padStart(2, '0');
                            itemDate = `${year}-${month}-${day}`; 
                        } catch (e) {
                            const d = new Date(item.Tanggal);
                            const year = d.getFullYear();
                            const month = String(d.getMonth() + 1).padStart(2, '0');
                            const day = String(d.getDate()).padStart(2, '0');
                            itemDate = `${year}-${month}-${day}`; 
                        }
                    } else {
                        itemDate = item.Tanggal.substring(0,10);
                    }
                } else {
                    const d = new Date(item.Tanggal);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    itemDate = `${year}-${month}-${day}`; 
                }
            }
            
            let key = `${namaSiswa}_${itemDate}`;

            if (!groupedData[key]) {
                groupedData[key] = { ...item };
                groupedData[key]._filterDate = itemDate;
            } else {
                activityConfig.forEach(act => {
                    const statusSiswa = item[act.key] || item[act.key+'_Status'] || "";
                    if (String(statusSiswa).toLowerCase().includes('ya')) {
                        groupedData[key][act.key] = statusSiswa;
                        const w1 = act.key + '_Waktu'; const w2 = 'Waktu_' + act.key;
                        if (item[w1] && item[w1] !== "-") groupedData[key][w1] = item[w1];
                        if (item[w2] && item[w2] !== "-") groupedData[key][w2] = item[w2];

                        const f1 = act.key + '_Foto'; const f2 = 'Foto_' + act.key;
                        if (item[f1] && item[f1] !== "-") groupedData[key][f1] = item[f1];
                        if (item[f2] && item[f2] !== "-") groupedData[key][f2] = item[f2];
                    }
                });

                if (item.id || item.row) {
                    groupedData[key].id = item.id || item.row;
                    groupedData[key].row = item.id || item.row;
                }

                if(item.Catatan && item.Catatan !== "-" && String(item.Catatan).trim() !== "") {
                    if (!groupedData[key].Catatan || groupedData[key].Catatan === "-") {
                        groupedData[key].Catatan = item.Catatan;
                    } else if (!groupedData[key].Catatan.includes(item.Catatan)) {
                        groupedData[key].Catatan += " | " + item.Catatan;
                    }
                }

                if (item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2) {
                    groupedData[key].Nilai_Pembimbing = item.Nilai_Pembimbing;
                }
            }
        });

        let mergedArray = Object.values(groupedData);

        let myStudents = [];
        if(dateInput && mergedArray.length > 0) {
            myStudents = mergedArray.filter(item => item._filterDate === dateInput);
        } else {
            myStudents = mergedArray;
        }

        rawData = myStudents;
        updateCountChips(rawData);

        if(myStudents.length === 0) {
            loader.innerHTML = `<div style="padding:44px 0; text-align:center; color:#94a3b8; font-size:15px;">üå± Tidak ada laporan pada tanggal <b>${dateInput}</b>.</div>`;
            return;
        }
        renderList(rawData);
        loader.style.display = "none";

    } catch(e) {
        console.error(e);
        loader.innerHTML = `<div style="color:var(--danger); padding:22px; text-align:center;">Gagal memuat data. <br>Cek koneksi internet atau klik refresh.</div>`;
    }
}

function updateCountChips(data) {
    const pending = data.filter(item => !hasGrade(item)).length;
    const done = data.filter(item => hasGrade(item)).length;

    document.getElementById("countAll").textContent = data.length;
    document.getElementById("countPending").textContent = pending;
    document.getElementById("countDone").textContent = done;

    // Notifikasi motivasi pembimbing
    const notifBox = document.getElementById("mentorNotification");
    if (!notifBox) return;

    if (data.length === 0) {
        notifBox.style.display = "none";
        return;
    }
    notifBox.style.display = "block";
    notifBox.style.fontFamily = 'Poppins,sans-serif';
    notifBox.style.boxShadow = '0 2px 12px #0f172a18';

    if (pending > 0) {
        notifBox.style.background = "rgba(251, 191, 36, 0.11)";
        notifBox.style.border = "1px solid var(--gold)";
        notifBox.style.color = "#fbbf24";
        notifBox.innerHTML = `
            <div style="font-weight:bold; margin-bottom:9px; font-size:15px; color:var(--gold);letter-spacing:.02em">
                ‚ö†Ô∏è Ada ${pending} Laporan Siswa Belum Dinilai
            </div>
            <i style="opacity:0.9;font-size:12px;">"Orang yang mengajarkan kebaikan kepada orang lain, seperti pahalanya orang yang mengerjakannya." (HR. Muslim)</i>
            <div style="margin-top:8px; opacity:0.92; font-size:13px;">
                Yth. Pembimbing, mari maksimalkan dedikasi Anda dalam mendampingi siswa. <b>Penilaian cepat dan komentar Anda membantu membentuk karakter ibadah dan akhlak mereka.</b>
            </div>
        `;
    } else {
        notifBox.style.background = "rgba(16, 185, 129, 0.13)"; 
        notifBox.style.border = "1px solid var(--primary)";
        notifBox.style.color = "#24e694";
        notifBox.innerHTML = `
            <div style="font-weight:bold; margin-bottom:8px; font-size:15px; color:var(--primary);letter-spacing:.02em">
                üéâ Semua Laporan Hari Ini Sudah Dinilai!
            </div>
            <i style="opacity:0.9; font-size:12px;">"Sebaik-baik manusia adalah yang paling bermanfaat untuk orang lain." (HR. Ahmad)</i>
            <div style="margin-top:7px; opacity:0.9; font-size:13px;">
                Terima kasih atas <b>keteladanan & perhatian Anda</b>. Semoga penilaian dan usaha Anda menjadi amal berkelanjutan!
            </div>
        `;
    }
}

function hasGrade(item){ 
    return item.Nilai_Pembimbing && String(item.Nilai_Pembimbing).length > 2; 
}

// Filter/Tab chips handler
function setFilter(type, el) {
    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    currentFilterType = type;
    renderList(rawData);
}

// Render List & Table
function renderList(data) {
    const list = document.getElementById("studentList");
    const tableWrapper = document.getElementById("summaryTableWrapper");
    const tableBody = document.getElementById("summaryTableBody");

    list.innerHTML = "";
    if (tableBody) tableBody.innerHTML = "";

    const searchInput = document.getElementById("searchName");
    const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";

    let displayData = data;

    if(currentFilterType === 'pending') displayData = data.filter(item => !hasGrade(item));
    else if(currentFilterType === 'done') displayData = data.filter(item => hasGrade(item));

    if(searchTerm) {
        displayData = displayData.filter(item => {
            const namaSiswa = item.Nama || item.nama || "";
            return namaSiswa.toLowerCase().includes(searchTerm);
        });
    }

    displayData.sort((a,b) => {
        const nameA = (a.Nama || a.nama || "").toLowerCase();
        const nameB = (b.Nama || b.nama || "").toLowerCase();
        return nameA.localeCompare(nameB);
    });

    if(displayData.length === 0) {
        if(tableWrapper) tableWrapper.style.display = "none";
        list.innerHTML = `<div style="text-align:center; padding:40px 0; color:#94a3b8; font-size:14px;">Tidak ada data laporan siswa untuk filter ini.</div>`;
        return;
    }

    if(tableWrapper) tableWrapper.style.display = "block";

    displayData.forEach((item, index) => {
        if (tableBody) {
            let doneCount = 0;
            activityConfig.forEach(act => {
                const val = item[act.key] || item[act.key+'_Status'] || "";
                if(String(val).toLowerCase().includes('ya')) doneCount++;
            });

            const isDone = hasGrade(item);
            const statusHtml = isDone
                    ? `<span class="status-badge status-sudah">Sudah Dinilai (‚≠ê ${item.Nilai_Pembimbing})</span>`
                    : `<span class="status-badge status-belum">Belum Dinilai</span>`;

            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${index + 1}</td>
                <td style="font-weight: 700; color: white;">${item.Nama || item.nama}</td>
                <td>${doneCount} / ${activityConfig.length} Terisi</td>
                <td>${statusHtml}</td>
            `;
            tr.onclick = () => openInspectionMode(item);
            tableBody.appendChild(tr);
        }

        list.appendChild(createCard(item));
    });
}

// Kartu siswa panel overview
function createCard(item) {
    let doneCount = 0;
    activityConfig.forEach(act => {
        const val = item[act.key] || item[act.key+'_Status'] || "";
        if(String(val).toLowerCase().includes('ya')) doneCount++;
    });

    const totalActs = activityConfig.length;
    const progressPct = Math.round((doneCount / totalActs) * 100);
    const isDone = hasGrade(item);

    const badgeHtml = isDone 
        ? `<span class="badge badge-done" style="background:var(--primary); color:#fff;">‚≠ê NILAI : ${item.Nilai_Pembimbing}</span>` 
        : `<span class="badge badge-pending">Belum Dinilai</span>`;

    const progressColor = progressPct >= 80 ? '#34d399' : (progressPct >= 50 ? '#fbbf24' : '#ef4444');

    const card = document.createElement("div");
    card.className = `student-card ${isDone ? 'done' : 'priority'}`;

    const catatanHtml = (isDone && item.Catatan_Pembimbing && item.Catatan_Pembimbing !== "-") 
        ? `<div style="margin-top:11px; background:rgba(0,0,0,0.12); padding:10px; border-radius:7px; font-size:12px; color:#d9f1e0; border-left:3px solid var(--primary);">üí¨ <i>${item.Catatan_Pembimbing}</i></div>`
        : ``;

    card.innerHTML = `
        <div class="card-top">
            <div>
                <h3 class="st-name">${item.Nama || item.nama}</h3>
                <span class="st-date">üìÖ ${formatTglIndo(item._filterDate || item.Tanggal)}</span>
            </div>
            ${badgeHtml}
        </div>
        <div class="progress-area">
            <span>Isian: <b>${doneCount}/${totalActs}</b></span>
            <div class="progress-track">
                <div class="progress-fill" style="width: ${progressPct}%; background:${progressColor}"></div>
            </div>
            <span class="score-preview" style="color:${progressColor}">${progressPct}%</span>
        </div>
        ${catatanHtml}
    `;
    card.onclick = () => openInspectionMode(item);
    return card;
}


// INSPECTION MODAL & VALIDASI
function openInspectionMode(item) {
    selectedItem = item;
    validationState = {}; 

    document.getElementById("modalName").textContent = item.Nama || item.nama;
    document.getElementById("modalDate").textContent = formatTglIndo(item._filterDate || item.Tanggal);
    document.getElementById("modalCatatanSiswa").textContent = item.Catatan ? `"${item.Catatan}"` : "-";

    renderValidationList(item);
    renderPhotoGallery(item);
    setupGrading(item);

    switchTab('check'); 
    checkValidationCompletion();
    document.getElementById("detailModal").style.display = "block";
}

function closeModal() {
    document.getElementById("detailModal").style.display = "none";
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

    const tabs = document.querySelectorAll('.tab');
    if(tabName === 'check') tabs[0].classList.add('active');
    if(tabName === 'gallery') tabs[1].classList.add('active');
    if(tabName === 'grading') tabs[2].classList.add('active');

    document.getElementById(`tab-${tabName}`).classList.add('active');
}

// Render Validasi Tab
function renderValidationList(item) {
    const container = document.getElementById("validationContainer");
    container.innerHTML = "";

    activityConfig.forEach(act => {
        const status = item[act.key] || item[act.key+'_Status'] || "-";
        let rawWaktu = item[act.key+'_Waktu'] || item['Waktu_'+act.key] || "-";
        
        let waktu = rawWaktu;
        if (String(waktu).includes('T')) {
            try {
                waktu = String(waktu).split('T')[1].substring(0, 5); 
            } catch(e) {
                waktu = "-";
            }
        }
        
        const isYa = String(status).toLowerCase().includes("ya");

        let anomalyHtml = "";
        let timeColor = "#6dbff7";

        if(isYa && act.max && waktu !== "-") {
            const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if(timePattern.test(waktu)) {
                if(waktu > act.max) {
                    anomalyHtml = `<span class="anomaly-badge">‚ö†Ô∏è Terlambat (Batas: ${act.max})</span>`;
                    timeColor = "#ef4444";
                }
            }
        }

        const needsCheck = isYa; 
        const checkId = `chk_${act.key}`;
        
        const isYaHtml = isYa ? `<span style="color:#059669; font-weight:700; font-size:12px;">‚úÖ Selesai</span>` : `<span style="color:#979caf; font-size:12px;">‚ùå Tidak Diisi</span>`;
        let checkBoxHtml = "";

        if (needsCheck) {
            checkBoxHtml = `
            <div class="check-box-wrapper">
                <input type="checkbox" id="${checkId}" class="check-input" onchange="handleValidationChange('${act.key}', this.checked)">
                <label for="${checkId}" class="check-label">Valid</label>
            </div>`;
        } else {
            checkBoxHtml = `<span style="font-size:12px; color:#64748b; padding: 6px 14px; background: #1e293b; border-radius: 23px;">Lewati</span>`;
        }

        const div = document.createElement("div");
        div.className = "val-item";
        div.innerHTML = `
            <div class="val-info">
                <span class="val-title">${act.label} ${isYaHtml}</span>
                <span class="val-time" style="color:${timeColor}">‚è∞ Pukul: ${waktu} ${anomalyHtml}</span>
            </div>
            ${checkBoxHtml}
        `;
        container.appendChild(div);
    });
}

function handleValidationChange(key, isChecked) {
    validationState[key] = isChecked;
    checkValidationCompletion();
}

function checkValidationCompletion() {
    let requiredCount = 0;
    let checkedCount = 0;

    activityConfig.forEach(act => {
        const status = selectedItem[act.key] || selectedItem[act.key+'_Status'] || "";
        if (String(status).toLowerCase().includes("ya")) {
            requiredCount++;
            if (validationState[act.key]) checkedCount++;
        }
    });

    const btnSave = document.getElementById("btnSave");
    if (requiredCount === 0 || checkedCount === requiredCount) {
        btnSave.disabled = false;
        btnSave.innerHTML = "üíæ Simpan & Selesaikan Penilaian";
        btnSave.style.background = "var(--primary)";
    } else {
        btnSave.disabled = true;
        btnSave.innerHTML = `üîí Validasi Kegiatan Belum Lengkap (${checkedCount}/${requiredCount})`;
        btnSave.style.background = "#64748b";
    }
}

// Tab 2: Foto Bukti
function renderPhotoGallery(item) {
    const container = document.getElementById("photoGalleryContainer");
    container.innerHTML = "";
    let hasPhoto = false;

    activityConfig.forEach(act => {
        if (act.hasPhoto) {
            const f1 = act.key + '_Foto'; 
            const f2 = 'Foto_' + act.key;
            let photoUrl = item[f1] || item[f2] || "";

            if (photoUrl && photoUrl !== "-" && photoUrl.includes("http")) {
                hasPhoto = true;
                const div = document.createElement("div");
                div.className = "photo-item";
                div.innerHTML = `
                    <img src="${photoUrl}" alt="${act.label}" onclick="window.open('${photoUrl}', '_blank')">
                    <div class="photo-label">${act.label}</div>
                `;
                container.appendChild(div);
            }
        }
    });

    if (!hasPhoto) {
        container.innerHTML = `<div class="no-photo-alert">Siswa tidak melampirkan foto bukti relevan.</div>`;
    }
}

// Tab 3: Rubrik Penilaian
function setupGrading(item) {
    document.querySelectorAll('.rubric-range').forEach(el => el.value = 80);
    updateRubric('R1', 80);
    updateRubric('R2', 80);
    updateRubric('R3', 80);

    document.getElementById("inputCatatanPembimbing").value = item.Catatan_Pembimbing || "";
}
function updateRubric(id, val) {
    document.getElementById(`val${id}`).textContent = val;
    calculateFinalScore();
}

function calculateFinalScore() {
    const r1 = parseInt(document.getElementById("valR1").textContent) || 0; 
    const r2 = parseInt(document.getElementById("valR2").textContent) || 0; 
    const r3 = parseInt(document.getElementById("valR3").textContent) || 0; 

    const totalScore = Math.round((r1 * 0.4) + (r2 * 0.3) + (r3 * 0.3));
    document.getElementById("finalScoreDisplay").textContent = totalScore;
    return totalScore;
}

// Penyimpanan nilai
async function saveGrade() {
    const btnSave = document.getElementById("btnSave");
    const finalScore = calculateFinalScore();
    const catatan = document.getElementById("inputCatatanPembimbing").value;

    if (!selectedItem.row && !selectedItem.id) {
        alert("Error: ID Baris (Row) tidak ditemukan.");
        return;
    }

    btnSave.disabled = true;
    btnSave.innerHTML = `<div class="spinner" style="width:16px; height:16px; display:inline-block; margin:0 5px -3px 0;"></div> MENYIMPAN...`;

    try {
        const formData = new URLSearchParams();
        formData.append("action", "nilaiPembimbing");
        formData.append("row", selectedItem.row || selectedItem.id);
        formData.append("nilai", finalScore);
        formData.append("catatan", catatan);

        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (result.status === 'success' || result.sukses) {
            alert("‚úÖ Penilaian berhasil disimpan!");
            closeModal();
            loadData(); 
        } else {
            alert("Gagal menyimpan data: " + (result.message || "Unknown error"));
            btnSave.disabled = false;
            btnSave.innerHTML = "üíæ COBA LAGI";
        }
    } catch (e) {
        console.error("Error saving grade:", e);
        alert("‚ö†Ô∏è Terjadi kesalahan jaringan. Cek koneksi internet Anda.");
        btnSave.disabled = false;
        btnSave.innerHTML = "üíæ COBA LAGI";
    }
}

window.onload = function() {
    loadData();
};
</script>
</body>
</html>
