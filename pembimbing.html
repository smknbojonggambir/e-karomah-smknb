<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Pembimbing Pro - E-KAROMAH</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* =======================
   CSS TIDAK DIUBAH
======================= */
body{margin:0;font-family:Poppins;background:#0f172a;color:#fff}
.container{max-width:800px;margin:20px auto;padding:0 15px}
.student-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:15px;margin-bottom:10px;cursor:pointer}
.student-card.priority{border-left:4px solid #ef4444}
.student-card.done{border-left:4px solid #10b981}
.badge{font-size:10px;padding:4px 8px;border-radius:6px;font-weight:bold}
.badge-done{background:#10b981;color:white}
.badge-pending{background:#ef4444;color:white}
.progress-track{height:6px;background:#334155;border-radius:3px;overflow:hidden}
.progress-fill{height:100%}
</style>
</head>
<body>

<div class="container">
<input type="date" id="dateFilter" onchange="loadData()">
<button onclick="loadData()">ðŸ”„</button>

<div id="studentList"></div>
<div id="loading">Loading...</div>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbz9YCqyJTYQkOfljm1Pbqxy7QoCw9apkHBhDYRVwjRHcihPDN1hn5vpyxkoJ9HqkFCv5g/exec";

let rawData=[];
const user=JSON.parse(localStorage.getItem("user"));
if(!user||user.role!=="pembimbing"){
alert("Akses ditolak");location.href="index.html";
}

document.getElementById('dateFilter').valueAsDate=new Date();

/* ==========================================
   LOAD DATA BARU (FIX REKAP HARIAN)
========================================== */
async function loadData(){
const list=document.getElementById("studentList");
const loader=document.getElementById("loading");
const filterDate=document.getElementById("dateFilter").value;

list.innerHTML="";
loader.style.display="block";

try{
/* ðŸ”¹ PENTING:
   Ambil SEMUA data kelompok
   Jangan filter dari backend
*/
const url=`${WEB_APP_URL}?action=rekapPembimbing&kelompok=${encodeURIComponent(user.kelompok)}`;
const res=await fetch(url);
const data=await res.json();

/* ðŸ”¹ FILTER HARIAN DI SINI (REKAP ADMIN) */
let filteredData=data;

if(filterDate){
filteredData=data.filter(item=>{
if(!item.Tanggal) return false;
const d=new Date(item.Tanggal);
const iso=d.toISOString().split("T")[0];
return iso===filterDate;
});
}

rawData=filteredData;

if(filteredData.length===0){
loader.innerHTML=`<div style="padding:40px;text-align:center">Tidak ada laporan pada tanggal ini</div>`;
return;
}

renderList(filteredData);
loader.style.display="none";

}catch(e){
loader.innerHTML="Gagal load data";
console.error(e);
}
}

/* ==========================================
   RENDER LIST
========================================== */
function renderList(data){
const list=document.getElementById("studentList");
list.innerHTML="";

data.forEach(item=>{
list.appendChild(createCard(item));
});
}

function createCard(item){

let doneCount=0;
Object.keys(item).forEach(k=>{
if(String(item[k]).toLowerCase().includes("ya")) doneCount++;
});

const progressPct=Math.min(doneCount,100);
const isDone=item.Nilai_Pembimbing&&item.Nilai_Pembimbing.length>2;

const card=document.createElement("div");
card.className=`student-card ${isDone?'done':'priority'}`;

card.innerHTML=`
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<b>${item.Nama||item.nama}</b><br>
<small>${item.Tanggal||'-'}</small>
</div>
<span class="badge ${isDone?'badge-done':'badge-pending'}">
${isDone?'SUDAH DINILAI':'PERLU INSPEKSI'}
</span>
</div>

<div style="margin-top:10px">
<div class="progress-track">
<div class="progress-fill" style="width:${progressPct}%;background:${progressPct>70?'#10b981':'#ef4444'}"></div>
</div>
</div>
`;

return card;
}

loadData();
</script>

</body>
</html>
