<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-KAROMAH SMKNB</title>

<style>
:root{
  --primary:#2563eb;
  --bg1:#0f172a;
  --bg2:#1e293b;
  --glass:rgba(255,255,255,0.08);
}

*{margin:0;padding:0;box-sizing:border-box}

body{
  font-family:system-ui;
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  color:#fff;
  min-height:100vh;
  padding:20px;
}

.container{
  max-width:900px;
  margin:auto;
}

.header{
  text-align:center;
  margin-bottom:25px;
}

.logo{
  width:100px;
  background:#fff;
  padding:8px;
  border-radius:50%;
}

.card{
  background:var(--glass);
  backdrop-filter:blur(14px);
  padding:25px;
  border-radius:18px;
}

select,input,textarea{
  width:100%;
  padding:11px;
  margin:8px 0 15px;
  border-radius:10px;
  border:none;
}

.section{
  background:rgba(255,255,255,0.05);
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

.radio-group{
  display:flex;
  gap:20px;
}

button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#2563eb;
  color:white;
  font-weight:600;
}

.hidden{display:none}

.loader{
  text-align:center;
  margin-top:10px;
  display:none;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
<img class="logo"
src="https://raw.githubusercontent.com/smknbojonggambir/E-RAMADHAN-SMKNB/main/LOGO.png">
<h2>E-KAROMAH SMKNB</h2>
</div>

<div class="card">

<select id="kelompok" onchange="loadNama()">
<option value="">Pilih Kelompok</option>
</select>

<select id="nama" onchange="tampilForm()" disabled>
<option value="">Pilih Nama</option>
</select>

<input type="text" id="pembimbing" readonly>

<!-- GPS -->
<input type="hidden" id="lat">
<input type="hidden" id="long">

<div id="formInput" class="hidden">

<div id="dynamicForm"></div>

<button onclick="kirim()">KIRIM</button>

<div class="loader" id="loader">Mengirim...</div>

</div>

</div>
</div>

<script>

const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzVdZoXoZLUREfuu1k1i5BNhySWcDqrKs-VnF0oMZpCLT8NAGETKHBgrPGtK-oOC8M8Ew/exec";

/* ================= GPS ================= */

function getLocation(){

  if(!navigator.geolocation){
    alert("GPS tidak didukung");
    return;
  }

  navigator.geolocation.getCurrentPosition(

    pos=>{
      lat.value  = pos.coords.latitude;
      long.value = pos.coords.longitude;
    },

    err=>{
      alert("Aktifkan GPS!");
    },

    {enableHighAccuracy:true}

  );
}


/* ================= FORM ================= */

function toggle(id,show){
  document.getElementById(id).classList.toggle("hidden",!show);
}

function radioSection(title,id,withFoto=false,withTime=false){

return `
<div class="section">

<h4>${title}</h4>

<div class="radio-group">

<label>
<input type="radio" name="${id}" value="Ya"
onclick="toggle('${id}_d',true)"> Ya
</label>

<label>
<input type="radio" name="${id}" value="Tidak"
onclick="toggle('${id}_d',false)"> Tidak
</label>

</div>

<div id="${id}_d" class="hidden">

${withTime?`<input type="time" id="${id}_waktu">`:""}

${withFoto?`<input type="file" id="${id}_foto" accept="image/*">`:""}

<textarea id="${id}_ket"></textarea>

</div>
</div>
`;
}


/* ================= LOAD ================= */

async function loadKelompok(){

  const r=await fetch(WEB_APP_URL+"?action=getKelompok");
  const d=await r.json();

  d.forEach(x=>{
    kelompok.innerHTML+=`<option>${x}</option>`;
  });

}

async function loadNama(){

  if(!kelompok.value) return;

  const r=await fetch(
    WEB_APP_URL+"?action=getNama&kelompok="+kelompok.value
  );

  const d=await r.json();

  nama.innerHTML='<option></option>';

  d.forEach(x=>{
    nama.innerHTML+=`<option>${x}</option>`;
  });

  nama.disabled=false;
}

async function tampilForm(){

  const r=await fetch(
    WEB_APP_URL+"?action=getPembimbing&kelompok="+kelompok.value
  );

  pembimbing.value=await r.text();

  formInput.classList.remove("hidden");

  generateForm();
}


/* ================= GENERATE ================= */

function generateForm(){

  dynamicForm.innerHTML=

  radioSection("Sahur","sahur",true,true)+
  radioSection("Subuh","subuh")+
  radioSection("Olahraga","olahraga",true)+
  radioSection("Keluarga","keluarga",true)+
  radioSection("Dzuhur","dzuhur")+
  radioSection("Pesantren","pesantren",true)+
  radioSection("Ashar","ashar")+
  radioSection("Aksi","aksi",true)+
  radioSection("Buka","buka",true)+
  radioSection("Magrib","magrib")+
  radioSection("Isya","isya")+
  radioSection("Tarawih","tarawih")+
  radioSection("Tadarus","tadarus",true)+
  radioSection("Tidur","tidur",false,true);

}


/* ================= SUBMIT ================= */

async function kirim(){

  loader.style.display="block";

  let fd=new FormData();

  fd.append("action","simpan");

  fd.append("kelompok",kelompok.value);
  fd.append("nama",nama.value);
  fd.append("pembimbing",pembimbing.value);

  fd.append("lat",lat.value);
  fd.append("long",long.value);

  const list=[
    "sahur","subuh","olahraga","keluarga","dzuhur",
    "pesantren","ashar","aksi","buka","magrib",
    "isya","tarawih","tadarus","tidur"
  ];

  for(let id of list){

    let st=document.querySelector(`input[name="${id}"]:checked`);

    fd.append(id+"_status",st?st.value:"Tidak");

    let w=document.getElementById(id+"_waktu");
    if(w) fd.append(id+"_waktu",w.value);

    let k=document.getElementById(id+"_ket");
    if(k) fd.append(id+"_ket",k.value);

    let f=document.getElementById(id+"_foto");

    if(f && f.files[0]){

      let reader=new FileReader();

      await new Promise(r=>{

        reader.onload=()=>{

          fd.append(id+"_foto",reader.result);
          r();

        };

        reader.readAsDataURL(f.files[0]);

      });

    }

  }

  await fetch(WEB_APP_URL,{
    method:"POST",
    body:fd
  });

  alert("Berhasil!");

  loader.style.display="none";

  location.reload();
}


/* ================= INIT ================= */

loadKelompok();
getLocation();

</script>
</body>
</html>
