<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Laporan Siswa Online</title>

<style>

body{
    font-family: Arial, sans-serif;
    background:#f4f6f9;
    margin:0;
}

.container{
    max-width:900px;
    margin:auto;
    background:white;
    padding:20px;
    margin-top:30px;
    border-radius:8px;
    box-shadow:0 0 10px rgba(0,0,0,0.1);
}

h2{
    text-align:center;
}

input,select,textarea,button{
    width:100%;
    padding:10px;
    margin:5px 0;
}

button{
    background:#3498db;
    color:white;
    border:none;
    cursor:pointer;
}

button:hover{
    background:#2980b9;
}

.hidden{
    display:none;
}

.card{
    border:1px solid #ddd;
    padding:10px;
    margin-bottom:15px;
    border-radius:5px;
}

label{
    font-weight:bold;
}

.status{
    display:flex;
    gap:10px;
}

img{
    max-width:100%;
    margin-top:5px;
}

</style>
</head>

<body>

<div class="container">

<!-- LOGIN -->
<div id="loginBox">

<h2>üîê Login Siswa</h2>

<input type="text" id="username" placeholder="Username">
<input type="password" id="password" placeholder="Password">

<button onclick="login()">Login</button>

<p id="loginMsg"></p>

</div>


<!-- DASHBOARD -->
<div id="dashboard" class="hidden">

<h2>üìã Laporan Kegiatan Harian</h2>

<p><b>Nama:</b> <span id="namaUser"></span></p>
<p><b>Kelompok:</b> <span id="kelompokUser"></span></p>
<p><b>Pembimbing:</b> <span id="pembimbing"></span></p>


<label>Tanggal</label>
<input type="date" id="tanggal">


<div id="formKegiatan"></div>


<button onclick="kirim()">üì§ Kirim Laporan</button>

<p id="status"></p>

</div>

</div>


<script>

/**************** KONFIG ****************/

const API_URL = "PASTE_URL_SCRIPT_KAMU_DISINI"; 
// contoh:
// https://script.google.com/macros/s/AKfycbxxx/exec

/**************** GLOBAL ****************/

let userData = {};

const kegiatanList = [
 "sahur","subuh","olahraga","keluarga","dzuhur",
 "pesantren","ashar","aksi","buka","magrib",
 "isya","tarawih","tadarus","sedekah"
];

const fotoKeys = [
 "sahur","olahraga","keluarga",
 "pesantren","aksi","buka","tadarus"
];


/**************** LOGIN ****************/

function login(){

    let u = document.getElementById("username").value;
    let p = document.getElementById("password").value;

    if(!u || !p){
        alert("Isi username & password");
        return;
    }

    fetch(`${API_URL}?action=login&username=${u}&password=${p}`)
    .then(res=>res.json())
    .then(res=>{

        if(res.status=="success"){

            userData = res;

            document.getElementById("loginBox").classList.add("hidden");
            document.getElementById("dashboard").classList.remove("hidden");

            document.getElementById("namaUser").innerText = res.nama;
            document.getElementById("kelompokUser").innerText = res.kelompok;

            loadPembimbing();
            buatForm();

        }else{
            document.getElementById("loginMsg").innerText="Login gagal!";
        }

    });

}


/**************** PEMBIMBING ****************/

function loadPembimbing(){

    fetch(`${API_URL}?action=getPembimbing&kelompok=${userData.kelompok}`)
    .then(r=>r.text())
    .then(t=>{
        document.getElementById("pembimbing").innerText = t;
        userData.pembimbing = t;
    });

}


/**************** FORM ****************/

function buatForm(){

    let html="";

    kegiatanList.forEach(k=>{

        html+=`

        <div class="card">

        <label>${k.toUpperCase()}</label>

        <div class="status">
            <select id="status_${k}">
                <option value="Tidak">Tidak</option>
                <option value="Ya">Ya</option>
            </select>

            <input type="time" id="waktu_${k}">
        </div>

        <textarea id="ket_${k}" placeholder="Keterangan"></textarea>

        ${
            fotoKeys.includes(k)
            ?
            `<input type="file" accept="image/*" id="foto_${k}">`
            :
            ""
        }

        </div>

        `;

    });

    document.getElementById("formKegiatan").innerHTML = html;

}


/**************** BASE64 ****************/

function toBase64(file){
    return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload=()=>resolve(reader.result);
        reader.onerror=e=>reject(e);
    });
}


/**************** KIRIM ****************/

async function kirim(){

    let data = {
        action:"kirim",
        tanggal: document.getElementById("tanggal").value,
        username:userData.username,
        nama:userData.nama,
        kelompok:userData.kelompok,
        pembimbing:userData.pembimbing,
        kegiatan:{}
    };


    for(let k of kegiatanList){

        let status = document.getElementById(`status_${k}`).value;
        let waktu = document.getElementById(`waktu_${k}`).value;
        let ket   = document.getElementById(`ket_${k}`).value;

        let item = {
            status:status,
            waktu:waktu,
            ket:ket
        };


        if(fotoKeys.includes(k)){

            let file = document.getElementById(`foto_${k}`).files[0];

            if(file){

                let base64 = await toBase64(file);

                item.foto = base64.split(",")[1];
                item.fotoName = file.name;

            }

        }

        data.kegiatan[k]=item;

    }


    document.getElementById("status").innerText="Mengirim...";

    fetch(API_URL,{
        method:"POST",
        body:JSON.stringify(data)
    })
    .then(r=>r.text())
    .then(res=>{

        if(res=="OK"){
            document.getElementById("status").innerText="‚úÖ Berhasil dikirim";
        }else{
            document.getElementById("status").innerText="‚ùå Gagal: "+res;
        }

    });

}

</script>

</body>
</html>
