<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  font-family:Arial;
  background:linear-gradient(135deg,#1e3c72,#2a5298);
  margin:0;padding:20px;
}
.card{
  background:white;
  max-width:600px;
  margin:auto;
  padding:20px;
  border-radius:15px;
}
select,input,textarea,button{
  width:100%;padding:10px;margin:8px 0;
}
button{
  background:#2a5298;color:white;border:none;
}
.hidden{display:none;}
</style>
</head>
<body>

<div class="card">
<h2>E-KAROMAH SMKNB</h2>

<select id="kelompok" onchange="loadNama()">
<option value="">Pilih Kelompok</option>
</select>

<select id="nama" onchange="tampilForm()" disabled>
<option value="">Pilih Nama</option>
</select>

<input type="text" id="pembimbing" readonly>

<div id="formInput" class="hidden">

<input type="time" id="sahur_waktu">
<input type="file" id="sahur_foto" required>

<input type="file" id="olahraga_foto" required>
<input type="file" id="aktivitas_foto" required>
<input type="file" id="pesantren_foto" required>
<input type="file" id="aksi_foto" required>
<input type="file" id="buka_foto" required>
<input type="file" id="tadarus_foto" required>

<select id="subuh_status"><option>Ya</option><option>Tidak</option></select>
<select id="dzuhur_status"><option>Ya</option><option>Tidak</option></select>
<select id="ashar_status"><option>Ya</option><option>Tidak</option></select>
<select id="magrib_status"><option>Ya</option><option>Tidak</option></select>
<select id="isya_status"><option>Ya</option><option>Tidak</option></select>
<select id="taraweh_status"><option>Ya</option><option>Tidak</option></select>
<select id="sedekah_status"><option>Ya</option><option>Tidak</option></select>

<button onclick="kirim()">Simpan</button>

</div>
</div>

<script>

function loadKelompok(){
google.script.run.withSuccessHandler(function(data){
let s=document.getElementById("kelompok");
data.forEach(k=>{
let o=document.createElement("option");
o.value=k;o.text=k;s.appendChild(o);
});
}).getKelompok();
}

function loadNama(){
let k=document.getElementById("kelompok").value;
google.script.run.withSuccessHandler(function(data){
let s=document.getElementById("nama");
s.innerHTML='<option>Pilih Nama</option>';
data.forEach(n=>{
let o=document.createElement("option");
o.value=n;o.text=n;s.appendChild(o);
});
s.disabled=false;
}).getNamaByKelompok(k);
}

function tampilForm(){
let k=document.getElementById("kelompok").value;
google.script.run.withSuccessHandler(function(p){
document.getElementById("pembimbing").value=p;
document.getElementById("formInput").classList.remove("hidden");
}).getPembimbingByKelompok(k);
}

async function kirim(){

function getBase64(id){
return new Promise(resolve=>{
let file=document.getElementById(id).files[0];
let reader=new FileReader();
reader.onload=()=>resolve(reader.result);
reader.readAsDataURL(file);
});
}

navigator.geolocation.getCurrentPosition(async function(pos){

let data={
nama:document.getElementById("nama").value,
kelompok:document.getElementById("kelompok").value,
pembimbing:document.getElementById("pembimbing").value,
lat:pos.coords.latitude,
long:pos.coords.longitude,

sahur_waktu:document.getElementById("sahur_waktu").value,

sahur_foto:await getBase64("sahur_foto"),
olahraga_foto:await getBase64("olahraga_foto"),
aktivitas_foto:await getBase64("aktivitas_foto"),
pesantren_foto:await getBase64("pesantren_foto"),
aksi_foto:await getBase64("aksi_foto"),
buka_foto:await getBase64("buka_foto"),
tadarus_foto:await getBase64("tadarus_foto"),

subuh_status:document.getElementById("subuh_status").value,
dzuhur_status:document.getElementById("dzuhur_status").value,
ashar_status:document.getElementById("ashar_status").value,
magrib_status:document.getElementById("magrib_status").value,
isya_status:document.getElementById("isya_status").value,
taraweh_status:document.getElementById("taraweh_status").value,
sedekah_status:document.getElementById("sedekah_status").value
};

google.script.run.withSuccessHandler(function(res){
alert(res);
location.reload();
}).simpanData(data);

});
}

loadKelompok();
</script>

</body>
</html>
