<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>E-KAROMAH SMKNB</title>

<style>
*{box-sizing:border-box}

body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
    color:white;
}

.container{
    max-width:850px;
    margin:auto;
    padding:20px;
}

.header{
    text-align:center;
    margin-bottom:25px;
}

.logo{
    width:130px;
    border-radius:50%;
    background:white;
    padding:10px;
    box-shadow:0 10px 25px rgba(0,0,0,0.4);
}

.card{
    background:white;
    color:#333;
    padding:25px;
    border-radius:18px;
    box-shadow:0 15px 35px rgba(0,0,0,0.3);
}

h1{margin-top:15px}

.section{
    border:1px solid #ddd;
    padding:15px;
    margin-bottom:18px;
    border-radius:12px;
    background:#f9f9f9;
}

.section h3{
    margin-top:0;
    font-size:16px;
    color:#2c5364;
}

input,select,textarea{
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:8px;
    border:1px solid #ccc;
}

textarea{resize:vertical}

button{
    width:100%;
    padding:14px;
    background:#2c5364;
    color:white;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    font-size:15px;
    transition:0.3s;
}

button:hover{background:#1e3c72}

.hidden{display:none}

.loader{
    text-align:center;
    margin-top:15px;
    display:none;
    font-weight:bold;
}
</style>
</head>

<body>

<div class="container">

<div class="header">
<img class="logo"
src="https://raw.githubusercontent.com/smknbojonggambir/E-RAMADHAN-SMKNB/main/LOGO.png">
<h1>E-KAROMAH SMKNB</h1>
</div>

<div class="card">

<!-- ================= DATA SISWA ================= -->

<select id="kelompok" onchange="loadNama()">
<option value="">Pilih Kelompok</option>
</select>

<select id="nama" onchange="tampilForm()" disabled>
<option value="">Pilih Nama</option>
</select>

<input type="text" id="pembimbing" placeholder="Pembimbing" readonly>

<!-- ================= FORM KEGIATAN ================= -->

<div id="formInput" class="hidden">

<!-- TEMPLATE FUNCTION -->
<script>
function radioSection(title,id,withFoto=false,withTime=false){
return `
<div class="section">
<h3>${title}</h3>
<label>Apakah melaksanakan?</label><br>
<input type="radio" name="${id}" value="Ya" onclick="toggle('${id}_detail',true)"> Ya
<input type="radio" name="${id}" value="Tidak" onclick="toggle('${id}_detail',false)"> Tidak

<div id="${id}_detail" class="hidden">

${withTime?'<label>Waktu</label><input type="time" id="'+id+'_waktu">':''}

${withFoto?'<label>Upload Foto</label><input type="file" id="'+id+'_foto">':''}

<label>Keterangan (opsional)</label>
<textarea id="${id}_ket"></textarea>

</div>
</div>
`;
}
</script>

<div id="dynamicForm"></div>

<hr>
<button onclick="kirim()">Simpan Data</button>
<div class="loader" id="loader">Mengirim data...</div>

</div>
</div>
</div>

<script>

// ================= CONFIG =================
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbzasLaP_oWkzvsPOkadw4iL-aLfYP7APzfbM-etQQwu7Al4eykdhdY7K4Pacf9RPHg8/exec";

// ================= SHOW/HIDE =================
function toggle(id,show){
document.getElementById(id).style.display=show?"block":"none";
}

// ================= LOAD KELOMPOK =================
async function loadKelompok(){
const res=await fetch(WEB_APP_URL+"?action=getKelompok");
const data=await res.json();
let select=document.getElementById("kelompok");
data.forEach(k=>{
let opt=document.createElement("option");
opt.value=k;
opt.textContent=k;
select.appendChild(opt);
});
}

// ================= LOAD NAMA =================
async function loadNama(){
let kelompok=document.getElementById("kelompok").value;
if(!kelompok)return;
const res=await fetch(WEB_APP_URL+"?action=getNama&kelompok="+encodeURIComponent(kelompok));
const data=await res.json();
let select=document.getElementById("nama");
select.innerHTML='<option value="">Pilih Nama</option>';
data.forEach(n=>{
let opt=document.createElement("option");
opt.value=n;
opt.textContent=n;
select.appendChild(opt);
});
select.disabled=false;
}

// ================= TAMPIL FORM =================
async function tampilForm(){
let kelompok=document.getElementById("kelompok").value;
const res=await fetch(WEB_APP_URL+"?action=getPembimbing&kelompok="+encodeURIComponent(kelompok));
document.getElementById("pembimbing").value=await res.text();
document.getElementById("formInput").classList.remove("hidden");
generateForm();
}

// ================= GENERATE 14 KEGIATAN =================
function generateForm(){
const f=document.getElementById("dynamicForm");
f.innerHTML=
radioSection("1) Bangun Pagi & Sahur","sahur",true,true)+
radioSection("2) Shalat Subuh","subuh")+
radioSection("3) Olahraga","olahraga",true)+
radioSection("4) Aktivitas Bersama Keluarga","keluarga",true)+
radioSection("5) Shalat Dzuhur","dzuhur")+
radioSection("6) Pesantren Ekologi","pesantren",true)+
radioSection("7) Shalat Ashar","ashar")+
radioSection("8) Aksi Ekologi & Sosial","aksi",true)+
radioSection("9) Buka Bersama Keluarga","buka",true)+
radioSection("10) Shalat Magrib","magrib")+
radioSection("11) Shalat Isya","isya")+
radioSection("12) Tarawih","tarawih")+
radioSection("13) Tadarus","tadarus",true)+
radioSection("14) Tidur Cepat","tidur",false,true);
}

// ================= KIRIM DATA =================
async function kirim(){
document.getElementById("loader").style.display="block";

let formData=new FormData();
formData.append("action","simpan");

formData.append("kelompok",kelompok.value);
formData.append("nama",nama.value);
formData.append("pembimbing",pembimbing.value);

let kegiatan=[
"sahur","subuh","olahraga","keluarga","dzuhur",
"pesantren","ashar","aksi","buka","magrib",
"isya","tarawih","tadarus","tidur"
];

kegiatan.forEach(id=>{
let status=document.querySelector('input[name="'+id+'"]:checked');
formData.append(id+"_status",status?status.value:"Tidak");

let waktu=document.getElementById(id+"_waktu");
if(waktu)formData.append(id+"_waktu",waktu.value||"");

let ket=document.getElementById(id+"_ket");
if(ket)formData.append(id+"_ket",ket.value||"");

let foto=document.getElementById(id+"_foto");
if(foto && foto.files[0])formData.append(id+"_foto",foto.files[0]);
});

await fetch(WEB_APP_URL,{method:"POST",body:formData});

alert("Data berhasil dikirim!");
document.getElementById("loader").style.display="none";
location.reload();
}

loadKelompok();

</script>

</body>
</html>
