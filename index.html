<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg,#0f2027,#203a43,#2c5364);
      margin:0;
      padding:20px;
      color:white;
    }

    .card {
      background:white;
      color:black;
      padding:20px;
      border-radius:15px;
      max-width:600px;
      margin:auto;
      box-shadow:0 10px 30px rgba(0,0,0,0.3);
    }

    h2 {
      text-align:center;
      margin-bottom:20px;
    }

    select,input,textarea,button {
      width:100%;
      padding:10px;
      margin:8px 0;
      border-radius:8px;
      border:1px solid #ccc;
    }

    button {
      background:#2c5364;
      color:white;
      border:none;
      cursor:pointer;
      font-weight:bold;
    }

    button:hover {
      background:#203a43;
    }

    .hidden { display:none; }

    @media(max-width:600px){
      .card{padding:15px;}
    }
  </style>
</head>
<body>

<div class="card">
  <h2>E-KAROMAH SMKNB</h2>

  <!-- STEP 1 -->
  <label>Pilih Kelompok</label>
  <select id="kelompok" onchange="loadNama()">
    <option value="">-- Pilih Kelompok --</option>
  </select>

  <!-- STEP 2 -->
  <label>Pilih Nama</label>
  <select id="nama" onchange="tampilPembimbing()" disabled>
    <option value="">-- Pilih Nama --</option>
  </select>

  <!-- PEMBIMBING -->
  <label>Pembimbing</label>
  <input type="text" id="pembimbing" readonly>

  <!-- FORM -->
  <div id="formInput" class="hidden">

    <label>Sahur Waktu</label>
    <input type="time" id="sahur_waktu">

    <label>Sahur Keterangan</label>
    <textarea id="sahur_keterangan"></textarea>

    <label>Subuh Status</label>
    <select id="subuh_status">
      <option>Ya</option>
      <option>Tidak</option>
    </select>

    <label>Subuh Keterangan</label>
    <textarea id="subuh_keterangan"></textarea>

    <label>Dzuhur Status</label>
    <select id="dzuhur_status">
      <option>Ya</option>
      <option>Tidak</option>
    </select>

    <label>Dzuhur Keterangan</label>
    <textarea id="dzuhur_keterangan"></textarea>

    <button onclick="kirim()">Simpan</button>

  </div>

</div>

<script>

function loadKelompok(){
  google.script.run.withSuccessHandler(function(data){
    let select = document.getElementById("kelompok");
    data.forEach(k=>{
      let opt = document.createElement("option");
      opt.value=k;
      opt.text=k;
      select.appendChild(opt);
    });
  }).getKelompok();
}

function loadNama(){
  let kelompok = document.getElementById("kelompok").value;
  let namaSelect = document.getElementById("nama");
  namaSelect.innerHTML='<option value="">-- Pilih Nama --</option>';
  namaSelect.disabled=true;

  if(!kelompok) return;

  google.script.run.withSuccessHandler(function(data){
    data.forEach(n=>{
      let opt=document.createElement("option");
      opt.value=n;
      opt.text=n;
      namaSelect.appendChild(opt);
    });
    namaSelect.disabled=false;
  }).getNamaByKelompok(kelompok);
}

function tampilPembimbing(){
  let kelompok=document.getElementById("kelompok").value;
  let nama=document.getElementById("nama").value;

  if(!nama) return;

  google.script.run.withSuccessHandler(function(p){
    document.getElementById("pembimbing").value=p;
    document.getElementById("formInput").classList.remove("hidden");
  }).getPembimbingByKelompok(kelompok);
}

function kirim(){
  navigator.geolocation.getCurrentPosition(function(pos){

    let data={
      nama:document.getElementById("nama").value,
      kelompok:document.getElementById("kelompok").value,
      pembimbing:document.getElementById("pembimbing").value,
      lat:pos.coords.latitude,
      long:pos.coords.longitude,
      sahur_waktu:document.getElementById("sahur_waktu").value,
      sahur_keterangan:document.getElementById("sahur_keterangan").value,
      subuh_status:document.getElementById("subuh_status").value,
      subuh_keterangan:document.getElementById("subuh_keterangan").value,
      dzuhur_status:document.getElementById("dzuhur_status").value,
      dzuhur_keterangan:document.getElementById("dzuhur_keterangan").value
    };

    google.script.run.withSuccessHandler(function(res){
      alert(res);
      location.reload();
    }).simpanData(data);

  });
}

loadKelompok();

</script>

</body>
</html>
