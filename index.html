// ==========================
// KONFIGURASI
// ==========================
const SPREADSHEET_ID = "1srT53Fp8fW89ViyP61BydjiCPqUNRvKDee8IEnR2Ezo";
const FOLDER_ID = "1hrAAIpRz_-y4-qTDvzRKNC_ic3RWhw8q";

const SHEET_KELOMPOK = "KELOMPOK";
const SHEET_USERS = "USERS";
const SHEET_LAPORAN = "LAPORAN";

// ==========================
function doGet() {
  return HtmlService.createHtmlOutputFromFile("index")
    .setTitle("E-KAROMAH SMKNB")
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ==========================
// DROPDOWN
// ==========================
function getKelompok() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_KELOMPOK);
  return sheet.getRange("A2:A" + sheet.getLastRow())
    .getValues().flat().filter(String);
}

function getNamaByKelompok(kelompok) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_USERS);
  const data = sheet.getDataRange().getValues();
  let result = [];
  for (let i = 1; i < data.length; i++) {
    if (data[i][2] == kelompok) result.push(data[i][0]);
  }
  return result;
}

function getPembimbingByKelompok(kelompok) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_KELOMPOK);
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == kelompok) return data[i][1];
  }
  return "";
}

// ==========================
// UPLOAD FILE
// ==========================
function uploadFile(base64Data, fileName) {
  const folder = DriveApp.getFolderById(FOLDER_ID);
  const contentType = base64Data.match(/^data:(.*);base64,/)[1];
  const bytes = Utilities.base64Decode(base64Data.split(',')[1]);
  const blob = Utilities.newBlob(bytes, contentType, fileName);
  const file = folder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  return file.getUrl();
}

// ==========================
// SIMPAN DATA (WAJIB FOTO)
// ==========================
function simpanData(form) {

  // VALIDASI WAJIB FOTO
  const wajibFoto = [
    form.sahur_foto,
    form.olahraga_foto,
    form.aktivitas_foto,
    form.pesantren_foto,
    form.aksi_foto,
    form.buka_foto,
    form.tadarus_foto
  ];

  if (wajibFoto.some(f => !f)) {
    return "❌ Semua kegiatan wajib upload foto (kecuali sholat & sedekah)";
  }

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEET_LAPORAN);

  // Upload semua foto
  const sahurUrl = uploadFile(form.sahur_foto, "Sahur_"+Date.now()+".jpg");
  const olahragaUrl = uploadFile(form.olahraga_foto, "Olahraga_"+Date.now()+".jpg");
  const aktivitasUrl = uploadFile(form.aktivitas_foto, "Aktivitas_"+Date.now()+".jpg");
  const pesantrenUrl = uploadFile(form.pesantren_foto, "Pesantren_"+Date.now()+".jpg");
  const aksiUrl = uploadFile(form.aksi_foto, "Aksi_"+Date.now()+".jpg");
  const bukaUrl = uploadFile(form.buka_foto, "Buka_"+Date.now()+".jpg");
  const tadarusUrl = uploadFile(form.tadarus_foto, "Tadarus_"+Date.now()+".jpg");

  sheet.appendRow([
    new Date(),
    "",
    form.nama,
    form.kelompok,
    form.pembimbing,
    form.lat,
    form.long,
    form.sahur_waktu,
    sahurUrl,
    form.sahur_keterangan,
    form.subuh_status,
    form.subuh_keterangan,
    olahragaUrl,
    form.olahraga_keterangan,
    aktivitasUrl,
    form.aktivitas_keterangan,
    form.dzuhur_status,
    form.dzuhur_keterangan,
    pesantrenUrl,
    form.pesantren_keterangan,
    form.ashar_status,
    form.ashar_keterangan,
    aksiUrl,
    form.aksi_keterangan,
    bukaUrl,
    form.buka_keterangan,
    form.magrib_status,
    form.magrib_keterangan,
    form.isya_status,
    form.isya_keterangan,
    form.taraweh_status,
    form.taraweh_keterangan,
    tadarusUrl,
    form.tadarus_keterangan,
    form.tidur_waktu,
    form.tidur_keterangan,
    form.sedekah_status,
    form.sedekah_keterangan,
    0
  ]);

  return "✅ Data berhasil disimpan lengkap!";
}
