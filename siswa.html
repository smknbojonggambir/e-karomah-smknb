<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>E-KAROMAH SMKNB - Siswa</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  min-height:100vh;
  padding:20px;
}

.container{
  max-width:900px;
  margin:auto;
}

.card{
  background:rgba(255,255,255,.08);
  padding:25px;
  border-radius:18px;
}

.section{
  background:rgba(255,255,255,.05);
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

input,textarea,button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  margin:8px 0;
}

button{
  background:#2563eb;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.hidden{display:none}

.radio-group{
  display:flex;
  gap:20px;
}
</style>
</head>

<body>

<div class="container">

<h2>E-KAROMAH SMKNB</h2>

<div class="card">

<p id="info"></p>

<p>
<b>Pembimbing</b><br>
<input type="text" id="pembimbing" readonly>
</p>

<input type="hidden" id="lat">
<input type="hidden" id="long">

<div id="dynamicForm"></div>

<button id="btnKirim">KIRIM LAPORAN</button>

<p id="loader" class="hidden">⏳ Mengirim...</p>

<button onclick="logout()">Logout</button>

</div>
</div>


<script>

/* ================= CONFIG ================= */

const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbzVdZoXoZLUREfuu1k1i5BNhySWcDqrKs-VnF0oMZpCLT8NAGETKHBgrPGtK-oOC8M8Ew/exec";


/* ================= LOGIN CHECK ================= */

const user = JSON.parse(localStorage.getItem("user"));

if(!user || user.role!=="siswa"){
  location.href="index.html";
}

const nama     = user.nama;
const kelompok = user.kelompok;


/* ================= ELEMENT ================= */

const info        = document.getElementById("info");
const pembimbing  = document.getElementById("pembimbing");
const lat         = document.getElementById("lat");
const longi       = document.getElementById("long");
const dynamicForm = document.getElementById("dynamicForm");
const loader      = document.getElementById("loader");
const btnKirim    = document.getElementById("btnKirim");


/* ================= INFO ================= */

info.innerHTML = `
<b>Nama:</b> ${nama}<br>
<b>Kelompok:</b> ${kelompok}
`;


/* ================= GPS ================= */

function getLocation(){

  if(!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(pos=>{

    lat.value   = pos.coords.latitude;
    longi.value = pos.coords.longitude;

  });

}


/* ================= FORM ================= */

function toggle(id,show){
  document.getElementById(id).classList.toggle("hidden",!show);
}


function radioSection(title,id,withFoto=false,withTime=false){

return `
<div class="section">

<h4>${title}</h4>

<div class="radio-group">

<label>
<input type="radio" name="${id}" value="Ya"
onclick="toggle('${id}_d',true)"> Ya
</label>

<label>
<input type="radio" name="${id}" value="Tidak"
onclick="toggle('${id}_d',false)"> Tidak
</label>

</div>

<div id="${id}_d" class="hidden">

${withTime?`<input type="time" id="${id}_waktu">`:""}

${withFoto?`<input type="file" id="${id}_foto" accept="image/*">`:""}

<textarea id="${id}_ket" placeholder="Keterangan..."></textarea>

</div>
</div>
`;
}


/* ================= GENERATE ================= */

function generateForm(){

dynamicForm.innerHTML =

  radioSection("Sahur","sahur",true,true)+
  radioSection("Subuh","subuh")+
  radioSection("Olahraga","olahraga",true)+
  radioSection("Keluarga","keluarga",true)+
  radioSection("Dzuhur","dzuhur")+
  radioSection("Pesantren","pesantren",true)+
  radioSection("Ashar","ashar")+
  radioSection("Aksi","aksi",true)+
  radioSection("Buka","buka",true)+
  radioSection("Magrib","magrib")+
  radioSection("Isya","isya")+
  radioSection("Tarawih","tarawih")+
  radioSection("Tadarus","tadarus",true)+
  radioSection("Tidur","tidur",false,true);

}


/* ================= PEMBIMBING ================= */

async function loadPembimbing(){

  const r = await fetch(
    WEB_APP_URL+
    "?action=getPembimbing&kelompok="+
    encodeURIComponent(kelompok)
  );

  pembimbing.value = await r.text();

}


/* ================= SUBMIT ================= */

btnKirim.onclick = kirim;

async function kirim(){

  loader.classList.remove("hidden");
  btnKirim.disabled = true;

  let fd = new FormData();

  fd.append("action","simpan");

  fd.append("nama",nama);
  fd.append("kelompok",kelompok);
  fd.append("pembimbing",pembimbing.value);

  fd.append("lat",lat.value);
  fd.append("long",longi.value);


  const list=[
    "sahur","subuh","olahraga","keluarga","dzuhur",
    "pesantren","ashar","aksi","buka","magrib",
    "isya","tarawih","tadarus","tidur"
  ];


  for(let id of list){

    let st=document.querySelector(`input[name="${id}"]:checked`);

    fd.append(id+"_status",st?st.value:"Tidak");

    let w=document.getElementById(id+"_waktu");
    if(w) fd.append(id+"_waktu",w.value||"");

    let k=document.getElementById(id+"_ket");
    if(k) fd.append(id+"_ket",k.value||"");

    let f=document.getElementById(id+"_foto");

    if(f && f.files[0]){

      let reader=new FileReader();

      await new Promise(r=>{

        reader.onload=()=>{

          fd.append(id+"_foto",reader.result);
          r();

        };

        reader.readAsDataURL(f.files[0]);

      });

    }

  }


  await fetch(WEB_APP_URL,{
    method:"POST",
    body:fd
  });


  alert("✅ Laporan berhasil dikirim");

  location.reload();

}


/* ================= LOGOUT ================= */

function logout(){

  localStorage.clear();
  location.href="index.html";

}


/* ================= INIT ================= */

generateForm();
loadPembimbing();
getLocation();

</script>

</body>
</html>
