<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Panel Siswa - E-KAROMAH</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root{
--primary:#10b981;
--primary-dark:#047857;
--gold:#fbbf24;
--bg-dark:#022c22;
--glass:rgba(6,78,59,0.6);
--text:#f0fdf4;
--danger:#ef4444;
}

body{
margin:0;
font-family:'Poppins',sans-serif;
background:linear-gradient(135deg,#064e3b 0%,#020617 100%);
color:var(--text);
padding-bottom:120px;
-webkit-tap-highlight-color:transparent;
}

/* HEADER */
.header-container{
background:rgba(2,44,34,0.95);
backdrop-filter:blur(10px);
position:sticky;top:0;z-index:100;
padding:15px 20px;
border-bottom:1px solid rgba(251,191,36,0.3);
display:flex;justify-content:space-between;align-items:center;
}

.header-container h2{
margin:0;font-size:16px;color:var(--gold);
}

.btn-logout{
background:rgba(239,68,68,0.2);
border:1px solid var(--danger);
color:var(--danger);
padding:5px 12px;
border-radius:20px;
font-size:11px;
font-weight:600;
cursor:pointer;
}

.container{max-width:600px;margin:auto;padding:20px}

/* USER CARD */
.user-card{
background:linear-gradient(to right,#059669,#047857);
padding:20px;border-radius:16px;margin-bottom:25px;
font-size:13px;box-shadow:0 10px 30px rgba(0,0,0,0.3);
}

.user-label{color:#a7f3d0;font-size:11px}
.user-val{color:white;font-size:16px;font-weight:600}

.loc-badge{
display:inline-flex;align-items:center;gap:5px;
background:rgba(0,0,0,0.2);
padding:4px 10px;border-radius:20px;
font-size:11px;color:var(--gold);
}

/* ACTIVITY */
.activity-card{
background:rgba(30,41,59,0.6);
border:1px solid rgba(255,255,255,0.05);
border-radius:12px;margin-bottom:12px;
overflow:hidden;
}

.activity-header{
padding:16px;
cursor:pointer;
display:flex;justify-content:space-between;
}

.activity-body{
display:none;padding:0 16px 20px;
}

.activity-body.open{display:block}

input[type="time"],input[type="text"],input[type="file"]{
width:100%;padding:12px;
background:#0f172a;
border:1px solid #334155;
border-radius:10px;
color:white;
box-sizing:border-box;
margin-top:5px;
}

.chk-hidden{display:none}

.chk-label{
display:flex;justify-content:center;
background:#334155;
padding:10px;border-radius:10px;
cursor:pointer;margin-top:10px;
}

/* CHAT */
.chat-box{
background:rgba(15,23,42,0.8);
border:1px solid rgba(255,255,255,0.05);
border-radius:12px;
padding:12px;
height:220px;
overflow-y:auto;
font-size:12px;
margin-bottom:10px;
}

.chat-input-wrap{
display:flex;gap:8px;margin-bottom:20px;
}

.chat-input-wrap input{
flex:1;
}

.chat-btn{
background:var(--primary);
border:none;padding:10px 14px;
border-radius:10px;color:white;font-weight:600;
cursor:pointer;
}

/* SUBMIT */
.fab-container{
position:fixed;bottom:0;left:0;right:0;
padding:15px 20px 25px;
background:linear-gradient(to top,#020617 80%,transparent);
max-width:600px;margin:auto;
}

.submit-btn{
width:100%;padding:16px;
background:var(--gold);color:#022c22;
border:none;border-radius:14px;
font-weight:700;font-size:16px;
cursor:pointer;
}
</style>
</head>
<body>

<div class="header-container">
<h2>ðŸŒ™ E-KAROMAH</h2>
<button class="btn-logout" onclick="logout()">Keluar</button>
</div>

<div class="container">

<div class="user-card">
<span class="user-label">Nama</span>
<span class="user-val" id="namaSiswa"></span>
<span class="user-label">Kelompok</span>
<div id="kelompokSiswa"></div>
</div>

<form id="formLaporan" onsubmit="return false;">
<input type="hidden" id="inputNama">
<input type="hidden" id="inputKelompok">
<input type="hidden" id="inputLatLong">

<h3 style="color:var(--gold)">ðŸ“‹ Kegiatan Harian</h3>
<div id="activitiesContainer"></div>

<div style="margin-top:20px">
<input type="text" id="inputCatatan" placeholder="Catatan tambahan...">
</div>

<!-- ================= CHAT KELOMPOK ================= -->
<h3 style="color:var(--gold);margin-top:30px">ðŸ’¬ Chat Kelompok</h3>

<div id="chatBox" class="chat-box"></div>

<div class="chat-input-wrap">
<input type="text" id="chatInput" placeholder="Tulis pesan...">
<button type="button" class="chat-btn" onclick="kirimChat()">Kirim</button>
</div>

<div class="fab-container">
<button type="button" class="submit-btn" onclick="kirimLaporan()">
ðŸš€ KIRIM LAPORAN
</button>
</div>

</form>
</div>

<script>
const WEB_APP_URL="https://script.google.com/macros/s/AKfycbwNiMVctO_IjVpVxMaAJKPKi2oOebGBDwOlFVJnQJ1pCoxNiOwGscPMwFrCfLhJmyxBkQ/exec";

const activities=[
{id:"Subuh",label:"ðŸ•Œ Sholat Subuh"},
{id:"Dzuhur",label:"ðŸ•Œ Sholat Dzuhur"},
{id:"Ashar",label:"ðŸ•Œ Sholat Ashar"},
{id:"Magrib",label:"ðŸ•Œ Sholat Magrib"},
{id:"Isya",label:"ðŸ•Œ Sholat Isya"},
{id:"Tarawih",label:"ðŸ“¿ Sholat Tarawih"},
{id:"Tadarus",label:"ðŸ“– Tadarus"}
];

const user=JSON.parse(localStorage.getItem("user"));
if(!user||user.role!=="siswa"){location.href="index.html"}

document.getElementById("namaSiswa").textContent=user.nama;
document.getElementById("kelompokSiswa").textContent=user.kelompok;
document.getElementById("inputNama").value=user.nama;
document.getElementById("inputKelompok").value=user.kelompok;

/* RENDER KEGIATAN */
const container=document.getElementById("activitiesContainer");
activities.forEach(act=>{
container.innerHTML+=`
<div class="activity-card">
<div class="activity-header" onclick="this.nextElementSibling.classList.toggle('open')">
${act.label}
</div>
<div class="activity-body">
<label><input type="checkbox" id="chk_${act.id}"> Dilaksanakan</label>
<input type="time" id="time_${act.id}">
<input type="text" id="ket_${act.id}" placeholder="Keterangan">
</div>
</div>`;
});

/* SUBMIT */
async function kirimLaporan(){
let payload={
action:"simpan",
nama:user.nama,
kelompok:user.kelompok,
Catatan:document.getElementById("inputCatatan").value
};

activities.forEach(act=>{
const chk=document.getElementById("chk_"+act.id);
if(chk.checked){
payload[act.id+"_Status"]="Ya";
payload[act.id+"_Waktu"]=document.getElementById("time_"+act.id).value;
payload[act.id+"_Ket"]=document.getElementById("ket_"+act.id).value;
}else{
payload[act.id+"_Status"]="Tidak";
}
});

await fetch(WEB_APP_URL,{
method:"POST",
body:JSON.stringify(payload)
});

alert("Laporan terkirim");
location.reload();
}

/* ================= CHAT ================= */

function loadChat(){
fetch(WEB_APP_URL+"?action=getChat")
.then(res=>res.json())
.then(data=>{
const box=document.getElementById("chatBox");
box.innerHTML="";
data.filter(c=>c.kelompok===user.kelompok)
.forEach(c=>{
const isMe=c.nama===user.nama;
box.innerHTML+=`
<div style="text-align:${isMe?'right':'left'};margin-bottom:6px">
<span style="
display:inline-block;
background:${isMe?'var(--primary)':'#334155'};
padding:6px 10px;
border-radius:10px;
max-width:70%">
${c.pesan}
</span>
</div>`;
});
box.scrollTop=box.scrollHeight;
});
}

function kirimChat(){
const pesan=document.getElementById("chatInput").value.trim();
if(!pesan)return;

fetch(WEB_APP_URL,{
method:"POST",
body:JSON.stringify({
action:"sendChat",
nama:user.nama,
kelompok:user.kelompok,
pesan:pesan
})
}).then(()=>{
document.getElementById("chatInput").value="";
loadChat();
});
}

setInterval(loadChat,5000);
loadChat();

function logout(){
localStorage.removeItem("user");
location.href="index.html";
}
</script>
</body>
</html>
