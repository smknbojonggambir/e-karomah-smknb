<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>E-KAROMAH SMKNB - Siswa</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:white;
  min-height:100vh;
  padding:20px;
}

.container{
  max-width:900px;
  margin:auto;
}

.card{
  background:rgba(255,255,255,.08);
  padding:25px;
  border-radius:18px;
}

.section{
  background:rgba(255,255,255,.05);
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
}

input,textarea,button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  margin:8px 0;
}

button{
  background:#2563eb;
  color:white;
  font-weight:600;
  cursor:pointer;
}

.hidden{display:none}

.radio-group{
  display:flex;
  gap:20px;
}
</style>
</head>

<body>

<div class="container">

<h2>E-KAROMAH SMKNB</h2>

<div class="card">

<p id="info"></p>

<p>
<b>Pembimbing</b><br>
<input type="text" id="pembimbing" readonly>
</p>

<input type="hidden" id="lat">
<input type="hidden" id="long">

<div id="dynamicForm"></div>

<button id="btnKirim">KIRIM LAPORAN</button>

<p id="loader" class="hidden">⏳ Mengirim...</p>

<button onclick="logout()">Logout</button>

</div>
</div>


<script>

/* ================= CONFIG ================= */

const WEB_APP_URL =
"https://script.google.com/macros/s/AKfycbzG_JwpZBfC5-e_wMGf5mhufKbxJIpXE97LdGFknRkFBNAhgI6tF_d1zM1v4gyGmVmOfA/exec";


/* ================= ELEMENT ================= */

const info        = document.getElementById("info");
const pembimbing  = document.getElementById("pembimbing");
const lat         = document.getElementById("lat");
const longi       = document.getElementById("long");
const dynamicForm = document.getElementById("dynamicForm");
const loader      = document.getElementById("loader");
const btnKirim    = document.getElementById("btnKirim");


/* ================= CEK LOGIN ================= */

let user = JSON.parse(localStorage.getItem("user"));

if(!user || user.role !== "siswa"){
  location.href="index.html";
}

const nama     = user.nama;
const kelompok = user.kelompok;


/* ================= INFO ================= */

info.innerHTML = `
<b>Nama:</b> ${nama}<br>
<b>Kelompok:</b> ${kelompok}
`;


/* ================= GPS ================= */

function getLocation(){

  if(!navigator.geolocation) return;

  navigator.geolocation.getCurrentPosition(pos=>{

    lat.value   = pos.coords.latitude;
    longi.value = pos.coords.longitude;

  });

}


/* ================= FORM ================= */

function toggle(id,show){
  document.getElementById(id).classList.toggle("hidden",!show);
}


function radioSection(title,id,withFoto=false,withTime=false){

return `
<div class="section">

<h4>${title}</h4>

<div class="radio-group">

<label>
<input type="radio" name="${id}" value="Ya"
onclick="toggle('${id}_d',true)"> Ya
</label>

<label>
<input type="radio" name="${id}" value="Tidak"
onclick="toggle('${id}_d',false)"> Tidak
</label>

</div>

<div id="${id}_d" class="hidden">

${withTime?`<input type="time" id="${id}_waktu">`:""}

<textarea id="${id}_ket" placeholder="Keterangan..."></textarea>

</div>
</div>
`;
}


/* ================= GENERATE FORM ================= */

function generateForm(){

dynamicForm.innerHTML =

  radioSection("Sahur","sahur",true,true)+
  radioSection("Subuh","subuh")+
  radioSection("Olahraga","olahraga")+
  radioSection("Keluarga","keluarga")+
  radioSection("Dzuhur","dzuhur")+
  radioSection("Pesantren","pesantren")+
  radioSection("Ashar","ashar")+
  radioSection("Aksi","aksi")+
  radioSection("Buka","buka")+
  radioSection("Magrib","magrib")+
  radioSection("Isya","isya")+
  radioSection("Tarawih","tarawih")+
  radioSection("Tadarus","tadarus")+
  radioSection("Tidur","tidur",false,true);

}


/* ================= PEMBIMBING ================= */

async function loadPembimbing(){

  try{

    const r = await fetch(
      WEB_APP_URL+
      "?action=getPembimbing&kelompok="+
      encodeURIComponent(kelompok)
    );

    pembimbing.value = await r.text();

  }catch{

    pembimbing.value="-";

  }

}


/* ================= VALIDASI ================= */

function validasi(){

  const list=[
    "sahur","subuh","olahraga","keluarga","dzuhur",
    "pesantren","ashar","aksi","buka","magrib",
    "isya","tarawih","tadarus","tidur"
  ];

  for(let id of list){

    if(!document.querySelector(`input[name="${id}"]:checked`)){

      alert("⚠️ Semua kegiatan wajib diisi!");
      return false;

    }

  }

  return true;

}


/* ================= SUBMIT ================= */

btnKirim.onclick = kirim;

async function kirim(){

  if(!validasi()) return;

  loader.classList.remove("hidden");
  btnKirim.disabled = true;

  let fd = new FormData();

  fd.append("action","simpan");

  fd.append("nama",nama);
  fd.append("kelompok",kelompok);
  fd.append("pembimbing",pembimbing.value);

  fd.append("lat",lat.value);
  fd.append("long",longi.value);


  const list=[
    "sahur","subuh","olahraga","keluarga","dzuhur",
    "pesantren","ashar","aksi","buka","magrib",
    "isya","tarawih","tadarus","tidur"
  ];


  for(let id of list){

    let st=document.querySelector(`input[name="${id}"]:checked`);

    fd.append(id+"_status",st.value);

    let w=document.getElementById(id+"_waktu");
    if(w) fd.append(id+"_waktu",w.value||"");

    let k=document.getElementById(id+"_ket");
    if(k) fd.append(id+"_ket",k.value||"");

  }


  try{

    await fetch(WEB_APP_URL,{
      method:"POST",
      body:fd
    });

    alert("✅ Laporan berhasil dikirim");

    location.reload();

  }catch(e){

    alert("❌ Gagal mengirim data");

  }

  loader.classList.add("hidden");
  btnKirim.disabled = false;

}


/* ================= LOGOUT ================= */

function logout(){

  localStorage.clear();
  location.href="index.html";

}


/* ================= INIT ================= */

generateForm();
loadPembimbing();
getLocation();

</script>

</body>
</html>
